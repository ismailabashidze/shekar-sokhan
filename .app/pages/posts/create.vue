<script setup lang="ts">
// --- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªÙ†ÙˆØ¹ Ùˆ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø± ---
const markdownGuide = `# Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ù†Ú¯Ø§Ø±Ø´ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ†

## Ø³Ø§Ø®ØªØ§Ø± Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø¬Ø¨Ø§Ø±ÛŒ)
# Ø¹Ù†ÙˆØ§Ù† Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡ (H1) - ÙÙ‚Ø· ÛŒÚ©ÛŒ
## Ø³Ø±ÙØµÙ„ Ø§ØµÙ„ÛŒ (H2) - Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
### Ø²ÛŒØ±Ø¹Ù†ÙˆØ§Ù† (H3) - Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ±Ø¨Ø®Ø´â€ŒÙ‡Ø§  
#### Ø¬Ø²Ø¦ÛŒØ§Øª (H4) - Ø¨Ø±Ø§ÛŒ Ù†Ú©Ø§Øª Ø®Ø§Øµ
##### Ù†Ú©ØªÙ‡ ÙØ±Ø¹ÛŒ (H5)
###### Ø¬Ø²Ø¦ÛŒØ§Øª Ú©ÙˆÚ†Ú© (H6)

## Ø§Ù†ÙˆØ§Ø¹ ØªØ£Ú©ÛŒØ¯Ø§Øª Ù…ØªÙ†ÛŒ (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯)
- **Ù…ØªÙ† Ù¾Ø±Ø±Ù†Ú¯ Ùˆ Ù…Ù‡Ù…** Ø¨Ø§ **Ù…ØªÙ†**
- *Ù…ØªÙ† Ù…ÙˆØ±Ø¨ Ø¨Ø±Ø§ÛŒ ØªØ£Ú©ÛŒØ¯* Ø¨Ø§ *Ù…ØªÙ†*
- ***Ù…ØªÙ† Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù…*** Ø¨Ø§ ***Ù…ØªÙ†***
- ~~Ù…ØªÙ† Ø§Ø´ØªØ¨Ø§Ù‡ ÛŒØ§ Ù…Ù†Ø³ÙˆØ®~~ Ø¨Ø§ ~~Ù…ØªÙ†~~
- \`Ú©Ø¯ ÛŒØ§ Ø§ØµØ·Ù„Ø§Ø­ Ø®Ø§Øµ\` Ø¨Ø§ \`Ú©Ø¯\`
- ==Ù…ØªÙ† Ø¨Ø±Ø¬Ø³ØªÙ‡== Ø¨Ø§ ==Ù…ØªÙ†==

## Ø§Ù†ÙˆØ§Ø¹ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ (Ø­ØªÙ…Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯)
### Ù„ÛŒØ³Øª Ù†Ø§Ù…Ø±ØªØ¨ Ø¨Ø±Ø§ÛŒ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ
- Ù†Ú©ØªÙ‡ Ø§ÙˆÙ„
  - Ø¬Ø²Ø¦ÛŒØ§Øª Ù†Ú©ØªÙ‡ Ø§ÙˆÙ„
    - Ø²ÛŒØ±Ø¬Ø²Ø¦ÛŒØ§Øª
  - Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯ÛŒÚ¯Ø±
- Ù†Ú©ØªÙ‡ Ø¯ÙˆÙ…
* Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² * Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
+ ÛŒØ§ Ø§Ø² + Ø¨Ø±Ø§ÛŒ ØªÙ†ÙˆØ¹

### Ù„ÛŒØ³Øª Ù…Ø±ØªØ¨ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ùˆ Ú¯Ø§Ù…â€ŒÙ‡Ø§
1. Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„
2. Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…
   1. Ø²ÛŒØ±Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„
   2. Ø²ÛŒØ±Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…
3. Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ…

### Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø¹Ù…Ù„ÛŒ (Ø¨Ø³ÛŒØ§Ø± Ù…ÙÛŒØ¯)
- [ ] Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡
- [x] Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
- [ ] ØªÙ…Ø±ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Û±
- [ ] ØªÙ…Ø±ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ Û²

## Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯)
> Ø§ÛŒÙ† ÛŒÚ© Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª

> Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ú†Ù†Ø¯Ø®Ø·ÛŒ
> Ú©Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯
> Ùˆ Ø¨ÛŒØ´ØªØ± ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø± Ø§Ø³Øª

>> Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ ØªÙˆ Ø¯Ø± ØªÙˆ
>> Ø¨Ø±Ø§ÛŒ ØªØ£Ú©ÛŒØ¯ Ø¨ÛŒØ´ØªØ±

> **Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ù¾Ø±Ø±Ù†Ú¯**
> *Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ù„Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ*

## Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ (Ø­ØªÙ…Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯)
### Ø¬Ø¯ÙˆÙ„ Ø³Ø§Ø¯Ù‡
| Ù…ÙˆØ¶ÙˆØ¹ | ØªÙˆØ¶ÛŒØ­ | Ù…Ø«Ø§Ù„ |
|--------|-------|-------|
| Ù…ÙÙ‡ÙˆÙ… Ø§ÙˆÙ„ | ØªÙˆØ¶ÛŒØ­ Ø§ÙˆÙ„ | Ù†Ù…ÙˆÙ†Ù‡ Ø§ÙˆÙ„ |
| Ù…ÙÙ‡ÙˆÙ… Ø¯ÙˆÙ… | ØªÙˆØ¶ÛŒØ­ Ø¯ÙˆÙ… | Ù†Ù…ÙˆÙ†Ù‡ Ø¯ÙˆÙ… |

### Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ ØªØ±Ø§Ø² Ù…ØªÙ†
| Ø±Ø§Ø³Øª | ÙˆØ³Ø· | Ú†Ù¾ |
|------:|:----:|:----|
| Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ† | ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† | Ú†Ù¾â€ŒÚ†ÛŒÙ† |
| Û±Û²Û³ | Û´ÛµÛ¶ | Û·Û¸Û¹ |

## Ú©Ø¯Ù‡Ø§ Ùˆ Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§
### Ú©Ø¯ ØªÚ© Ø®Ø·ÛŒ
Ø¨Ø±Ø§ÛŒ \`Ù…ØªØºÛŒØ± Ø®Ø§Øµ\` ÛŒØ§ \`Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡\` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.

### Ú©Ø¯ Ú†Ù†Ø¯Ø®Ø·ÛŒ
\`\`\`
Ø§ÛŒÙ† ÛŒÚ© Ù…Ø«Ø§Ù„ Ú©Ø¯ Ø§Ø³Øª
Ú©Ù‡ Ú†Ù†Ø¯ÛŒÙ† Ø®Ø· Ø¯Ø§Ø±Ø¯
Ùˆ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø³Øª
\`\`\`

## Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§ Ùˆ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª
- [Ù„ÛŒÙ†Ú© Ø³Ø§Ø¯Ù‡](https://example.com)
- [Ù„ÛŒÙ†Ú© Ø¨Ø§ ØªÙˆØ¶ÛŒØ­](https://example.com "ØªÙˆØ¶ÛŒØ­ Ø¶Ø±ÙˆØ±ÛŒ")
- [Ù„ÛŒÙ†Ú© Ø¯Ø§Ø®Ù„ÛŒ](#Ø¨Ø®Ø´-Ù…Ø±Ø¨ÙˆØ·Ù‡)
- <https://example.com> Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ø³ØªÙ‚ÛŒÙ…
- [Ù„ÛŒÙ†Ú© Ù…Ø±Ø¬Ø¹][1] Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹

[1]: https://example.com "ØªÙˆØ¶ÛŒØ­ Ù…Ø±Ø¬Ø¹"

## ØªØµØ§ÙˆÛŒØ± Ùˆ Ø±Ø³Ø§Ù†Ù‡
![ØªÙˆØ¶ÛŒØ­ Ù…Ù‡Ù… ØªØµÙˆÛŒØ±](https://picsum.photos/400/200 "Ø¹Ù†ÙˆØ§Ù† ØªØµÙˆÛŒØ±")

[![ØªØµÙˆÛŒØ± Ø¨Ø§ Ù„ÛŒÙ†Ú©](https://picsum.photos/200/100)](https://example.com)

## Ø®Ø·ÙˆØ· Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ)
---
***
___

## ØªØ±Ú©ÛŒØ¨Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡
### Ù„ÛŒØ³Øª Ø¨Ø§ Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„
1. Ù†Ú©ØªÙ‡ Ø§ÙˆÙ„
   > Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ù…Ø±Ø¨ÙˆØ·Ù‡
2. Ù†Ú©ØªÙ‡ Ø¯ÙˆÙ…
   > Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ø¯ÛŒÚ¯Ø±

### Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ù„ÛŒØ³Øª
| Ø¹Ù†ÙˆØ§Ù† | Ø¬Ø²Ø¦ÛŒØ§Øª |
|--------|---------|
| Ù…ÙˆØ±Ø¯ Ø§ÙˆÙ„ | - Ù†Ú©ØªÙ‡ Û±<br>- Ù†Ú©ØªÙ‡ Û² |
| Ù…ÙˆØ±Ø¯ Ø¯ÙˆÙ… | - Ù†Ú©ØªÙ‡ Û³<br>- Ù†Ú©ØªÙ‡ Û´ |

## Ù¾Ø§Ù†ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª
Ù…ØªÙ† Ø¨Ø§ Ù¾Ø§Ù†ÙˆÛŒØ³[^1] Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ø¯ÛŒÚ¯Ø±[^Ù…Ø±Ø¬Ø¹-Ù…Ù‡Ù…]

[^1]: ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ù…Ù„ Ø¯Ø± Ù¾Ø§Ù†ÙˆÛŒØ³
[^Ù…Ø±Ø¬Ø¹-Ù…Ù‡Ù…]: Ù…Ø±Ø¬Ø¹ Ù…Ù‡Ù… Ùˆ Ù…Ø¹ØªØ¨Ø±

## Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ù„Ø§Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ:
- Ø§Ø² Ø³Ø±ÙØµÙ„â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ù†Ø·Ù‚ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
- Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ Ø¨Ú¯Ù†Ø¬Ø§Ù†ÛŒØ¯  
- Ú†Ú©â€ŒÙ„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯
- Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒØ§ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯
- Ø§Ø² ØªØ£Ú©ÛŒØ¯Ø§Øª Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
- Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ø®Ø· Ø§ÙÙ‚ÛŒ Ø§Ø² Ù‡Ù… Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯
`

definePageMeta({
  title: 'Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯',
  preview: {
    title: 'Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯',
    description: 'ÛŒÚ© Ù…Ù‚Ø§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯',
    categories: ['dashboards'],
    src: '/img/screens/dashboards-jobs.png',
    srcDark: '/img/screens/dashboards-jobs-dark.png',
    order: 15,
  },
  layout: 'sidebar',
})

useHead({ htmlAttrs: { dir: 'rtl' } })

import PersianCalendar from '~/components/PersianCalendar.vue'
import AddonMarkdownRemark from '~/components/AddonMarkdownRemark.vue'

const router = useRouter()
const toaster = useToaster()
const { streamChat, processing } = useOpenRouter()
const { createPost, loading: postsLoading, error: postsError } = usePosts()
const { user } = useUser()

const title = ref('')
const description = ref('')
const uploadedFiles = ref<FileList | null>(null)
const category = ref('')
const tags = ref<string[]>([])
const newTag = ref('')
const readTime = ref('')
const publishDate = ref('')
const contentLong = ref('')
const excerpt = ref('')
const slug = ref('')
const allowComments = ref(true)
const isFeatured = ref(false)
const secretMessage = ref('')
const goals = ref('')

// Loading state for AI suggestion buttons
const titleAiLoading = ref(false)
const secretMessageAiLoading = ref(false)
const goalsAiLoading = ref(false)
const categoryAiLoading = ref(false)
const tagsAiLoading = ref(false)
const excerptAiLoading = ref(false)
const slugAiLoading = ref(false)
const contentLongAiLoading = ref(false)
const generateGoalsAiLoading = ref(false)
const syncAllFieldsLoading = ref(false)

// Ú©Ù†ØªØ±Ù„ Ø·ÙˆÙ„ Ù…ØªÙ†
const contentLengthTarget = ref(5000) // Ø·ÙˆÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÛµÛ°Û°Û° Ú©Ù„Ù…Ù‡
const minContentLength = 1000
const maxContentLength = 15000

// ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±
const imageGenerationLoading = ref(false)
const showImageModal = ref(false)
const selectedTextForImage = ref('')
const imageCaption = ref('')
const imagePrompt = ref('')

const errors = ref({})
const loading = ref(false)
const success = ref(false)

const categories = [
  { value: 'meditation', label: 'Ù…Ø¯ÛŒØªÛŒØ´Ù†', icon: 'ph:person-simple-duotone' },
  { value: 'yoga', label: 'ÛŒÙˆÚ¯Ø§', icon: 'ph:person-simple-walk-duotone' },
  { value: 'mental-health', label: 'Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†', icon: 'ph:heartbeat-duotone' },
  { value: 'self-help', label: 'Ø®ÙˆØ¯ÛŒØ§Ø±ÛŒ', icon: 'ph:hand-heart-duotone' },
  { value: 'motivation', label: 'Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ', icon: 'ph:star-duotone' },
  { value: 'relationship', label: 'Ø±ÙˆØ§Ø¨Ø·', icon: 'ph:users-duotone' },
  { value: 'parenting', label: 'ÙØ±Ø²Ù†Ø¯Ù¾Ø±ÙˆØ±ÛŒ', icon: 'ph:baby-duotone' },
  { value: 'counseling', label: 'Ù…Ø´Ø§ÙˆØ±Ù‡', icon: 'ph:chat-circle-dots-duotone' },
  { value: 'stress', label: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø³', icon: 'ph:activity-duotone' },
  { value: 'anxiety', label: 'Ø§Ø¶Ø·Ø±Ø§Ø¨', icon: 'ph:cloud-warning-duotone' },
  { value: 'depression', label: 'Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ', icon: 'ph:cloud-rain-duotone' },
  { value: 'happiness', label: 'Ø´Ø§Ø¯Ú©Ø§Ù…ÛŒ', icon: 'ph:smiley-duotone' },
  { value: 'addiction', label: 'Ø§Ø¹ØªÛŒØ§Ø¯', icon: 'ph:beer-bottle-duotone' },
  { value: 'trauma', label: 'ØªØ±ÙˆÙ…Ø§ Ùˆ Ø¢Ø³ÛŒØ¨', icon: 'ph:heartbeat-duotone' },
  {
    value: 'sexuality',
    label: 'Ù…Ø³Ø§Ø¦Ù„ Ø¬Ù†Ø³ÛŒ',
    icon: 'ph:gender-intersex-duotone',
  },
  { value: 'sleep', label: 'Ø®ÙˆØ§Ø¨ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª', icon: 'ph:bed-duotone' },
  {
    value: 'nutrition',
    label: 'ØªØºØ°ÛŒÙ‡ Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ',
    icon: 'ph:apple-logo-duotone',
  },
  { value: 'mindfulness', label: 'Ø°Ù‡Ù†â€ŒØ¢Ú¯Ø§Ù‡ÛŒ', icon: 'ph:eye-duotone' },
]
const availableTags = [
  'Ø®ÙˆØ¯Ø¢Ú¯Ø§Ù‡ÛŒ',
  'Ø±Ø´Ø¯ ÙØ±Ø¯ÛŒ',
  'Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†',
  'Ø§Ø³ØªØ±Ø³',
  'Ø¢Ø±Ø§Ù…Ø´',
  'Ù…Ø¯ÛŒØªÛŒØ´Ù†',
  'ÛŒÙˆÚ¯Ø§',
]

const previewImage = computed(() => {
  if (uploadedFiles.value && uploadedFiles.value.length) {
    const file = uploadedFiles.value[0]
    return URL.createObjectURL(file)
  }
  return ''
})

function formatFileSize(size: number) {
  if (size < 1024) return size + ' bytes'
  if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB'
  return (size / 1024 / 1024).toFixed(1) + ' MB'
}

function validate() {
  errors.value = {}
  if (!title.value.trim()) errors.value.title = 'Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø§Ù„Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'
  if (!description.value.trim())
    errors.value.description = 'ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ù‚Ø§Ù„Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'
  if (!category.value) errors.value.category = 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'
  if (!contentLong.value.trim())
    errors.value.content = 'Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù…Ù‚Ø§Ù„Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'
  if (!publishDate.value) errors.value.publishDate = 'ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'
  return Object.keys(errors.value).length === 0
}

function formatLongContent(html: string) {
  return (
    html
      // Convert divs with # to headings
      .replace(/<div>#+ ([^<]+)<\/div>/g, (_, title) => `# ${title}\n`)
      .replace(/<div>##+ ([^<]+)<\/div>/g, (_, title) => `## ${title}\n`)
      // Convert lists
      .replace(
        /<div>&nbsp; &nbsp;\* ([^<]+)<\/div>/g,
        (_, item) => `* ${item}\n`,
      )
      .replace(/<div>\d+\. ([^<]+)<\/div>/g, (_, item) => `1. ${item}\n`)
      // Convert regular divs to paragraphs
      .replace(/<div>([^<]+)<\/div>/g, (_, text) => `${text}\n`)
      // Clean up
      .replace(/<br>/g, '\n')
      .replace(/&zwnj;/g, '')
      .replace(/&nbsp;/g, ' ')
      .replace(/\n\s*\n/g, '\n\n')
      .trim()
  )
}

async function submit() {
  if (!validate()) return

  loading.value = true

  try {
    // ØªØ¨Ø¯ÛŒÙ„ tags Ø§Ø² Ø±Ø´ØªÙ‡ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ú¯Ø± Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø§Ø´Ø¯
    const tagsArray = Array.isArray(tags.value) ? tags.value : []

    // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯
    const postData = {
      title: title.value.trim(),
      description: description.value.trim(),
      secretMessage: secretMessage.value.trim() || undefined,
      goals: goals.value.trim() || undefined,
      excerpt: excerpt.value.trim() || undefined,
      contentLong: contentLong.value.trim(),
      category: category.value,
      tags: tagsArray,
      slug: slug.value.trim() || undefined,
      publishDate: publishDate.value || new Date().toISOString().split('T')[0],
      readTime: readTime.value ? parseInt(readTime.value) : undefined,
      featuredImage: uploadedFiles.value?.[0] || null,
      isFeatured: isFeatured.value || false,
      allowComments: allowComments.value !== false,
      status: 'draft' as const, // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±ÙˆÛŒ draft
      contentLengthTarget: contentLengthTarget.value || undefined,
      author: user.value?.id || '',
      viewCount: 0,
      likeCount: 0,
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø§Ù…Ù¾ÙˆØ²Ø¨Ù„
    const newPost = await createPost(postData)

    success.value = true

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
    toaster.show({
      title: 'Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²',
      message: 'Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯',
      color: 'success',
      icon: 'ph:check-circle',
      closable: true,
    })

    // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙØ­Ù‡ Ù„ÛŒØ³Øª Ù¾Ø³ Ø§Ø² ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡
    setTimeout(() => {
      router.push('/posts/list')
    }, 1000)
  }
  catch (error: any) {
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
    toaster.show({
      title: 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡',
      message: error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø±Ø® Ø¯Ø§Ø¯',
      color: 'danger',
      icon: 'ph:warning',
      closable: true,
    })

    console.error('Error creating post:', error)
  }
  finally {
    loading.value = false
  }
}

function addTag() {
  if (newTag.value && !tags.value.includes(newTag.value.trim())) {
    tags.value.push(newTag.value.trim())
    newTag.value = ''
  }
}

function removeTag(tag: string) {
  tags.value = tags.value.filter(t => t !== tag)
}

function removeAllTags() {
  tags.value = []
}

function savePreviewToLocalStorage() {
  const data = {
    title: title.value,
    description: description.value,
    contentLong: contentLong.value,
    excerpt: excerpt.value,
    slug: slug.value,
    category: category.value,
    tags: tags.value,
    publishDate: publishDate.value,
    readTime: readTime.value,
    isFeatured: isFeatured.value,
    allowComments: allowComments.value,
    secretMessage: secretMessage.value,
    goals: goals.value,
    contentLengthTarget: contentLengthTarget.value,
    // image: skip for now
  }
  localStorage.setItem('postPreview', JSON.stringify(data))
}

function goToPreview() {
  savePreviewToLocalStorage()
  router.push('/posts/preview')
}

const isPreviewDisabled = computed(() => {
  return (
    !title.value.trim()
    && !contentLong.value.trim()
    && !description.value.trim()
  )
})

// Optional: auto-save on change
import { watch } from 'vue'
watch(
  [
    title,
    description,
    contentLong,
    excerpt,
    slug,
    category,
    tags,
    publishDate,
    readTime,
    isFeatured,
    allowComments,
    secretMessage,
    goals,
    contentLengthTarget,
  ],
  savePreviewToLocalStorage,
)

// Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ
const syncSuggestionShown = ref(false)

watch([title, secretMessage, category], () => {
  // ÙÙ‚Ø· Ø§Ú¯Ø± Ø­Ø¯Ø§Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† Ùˆ ÛŒÚ©ÛŒ Ø§Ø² ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ù¾Ø± Ø¨Ø§Ø´Ø¯
  if (!syncSuggestionShown.value && title.value.trim()
    && (secretMessage.value.trim() || category.value)) {
    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡
    setTimeout(() => {
      if (!syncSuggestionShown.value) {
        toaster.show({
          title: 'ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´Ù…Ù†Ø¯',
          message: 'Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù†ÛŒ Ø¨Ù‡ØªØ± ÙÛŒÙ„Ø¯Ù‡Ø§ØŒ Ø§Ø² Ø¯Ú©Ù…Ù‡ "Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.',
          color: 'info',
          icon: 'ph:lightbulb',
          timeout: 5000,
          closable: true,
        })
        syncSuggestionShown.value = true
      }
    }, 2000) // ØªØ£Ø®ÛŒØ± Û² Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ
  }
}, { debounce: 1000 }) // debounce Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…Ú©Ø±Ø±

function backToPosts() {
  router.push('/posts/list')
}

async function suggestAIField(field: string) {
  switch (field) {
    case 'title':
      titleAiLoading.value = true
      break
    case 'secretMessage':
      secretMessageAiLoading.value = true
      break
    case 'goals':
      goalsAiLoading.value = true
      break
    case 'category':
      categoryAiLoading.value = true
      break
    case 'tags':
      tagsAiLoading.value = true
      break
    case 'excerpt':
      excerptAiLoading.value = true
      break
    case 'slug':
      slugAiLoading.value = true
      break
    case 'contentLong':
      contentLongAiLoading.value = true
      break
  }

  try {
    // For category field, we'll select from predefined categories
    if (field === 'category') {
      const prompt = `Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…ØªÙ† Ø²ÛŒØ±ØŒ Ù…Ù†Ø§Ø³Ø¨â€ŒØªØ±ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ø² Ø¨ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†. ÙÙ‚Ø· Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù† Ùˆ Ù‡ÛŒÚ† Ú†ÛŒØ² Ø¯ÛŒÚ¯Ø±ÛŒ Ù†Ù†ÙˆÛŒØ³.\n\nÙ…ØªÙ†: ${
        title.value || description.value || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'
      }\n\nØ¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯: ${categories.map(c => c.value).join('ØŒ ')}`
      const messages = [{ role: 'user', content: prompt }]

      let suggestion = ''
      categoryAiLoading.value = true

      try {
        await streamChat(messages, {}, (chunk) => {
          const content = chunk
          if (content) {
            suggestion += content
            // Find the best matching category from our predefined list
            const matchedCategory = categories.find(
              cat =>
                cat.value
                  .toLowerCase()
                  .includes(suggestion.trim().toLowerCase())
                  || suggestion
                    .trim()
                    .toLowerCase()
                    .includes(cat.value.toLowerCase()),
            )
            if (matchedCategory) {
              category.value = matchedCategory.value
            }
            console.log(category.value)
          }
        })

        // Show success toast
        toaster.show({
          title: 'Ù…ÙˆÙÙ‚ÛŒØª',
          message: 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´Ø¯.',
          color: 'success',
          icon: 'ph:check-circle',
          closable: true,
        })

        return // Exit early after handling category
      }
      catch (e: any) {
        toaster.show({
          title: 'Ø®Ø·Ø§',
          message: `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ: ${
            e.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'
          }`,
          color: 'danger',
          icon: 'ph:warning',
          closable: true,
        })
        throw e
      }
      finally {
        categoryAiLoading.value = false
      }
    }

    // For tags field specifically
    if (field === 'tags') {
      const prompt = `Ú†Ù†Ø¯ Ø¨Ø±Ú†Ø³Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† Ù…Ù‚Ø§Ù„Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡. ÙÙ‚Ø· Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§ (ØŒ) Ø¬Ø¯Ø§ Ú©Ù† Ùˆ Ú†ÛŒØ² Ø¯ÛŒÚ¯Ø±ÛŒ Ù†Ù†ÙˆÛŒØ³.\n\nØ¹Ù†ÙˆØ§Ù†: ${
        title.value || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'
      }\nØªÙˆØ¶ÛŒØ­Ø§Øª: ${description.value || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}`
      const messages = [{ role: 'user', content: prompt }]

      let suggestion = ''
      tagsAiLoading.value = true

      try {
        // First, collect the complete suggestion
        await new Promise<void>((resolve, reject) => {
          streamChat(messages, {}, (chunk) => {
            if (chunk) {
              suggestion += chunk
            }
          })
            .then(resolve)
            .catch(reject)
        })

        // After complete message is received, process tags
        if (suggestion) {
          // Split by both English and Persian commas, then clean up
          const newTags = suggestion
            .split(/[ØŒ,]/)
            .map(tag => tag.trim())
            .filter(tag => tag.length > 0)

          // Update tags with new unique values
          if (newTags.length > 0) {
            tags.value = [...new Set(newTags)]
          }
        }

        // Show success toast
        toaster.show({
          title: 'Ù…ÙˆÙÙ‚ÛŒØª',
          message: 'Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø´Ø¯Ù†Ø¯.',
          color: 'success',
          icon: 'ph:check-circle',
          closable: true,
        })

        return // Exit early after handling tags
      }
      catch (e: any) {
        toaster.show({
          title: 'Ø®Ø·Ø§',
          message: `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§: ${
            e.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'
          }`,
          color: 'danger',
          icon: 'ph:warning',
          closable: true,
        })
        throw e
      }
      finally {
        tagsAiLoading.value = false
      }
    }

    // For other fields, use the existing logic
    const context = {
      title: title.value,
      secretMessage: secretMessage.value,
      tags: tags.value.join('ØŒ '),
      excerpt: excerpt.value,
      slug: slug.value,
      readTime: readTime.value,
      description: description.value,
      contentLong: contentLong.value,
      goals: goals.value,
      category: category.value,
    }
    // Compose context string (exclude the current field)
    const contextMapping = {
      title: 'Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø§Ù„Ù‡',
      secretMessage: 'Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ',
      tags: 'Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§',
      excerpt: 'Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØªØ§Ù‡',
      slug: 'Ø§Ø³Ù„Ø§Ú¯',
      readTime: 'Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡',
      description: 'ØªÙˆØ¶ÛŒØ­Ø§Øª',
      contentLong: 'Ù…ØªÙ† Ú©Ø§Ù…Ù„',
      goals: 'Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ',
      category: 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ',
    }

    // Add category label if selected
    let enrichedContext = { ...context }
    if (enrichedContext.category) {
      const selectedCategory = categories.find(c => c.value === enrichedContext.category)
      if (selectedCategory) {
        enrichedContext.category = `${selectedCategory.label} (${enrichedContext.category})`
      }
    }

    const contextString = Object.entries(enrichedContext)
      .filter(([key]) => key !== field && enrichedContext[key])
      .map(([key, val]) => `${contextMapping[key] || key}: ${val}`)
      .join('\n')

    const prompts = {
      title:
        `ÛŒÚ© Ø¹Ù†ÙˆØ§Ù† Ù‚ÙˆÛŒØŒ Ø¬Ø°Ø§Ø¨ Ùˆ Ù‡ÙˆÚ©â€ŒØ¯Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ú©Ù‡ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ùˆ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² # Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ø®Ø· Ù†ÙˆØ´ØªÙ‡ Ø´ÙˆØ¯. Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§ÛŒØ¯:
        - Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ùˆ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø§Ø´Ø¯
        - Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø§Ø´Ø¯  
        - Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø§Ù†Ú¯ÛŒØ²Ø¯
        - Ú©Ù†Ø¬Ú©Ø§ÙˆÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯
        ÙÙ‚Ø· Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†.`,
      secretMessage: `ÛŒÚ© Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ø¹Ù…ÛŒÙ‚ØŒ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø± Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ù‚Ø§Ù„Ù‡ Ø®Ø§Øµ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡. Ù¾ÛŒØ§Ù… Ø¨Ø§ÛŒØ¯:
        - Ø§Ø² ØµÙ…ÛŒÙ… Ù‚Ù„Ø¨ Ùˆ Ø±ÙˆØ­ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø§Ø´Ø¯
        - Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯
        - Ø¨Ù‡â€ŒÚ¯ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ø¯Ø± Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø·Ø¨ÛŒØ¹ÛŒ Ùˆ Ø²ÛŒØ¨Ø§ Ù…Ù†Ø¹Ú©Ø³ Ø´ÙˆØ¯
        - ØªØ­ÙˆÙ„â€ŒØ¢ÙØ±ÛŒÙ† Ùˆ Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´ Ø¨Ø§Ø´Ø¯
        - Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ù‡ ØªÙÚ©Ø± Ø¹Ù…ÛŒÙ‚ ÙˆØ§Ø¯Ø§Ø±Ø¯
        Ø§Ø² Ú©Ù„ÛŒØ´Ù‡â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†. Ù¾ÛŒØ§Ù… Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø­ØµØ±Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø§Ø´Ø¯.`,
      tags: `Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ú©Ù‡:
        - Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ùˆ Ø§Ù‡Ø¯Ø§Ù Ù…Ù‚Ø§Ù„Ù‡ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ù†Ø¯
        - Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø§Ø´Ù†Ø¯
        - Ø¬Ø³ØªØ¬ÙˆÙ¾Ø°ÛŒØ±ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡Ù†Ø¯
        - ØªØ±Ú©ÛŒØ¨ÛŒ Ø§Ø² Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ùˆ Ø§Ø­Ø³Ø§Ø³ÛŒ Ø¨Ø§Ø´Ù†Ø¯
        Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø¬Ø¯Ø§ Ú©Ù†. ÙÙ‚Ø· Ù„ÛŒØ³Øª Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
      excerpt:
        `ÛŒÚ© Ø®Ù„Ø§ØµÙ‡ Ø¬Ø°Ø§Ø¨ Ùˆ Ù‡ÙˆÚ©â€ŒØ¯Ø§Ø± Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡:
        - Ø¬ÙˆÙ‡Ø±Ù‡ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ø±Ø§ Ù…Ù†Ø¹Ú©Ø³ Ú©Ù†Ø¯
        - Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ ØªØ´ÙˆÛŒÙ‚ Ø¨Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†Ø¯  
        - Ø¨Ø§ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯
        - ØªÛŒØ²Ø± Ù…Ù†Ø§Ø³Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø´Ø¯
        ÙÙ‚Ø· Ø®Ù„Ø§ØµÙ‡ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
      slug: `ÛŒÚ© Ø§Ø³Ù„Ø§Ú¯ SEO-friendly Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ú©Ù‡:
        - Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ÙˆØ¶ÙˆØ¹ Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø´Ø¯
        - Ù„Ø§ØªÛŒÙ† Ùˆ Ø¨Ø¯ÙˆÙ† ÙØ§ØµÙ„Ù‡ Ø¨Ø§Ø´Ø¯
        - Ø¬Ø³ØªØ¬ÙˆÙ¾Ø°ÛŒØ±ÛŒ Ø¨Ø§Ù„Ø§ÛŒÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        ÙÙ‚Ø· Ø§Ø³Ù„Ø§Ú¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
      readTime:
        'Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ùˆ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø¨Ø± Ø­Ø³Ø¨ Ø¯Ù‚ÛŒÙ‚Ù‡) Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†. ÙÙ‚Ø· ÛŒÚ© Ø¹Ø¯Ø¯ Ø¨Ù†ÙˆÛŒØ³.',
      description:
        `ÛŒÚ© ØªÙˆØ¶ÛŒØ­ Ø¬Ø§Ù…Ø¹ Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡:
        - Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² Ù…Ø·Ø§Ù„Ø¨ÛŒ Ú©Ù‡ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ø¨Ø§Ø´Ø¯
        - Ø¨Ø§ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ùˆ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯
        - Ø§Ù†Ú¯ÛŒØ²Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯
        ÙÙ‚Ø· ØªÙˆØ¶ÛŒØ­ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
      contentLong: `ÛŒÚ© Ù…ØªÙ† Ú©Ø§Ù…Ù„ØŒ Ø¬Ø§Ù…Ø¹ Ùˆ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡:

**Ø§Ù„Ø²Ø§Ù…Ø§Øª Ø§Ø³Ø§Ø³ÛŒ:**
- Ø­ØªÙ…Ø§Ù‹ ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Ø¨Ø§ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ù†ÙˆØ´ØªÙ‡ Ø´ÙˆØ¯
- ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ${contentLengthTarget.value} Ú©Ù„Ù…Ù‡ Ø¨Ø§Ø´Ø¯ (Ø­Ø¯Ø§Ù‚Ù„ ${Math.floor(contentLengthTarget.value * 0.8)} Ùˆ Ø­Ø¯Ø§Ú©Ø«Ø± ${Math.floor(contentLengthTarget.value * 1.2)} Ú©Ù„Ù…Ù‡)
- Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒØŒ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯

**Ø³Ø§Ø®ØªØ§Ø± Ù…Ø·Ù„ÙˆØ¨:**
- Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø·Ø¨ÛŒØ¹ÛŒ Ùˆ Ø²ÛŒØ¨Ø§ Ø¯Ø± Ø·ÙˆÙ„ Ù…ØªÙ† Ù…Ù†Ø¹Ú©Ø³ Ø´ÙˆØ¯ (Ù†Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ…)
- Ù‡Ø± ÛŒÚ© Ø§Ø² Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ù…Ù‚Ø§Ù„Ù‡ Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
- ØªÙ†Ø§Ø³Ø¨ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯

**ØªÙ†ÙˆØ¹ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† (Ø­ØªÙ…Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†):**
- Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (H1, H2, H3, H4)
- Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨ Ùˆ Ù†Ø§Ù…Ø±ØªØ¨  
- Ú†Ú©â€ŒÙ„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ
- Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù„Ù‡Ø§Ù…â€ŒØ¨Ø®Ø´
- Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙÛŒØ¯
- Ú©Ø¯Ù‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
- Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ù…Ø±Ø¬Ø¹
- ØªØ£Ú©ÛŒØ¯Ø§Øª Ù…ØªÙ†ÛŒ (bold, italic)
- Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ Ø®Ø· Ø§ÙÙ‚ÛŒ

Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ†:
${markdownGuide}

Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ÛŒØ¯ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ø§ ØªØ­Øª ØªØ£Ø«ÛŒØ± Ù‚Ø±Ø§Ø± Ø¯Ù‡Ø¯ Ùˆ Ø§Ø­Ø³Ø§Ø³ Ø±Ø¶Ø§ÛŒØª Ùˆ Ø¯Ø³ØªØ§ÙˆØ±Ø¯ Ø¨Ù‡ Ø§Ùˆ Ø¨Ø¯Ù‡Ø¯.`,
      goals:
        `Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ùˆ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ù‚Ø§Ù„Ù‡ØŒ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø®ØªÛŒ Ù…Ø´Ø®Øµ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡:
        - Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ Ø§ØµÙ„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø´Ù†Ø¯
        - Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªÛŒØ§Ø¨ÛŒ Ùˆ Ø¹Ù…Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯  
        - Ø´Ø§Ù…Ù„ Ø¬Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø·ÙÛŒØŒ Ø´Ù†Ø§Ø®ØªÛŒ Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø¨Ø§Ø´Ù†Ø¯
        - ØªØ­ÙˆÙ„ Ù…Ø«Ø¨Øª Ø¯Ø± Ø²Ù†Ø¯Ú¯ÛŒ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯
        Ù‡Ø± Ù‡Ø¯Ù Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø®Ø· Ù…Ø¬Ø²Ø§ Ø¨Ù†ÙˆÛŒØ³.`,
    }
    const prompt = prompts[field] || 'ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± Ù…Ù†Ø§Ø³Ø¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡.'
    const userContent = context[field]
    const messages = [
      {
        role: 'user',
        content: userContent
          ? `${prompt}\nÙ…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ: ${userContent}\nØ§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÚ¯Ø± Ù…Ù‚Ø§Ù„Ù‡:\n${contextString}`
          : `${prompt}\nØ§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÚ¯Ø± Ù…Ù‚Ø§Ù„Ù‡:\n${contextString}`,
      },
    ]
    try {
      let suggestion = ''
      // For all fields, update in real-time as chunks arrive
      const initialContent = getFieldValue(field)

      // Create a promise that resolves when streaming is complete
      await new Promise((resolve, reject) => {
        streamChat(messages, {}, (chunk) => {
          const content = chunk
          if (content) {
            suggestion += content

            // Update the field in real-time
            switch (field) {
              case 'title':
                title.value = (initialContent + ' ' + suggestion).trim()
                break
              case 'description':
                description.value = (initialContent + ' ' + suggestion).trim()
                break
              case 'excerpt':
                excerpt.value = (initialContent + ' ' + suggestion).trim()
                break
              case 'slug':
                slug.value = (initialContent + ' ' + suggestion).trim()
                break
              // case 'category':
              //   category.value = (initialContent + ' ' + suggestion).trim()
              //   break
              case 'secretMessage':
                secretMessage.value = (initialContent + ' ' + suggestion).trim()
                break
              case 'goals':
                goals.value = (initialContent + '\n' + suggestion).trim()
                break
              case 'contentLong':
                contentLong.value = (initialContent + '\n' + suggestion).trim()
                break
              case 'tags':
                const newTags
                  = (initialContent ? initialContent + ', ' : '') + suggestion
                tags.value = newTags
                  .split(',')
                  .map(t => t.trim())
                  .filter(Boolean)
                break
            }
          }
        })
          .then(resolve)
          .catch(reject)
      })

      // Show success toast
      toaster.show({
        title: 'Ù…ÙˆÙÙ‚ÛŒØª',
        message: `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.`,
        color: 'success',
        icon: 'ph:check-circle',
        closable: true,
      })
    }
    catch (e: any) {
      toaster.show({
        title: 'Ø®Ø·Ø§',
        message: `Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: ${
          e.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'
        }`,
        color: 'danger',
        icon: 'ph:warning',
        closable: true,
      })
      throw e // Re-throw to be caught by outer try-catch
    }
  }
  finally {
    // Ensure loading state is always reset
    switch (field) {
      case 'title':
        titleAiLoading.value = false
        break
      case 'secretMessage':
        secretMessageAiLoading.value = false
        break
      case 'goals':
        goalsAiLoading.value = false
        break
      case 'category':
        categoryAiLoading.value = false
        break
      case 'tags':
        tagsAiLoading.value = false
        break
      case 'excerpt':
        excerptAiLoading.value = false
        break
      case 'slug':
        slugAiLoading.value = false
        break
      case 'contentLong':
        contentLongAiLoading.value = false
        break
    }
  }
}
function getFieldValue(field) {
  switch (field) {
    case 'title':
      return title.value
    case 'description':
      return description.value
    case 'excerpt':
      return excerpt.value
    case 'slug':
      return slug.value
    case 'category':
      return category.value
    case 'tags':
      return tags.value.join('ØŒ ')
    case 'secretMessage':
      return secretMessage.value
    case 'contentLong':
      return contentLong.value
    case 'goals':
      return goals.value
    // ...other fields
    default:
      return ''
  }
}
function setFieldValue(field, value) {
  switch (field) {
    case 'tags':
      // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± ÛŒÚ© Ø±Ø´ØªÙ‡ Ø§Ø³ØªØŒ Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†:
      if (typeof value === 'string') {
        tags.value = value
          .split('ØŒ')
          .map(t => t.trim())
          .filter(Boolean)
      }
      else if (Array.isArray(value)) {
        tags.value = value
      }
      else {
        tags.value = []
      }
      break
    case 'title':
      title.value = value
      break
    case 'description':
      description.value = value
      break
    case 'excerpt':
      excerpt.value = value
      break
    case 'slug':
      slug.value = value
      break
    case 'category':
      category.value = value
      break
    case 'secretMessage':
      secretMessage.value = value
      break
    case 'contentLong':
      contentLong.value = value
      break
    case 'goals':
      goals.value = value
      break
    // ...other fields
  }
}
const showMarkdownAiEdit = ref(false)
const selectedMarkdownText = ref('')
const markdownAiEditDesc = ref('')
const markdownTextarea = ref<HTMLTextAreaElement | null>(null)

// Floating menu state
const showFloatingMenu = ref(false)
const floatingMenuPosition = ref({ x: 0, y: 0 })
const selectedTextRange = ref({ start: 0, end: 0 })

// Track which AI action is currently active
const activeAction = ref('')

// Custom AI actions configuration
const aiActions = ref([
  {
    icon: 'ph:sparkle',
    action: 'improve',
    title: 'Ø¨Ù‡Ø¨ÙˆØ¯ Ù…ØªÙ†',
    loading: false,
    prompt:
      'Ù…ØªÙ† Ø²ÛŒØ± Ø±Ø§ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¨Ø¯Ù‡ Ùˆ Ø¢Ù† Ø±Ø§ Ø®ÙˆØ§Ù†Ø§ØªØ± Ùˆ Ø¬Ø°Ø§Ø¨â€ŒØªØ± Ú©Ù†. Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø±ÙˆØ§Ù† Ùˆ ÙˆØ§Ø¶Ø­ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†:\n\n{text}',
  },
  {
    icon: 'ph:arrows-out-simple',
    action: 'simplify',
    title: 'Ø³Ø§Ø¯Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ',
    loading: false,
    prompt:
      'Ù…ØªÙ† Ø²ÛŒØ± Ø±Ø§ Ø³Ø§Ø¯Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ú©Ù† ØªØ§ Ø¨Ø±Ø§ÛŒ Ù…Ø®Ø§Ø·Ø¨ Ø¹Ø§Ø¯ÛŒ Ù‚Ø§Ø¨Ù„ ÙÙ‡Ù…â€ŒØªØ± Ø¨Ø§Ø´Ø¯. Ø§Ø² Ú©Ù„Ù…Ø§Øª Ùˆ Ø¬Ù…Ù„Ø§Øª Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†:\n\n{text}',
  },
  {
    icon: 'ph:arrows-in',
    action: 'expand',
    title: 'Ø¨Ø³Ø· Ø¯Ø§Ø¯Ù†',
    loading: false,
    prompt:
      'Ù…ØªÙ† Ø²ÛŒØ± Ø±Ø§ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ú¯Ø³ØªØ±Ø´ Ø¨Ø¯Ù‡. Ø­Ø¯ÙˆØ¯ Û±.Ûµ ØªØ§ Û² Ø¨Ø±Ø§Ø¨Ø± Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ± Ø´ÙˆØ¯:\n\n{text}',
  },
  {
    icon: 'ph:note-pencil',
    action: 'summarize',
    title: 'Ø®Ù„Ø§ØµÙ‡â€ŒÙ†ÙˆÛŒØ³ÛŒ',
    loading: false,
    prompt:
      'Ù…ØªÙ† Ø²ÛŒØ± Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®Ù„Ø§ØµÙ‡ Ùˆ Ù…Ø®ØªØµØ± Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†. ÙÙ‚Ø· Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ù…Ù‡Ù… Ø±Ø§ Ø­ÙØ¸ Ú©Ù†:\n\n{text}',
  },
])

// ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
const showActionEditor = ref(false)
const editingActionIndex = ref(null)
const editingAction = ref({})

// ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¹Ù…Ù„ÛŒØ§Øª
const saveActionEdit = () => {
  if (editingActionIndex.value !== null) {
    aiActions.value[editingActionIndex.value] = { ...editingAction.value }
    cancelActionEdit()
  }
}

// ØªØ§Ø¨Ø¹ Ù„ØºÙˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù…Ù„ÛŒØ§Øª
const cancelActionEdit = () => {
  editingActionIndex.value = null
  editingAction.value = {}
  showActionEditor.value = false
}

function openActionEditor() {
  showActionEditor.value = true
  editingActionIndex.value = -1
  editingAction.value = {
    icon: '',
    action: '',
    title: '',
    prompt: '',
    loading: false,
  }
}
const newAction = ref({
  icon: '',
  action: '',
  title: '',
  prompt: '',
  loading: false,
})

function openMarkdownAiEditPopup() {
  showMarkdownAiEdit.value = true
}

// Delete an AI action button
function deleteAction(index) {
  aiActions.value.splice(index, 1)
  // Reset editing state if we're editing the deleted action
  if (editingActionIndex.value === index) {
    cancelEdit()
  }
}

// Save a new or edited AI action button
function saveAction() {
  if (!editingAction.value) return

  // Validate required fields
  if (
    !editingAction.value.title
    || !editingAction.value.action
    || !editingAction.value.icon
    || !editingAction.value.prompt
  ) {
    return
  }

  if (editingActionIndex.value > -1) {
    // Update existing action
    aiActions.value[editingActionIndex.value] = { ...editingAction.value }
  }
  else {
    // Add new action
    aiActions.value.push({ ...editingAction.value })
  }

  // Show success toast
  toaster.show({
    title: 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯',
    message:
      editingActionIndex.value > -1
        ? 'Ø¯Ú©Ù…Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'
        : 'Ø¯Ú©Ù…Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯',
    color: 'success',
    icon: 'ph:check-circle',
    timeout: 3000,
  })

  // Reset editing state
  cancelEdit()
}

// Cancel editing and reset form
function cancelEdit() {
  editingAction.value = {
    icon: '',
    action: '',
    title: '',
    prompt: '',
    loading: false,
  }
  editingActionIndex.value = -1
}
function applyMarkdownAiEdit() {
  // Call AI API with selectedMarkdownText and markdownAiEditDesc
  const prompt = `ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…ØªÙ† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡.\nÙ…ØªÙ† ÙØ¹Ù„ÛŒ:\n${selectedMarkdownText.value}\nØªÙˆØ¶ÛŒØ­Ø§Øª:\n${markdownAiEditDesc.value}`
  const messages = [{ role: 'user', content: prompt }]
  streamChat(messages, {}, (chunk) => {
    const suggestion = chunk
    contentLong.value = contentLong.value.replace(
      selectedMarkdownText.value,
      suggestion,
    )
    showMarkdownAiEdit.value = false
    markdownAiEditDesc.value = ''
    selectedMarkdownText.value = ''
  })
}
// Handle text selection in markdown textarea
function handleMarkdownSelection(event: Event) {
  // We need to use setTimeout to ensure the selection is stable
  setTimeout(() => {
    const textarea = markdownTextarea.value?.$el?.querySelector('textarea')
    if (!textarea) {
      selectedMarkdownText.value = ''
      showFloatingMenu.value = false
      return
    }

    const start = textarea.selectionStart
    const end = textarea.selectionEnd

    if (start !== end) {
      const selectedText = textarea.value.substring(start, end).trim()
      if (selectedText) {
        console.log('Selected text:', selectedText) // Debug log
        selectedMarkdownText.value = selectedText
        selectedTextForImage.value = selectedText // Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±
        selectedTextRange.value = { start, end }

        // Show the inline buttons when text is selected
        showFloatingMenu.value = true
        return
      }
    }

    // No valid selection
    selectedMarkdownText.value = ''
    showFloatingMenu.value = false
  }, 10) // Small delay to ensure selection is available
}

// Handle AI rewrite actions
async function handleAIAction(action: string) {
  // Set active action for highlighting
  activeAction.value = action
  const textarea = markdownTextarea.value?.$el?.querySelector('textarea')
  if (!textarea) return

  const { start, end } = selectedTextRange.value
  const selectedText = textarea.value.substring(start, end)

  // Create a local loading state for this action
  const actionLoading = ref(true)

  try {
    // Find the action configuration
    const actionConfig = aiActions.value.find(a => a.action === action)
    if (!actionConfig) return

    // Use the prompt from the action configuration
    let prompt = actionConfig.prompt.replace('{text}', selectedText)

    const messages = [{ role: 'user', content: prompt }]

    let result = ''

    // Show loading state in toast notification
    const toastId = toaster.show({
      title: 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´',
      message: `Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù…ØªÙ† Ø¨Ø§ ${
        action === 'improve'
          ? 'Ø¨Ù‡Ø¨ÙˆØ¯'
          : action === 'simplify'
          ? 'Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ'
          : action === 'expand'
          ? 'Ø¨Ø³Ø·'
          : 'Ø®Ù„Ø§ØµÙ‡â€ŒØ³Ø§Ø²ÛŒ'
      }...`,
      color: 'info',
      icon: 'svg-spinners:90-ring-with-bg',
      closable: true,
      timeout: 0,
    }).id

    // Call AI API
    await streamChat(messages, {}, (chunk) => {
      result += chunk // Accumulate chunks instead of replacing
    })

    // Update the textarea with the AI result
    if (result) {
      const currentValue = textarea.value
      const beforeText = currentValue.substring(0, start)
      const afterText = currentValue.substring(end)
      contentLong.value = beforeText + result + afterText

      // Show success toast (skip clearing previous toast as it causes errors)
      toaster.show({
        title: 'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯',
        message: 'Ù…ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯',
        color: 'success',
        icon: 'ph:check-circle',
        closable: true,
        timeout: 3000,
      })
    }
  }
  catch (error) {
    console.error('AI rewrite error:', error)
    toaster.show({
      title: 'Ø®Ø·Ø§',
      message: 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ØªÙ†. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.',
      color: 'danger',
      icon: 'ph:warning-circle',
      closable: true,
    })
  }
  finally {
    // Hide buttons after action completes
    showFloatingMenu.value = false
    textarea.focus()
    // Reset active action
    activeAction.value = ''
  }
}
// Show/hide clear confirmation modal
const showClearConfirm = ref(false)

// Reset all form fields
function resetForm() {
  title.value = ''
  description.value = ''
  excerpt.value = ''
  slug.value = ''
  readTime.value = ''
  category.value = ''
  secretMessage.value = ''
  contentLong.value = ''
  goals.value = ''
  tags.value = []
  uploadedFiles.value = null
  contentLengthTarget.value = 5000

  // Close the modal after resetting
  showClearConfirm.value = false

  // Show success message
  toaster.show({
    title: 'Ù…ÙˆÙÙ‚ÛŒØª',
    message: 'Ù‡Ù…Ù‡â€ŒÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯',
    icon: 'ph:check-circle',
    color: 'success',
    timeout: 3000,
  })
}

// Load preview data from localStorage
const loadPreviewFromLocalStorage = () => {
  const savedData = localStorage.getItem('postPreview')
  if (savedData) {
    const data = JSON.parse(savedData)
    title.value = data.title || ''
    description.value = data.description || ''
    contentLong.value = data.contentLong || ''
    excerpt.value = data.excerpt || ''
    slug.value = data.slug || ''
    category.value = data.category || ''
    tags.value = data.tags || []
    publishDate.value = data.publishDate || ''
    readTime.value = data.readTime || ''
    isFeatured.value = data.isFeatured || false
    allowComments.value = data.allowComments ?? true
    secretMessage.value = data.secretMessage || ''
    goals.value = data.goals || ''
    contentLengthTarget.value = data.contentLengthTarget || 5000
    uploadedFiles.value = data.uploadedFiles || null
  }
}

// Attach selection handler and load saved data
onMounted(() => {
  // Need to wait until the DOM is fully loaded
  setTimeout(() => {
    const textarea = markdownTextarea.value?.$el?.querySelector('textarea')
    if (textarea) {
      console.log('Adding event listeners to textarea')
      textarea.addEventListener('mouseup', handleMarkdownSelection)
      textarea.addEventListener('keyup', handleMarkdownSelection)
      textarea.addEventListener('click', handleMarkdownSelection)
      textarea.addEventListener('select', handleMarkdownSelection)
    }
    else {
      console.warn('Textarea element not found')
    }
  }, 500) // Give it some time to render

  // Load saved data when component mounts
  loadPreviewFromLocalStorage()
})

// Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§
const syncAllFieldsAI = async () => {
  syncAllFieldsLoading.value = true

  try {
    if (!title.value.trim()) {
      toaster.show({
        title: 'Ù‡Ø´Ø¯Ø§Ø±',
        message: 'Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø§Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.',
        color: 'warning',
        icon: 'ph:warning',
        closable: true,
      })
      return
    }

    // ØªÙˆØ¶ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
    toaster.show({
      title: 'Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ',
      message: 'ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯...',
      color: 'info',
      icon: 'svg-spinners:90-ring-with-bg',
      timeout: 0,
    })

    // ØªØ±ØªÛŒØ¨ Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
    const syncOrder = [
      'secretMessage',
      'category',
      'description',
      'goals',
      'tags',
      'excerpt',
      'slug',
      'contentLong',
    ]

    // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ ØªØ£Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø²ÛŒØ§Ø¯ Ø³Ø±ÙˆØ±
    for (const fieldName of syncOrder) {
      try {
        await suggestAIField(fieldName)
        // ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
        await new Promise(resolve => setTimeout(resolve, 500))
      }
      catch (error) {
        console.warn(`Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ${fieldName}:`, error)
        // Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ ÙÛŒÙ„Ø¯ Ø¨Ø¹Ø¯ÛŒ Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
      }
    }

    toaster.show({
      title: 'Ù…ÙˆÙÙ‚ÛŒØª',
      message: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯.',
      color: 'success',
      icon: 'ph:check-circle',
      closable: true,
      timeout: 5000,
    })
  }
  catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:', error)
    toaster.show({
      title: 'Ø®Ø·Ø§',
      message: 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.',
      color: 'danger',
      icon: 'ph:warning',
      closable: true,
    })
  }
  finally {
    syncAllFieldsLoading.value = false
  }
}

// ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ù…ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
const generateImageForText = async () => {
  if (!selectedTextForImage.value.trim()) {
    toaster.show({
      title: 'Ù‡Ø´Ø¯Ø§Ø±',
      message: 'Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.',
      color: 'warning',
      icon: 'ph:warning',
      closable: true,
    })
    return
  }

  imageGenerationLoading.value = true

  try {
    // ØªÙˆÙ„ÛŒØ¯ prompt Ø¨Ø±Ø§ÛŒ ØªØµÙˆÛŒØ±
    const prompt = `Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªÙ† Ø²ÛŒØ±ØŒ ÛŒÚ© ØªÙˆØ¶ÛŒØ­ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø¨Ù†ÙˆÛŒØ³. ØªÙˆØ¶ÛŒØ­ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ø¹Ù†Ø§ØµØ± Ø¨ØµØ±ÛŒØŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ØŒ ØªØ±Ú©ÛŒØ¨â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø­Ø§Ù„Øª Ú©Ù„ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø§Ø´Ø¯:

${selectedTextForImage.value}

Ù‡Ù…Ú†Ù†ÛŒÙ† ÛŒÚ© Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ù…Ù†Ø§Ø³Ø¨ Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØµÙˆÛŒØ± Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ú©Ù‡ Ø¨Ø§ Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªÙ† Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§Ø´Ø¯.

ÙØ±Ù…Øª Ù¾Ø§Ø³Ø®:
PROMPT: [ØªÙˆØ¶ÛŒØ­ ØªØµÙˆÛŒØ±]
CAPTION: [Ø²ÛŒØ±Ù†ÙˆÛŒØ³ ØªØµÙˆÛŒØ±]`

    const messages = [{ role: 'user', content: prompt }]

    let result = ''
    await streamChat(messages, {}, (chunk) => {
      result += chunk
    })

    if (result) {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ prompt Ùˆ caption Ø§Ø² Ù¾Ø§Ø³Ø®
      const promptMatch = result.match(/PROMPT:\s*(.+?)(?=CAPTION:|$)/s)
      const captionMatch = result.match(/CAPTION:\s*(.+)$/s)

      if (promptMatch) {
        imagePrompt.value = promptMatch[1].trim()
      }
      if (captionMatch) {
        imageCaption.value = captionMatch[1].trim()
      }

      showImageModal.value = true
    }
  }
  catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ prompt ØªØµÙˆÛŒØ±:', error)
    toaster.show({
      title: 'Ø®Ø·Ø§',
      message: 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØµÙˆÛŒØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.',
      color: 'danger',
      icon: 'ph:warning',
      closable: true,
    })
  }
  finally {
    imageGenerationLoading.value = false
  }
}

// Ø§ÙØ²ÙˆØ¯Ù† markdown ØªØµÙˆÛŒØ± Ø¨Ù‡ Ù…ØªÙ†
const insertImageMarkdown = () => {
  if (!imagePrompt.value.trim() || !imageCaption.value.trim()) {
    toaster.show({
      title: 'Ù‡Ø´Ø¯Ø§Ø±',
      message: 'Ù„Ø·ÙØ§Ù‹ prompt Ùˆ Ø²ÛŒØ±Ù†ÙˆÛŒØ³ ØªØµÙˆÛŒØ± Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.',
      color: 'warning',
      icon: 'ph:warning',
      closable: true,
    })
    return
  }

  // ØªÙˆÙ„ÛŒØ¯ URL Ø³Ø§Ø®ØªÚ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ - Ø¯Ø± Ø¹Ù…Ù„ Ø¨Ø§ÛŒØ¯ Ø§Ø² API ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
  const imageUrl = `https://picsum.photos/600/400?random=${Date.now()}`

  const imageMarkdown = `\n\n![${imageCaption.value}](${imageUrl})\n*${imageCaption.value}*\n\n`

  // Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù…Ø­Ù„ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù…ØªÙ†
  const textarea = markdownTextarea.value?.$el?.querySelector('textarea')
  if (textarea && selectedTextRange.value.end > 0) {
    const currentValue = textarea.value
    const beforeText = currentValue.substring(0, selectedTextRange.value.end)
    const afterText = currentValue.substring(selectedTextRange.value.end)
    contentLong.value = beforeText + imageMarkdown + afterText
  }
  else {
    contentLong.value += imageMarkdown
  }

  // Ø¨Ø³ØªÙ† modal Ùˆ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
  showImageModal.value = false
  selectedTextForImage.value = ''
  imagePrompt.value = ''
  imageCaption.value = ''

  toaster.show({
    title: 'Ù…ÙˆÙÙ‚ÛŒØª',
    message: 'ØªØµÙˆÛŒØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…ØªÙ† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.',
    color: 'success',
    icon: 'ph:check-circle',
    closable: true,
  })
}

const generateGoalsListAI = async () => {
  generateGoalsAiLoading.value = true

  try {
    const topic = title.value.trim()
    if (!topic) {
      toaster.show({
        title: 'Ù‡Ø´Ø¯Ø§Ø±',
        message: 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø§Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.',
        color: 'warning',
        icon: 'ph:warning',
        closable: true,
      })
      return
    }

    goals.value = ''

    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø²Ù…ÛŒÙ†Ù‡ Ø¨Ù‡ØªØ±
    const contextInfo = []
    if (title.value.trim()) contextInfo.push(`Ø¹Ù†ÙˆØ§Ù†: ${title.value}`)
    if (secretMessage.value.trim()) contextInfo.push(`Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ: ${secretMessage.value}`)
    if (category.value) {
      const selectedCategory = categories.find(c => c.value === category.value)
      if (selectedCategory) contextInfo.push(`Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ: ${selectedCategory.label}`)
    }
    if (tags.value.length > 0) contextInfo.push(`Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§: ${tags.value.join('ØŒ ')}`)
    if (description.value.trim()) contextInfo.push(`ØªÙˆØ¶ÛŒØ­Ø§Øª: ${description.value}`)

    const contextString = contextInfo.join('\n')

    const prompt = `Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ±ØŒ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø®ØªÛŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ù†ÙˆÛŒØ³ Ú©Ù‡ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ù¾Ø³ Ø§Ø² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø§ÛŒÙ† Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ù‡ Ø¯Ø³Øª Ø®ÙˆØ§Ù‡Ø¯ Ø¢ÙˆØ±Ø¯:

${contextString}

Ø§Ù‡Ø¯Ø§Ù Ø¨Ø§ÛŒØ¯:
- Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø´Ù†Ø¯
- Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø§Ø´Ù†Ø¯
- Ø´Ø§Ù…Ù„ Ø§Ø¨Ø¹Ø§Ø¯ Ø´Ù†Ø§Ø®ØªÛŒØŒ Ø¹Ø§Ø·ÙÛŒ Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø¨Ø§Ø´Ù†Ø¯
- Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªÛŒØ§Ø¨ÛŒ Ø¨Ø§Ø´Ù†Ø¯
- ØªØ­ÙˆÙ„ Ù…Ø«Ø¨Øª Ø¯Ø± Ø²Ù†Ø¯Ú¯ÛŒ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯

Ù‡Ø± Ù‡Ø¯Ù Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø®Ø· Ù…Ø¬Ø²Ø§ Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø´Ø®Øµ Ø¨Ù†ÙˆÛŒØ³. Ø­Ø¯Ø§Ù‚Ù„ Ûµ Ùˆ Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û° Ù‡Ø¯Ù Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.`

    const messages = [
      {
        role: 'system',
        content: 'Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù…ØªØ®ØµØµ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ù‡Ø³ØªÛŒØ¯.',
      },
      { role: 'user', content: prompt },
    ]

    const { streamChat } = useOpenRouter()
    let result = ''

    await streamChat(messages, {}, (chunk) => {
      const content = chunk
      result += content
      goals.value = result // Update in real-time
    })

    toaster.show({
      title: 'Ù…ÙˆÙÙ‚ÛŒØª',
      message: 'Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù†Ø¯.',
      color: 'success',
      icon: 'ph:check-circle',
      closable: true,
    })
  }
  catch (e: any) {
    toaster.show({
      title: 'Ø®Ø·Ø§',
      message: `Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø§Ù‡Ø¯Ø§Ù: ${e.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`,
      color: 'danger',
      icon: 'ph:warning',
      closable: true,
    })
    goals.value = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ù‡Ø¯Ø§Ù Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ.'
    throw e
  }
  finally {
    generateGoalsAiLoading.value = false
  }
}
</script>

<template>
  <div class="p-4">
    <div class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <NuxtLink
          to="/posts/list"
          class="text-primary-500 hover:text-primary-600"
        >
          <Icon name="ph:arrow-right" class="size-6" />
        </NuxtLink>
        <BaseHeading
          tag="h1"
          size="2xl"
          weight="semibold"
          lead="tight"
          class="text-muted-800 dark:text-white"
        >
          Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯
        </BaseHeading>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
      <!-- Main Content -->
      <div class="lg:col-span-2">
        <BaseCard rounded="lg" class="mb-6">
          <div class="relative">
            <div class="p-6">
              <!-- Form -->
              <form class="space-y-6" @submit.prevent="submit">
                <!-- Title & Secret Message in one row -->
                <div class="mb-6 flex flex-col gap-4 md:flex-row">
                  <div class="flex-1">
                    <BaseInput
                      v-model="title"
                      label="Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø§Ù„Ù‡"
                      placeholder="Ù…Ø«Ù„Ø§Ù‹ Ù‚Ø¯Ø±Øª Ø°Ù‡Ù†"
                      icon="ph:article"
                      :error="errors.title"
                      class="w-full"
                    >
                      <template #action>
                        <button
                          type="button"
                          data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                          class="text-muted-400 hover:text-primary-500 absolute end-0 top-0 z-[1] flex size-8 items-center justify-center transition-colors duration-300"
                          :disabled="titleAiLoading"
                          @click="suggestAIField('title')"
                        >
                          <Icon
                            v-if="!titleAiLoading"
                            name="ph:sparkle"
                            class="size-4"
                          />
                          <Icon
                            v-else
                            name="svg-spinners:90-ring-with-bg"
                            class="size-4 animate-spin"
                          />
                        </button>
                      </template>
                    </BaseInput>
                  </div>
                  <div class="flex-1">
                    <BaseInput
                      v-model="secretMessage"
                      label="Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
                      placeholder="Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ Ø§ÛŒ Ú©Ù‡ Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒ Ø¨Ù‡ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ù…Ù†ØªÙ‚Ù„ Ú©Ù†ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³"
                      icon="ph:lock-key"
                      class="w-full"
                    >
                      <template #action>
                        <button
                          type="button"
                          data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                          class="text-muted-400 hover:text-primary-500 absolute end-0 top-0 z-[1] flex size-8 items-center justify-center transition-colors duration-300"
                          :disabled="secretMessageAiLoading"
                          @click="suggestAIField('secretMessage')"
                        >
                          <Icon
                            v-if="!secretMessageAiLoading"
                            name="ph:sparkle"
                            class="size-4"
                          />
                          <Icon
                            v-else
                            name="svg-spinners:90-ring-with-bg"
                            class="size-4 animate-spin"
                          />
                        </button>
                      </template>
                    </BaseInput>
                  </div>
                </div>
                <!-- Educational and Psychological Goals -->
                <div class="mb-6">
                  <div class="mb-2 flex items-center justify-between">
                    <label
                      class="text-muted-800 dark:text-muted-100 font-semibold"
                    >Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø®ØªÛŒ Ù…Ù‚Ø§Ù„Ù‡</label>
                    <button
                      type="button"
                      class="nui-focus border-muted-200 hover:border-primary-500 text-muted-700 dark:text-muted-200 hover:text-primary-600 dark:border-muted-700 dark:bg-muted-900 dark:hover:border-primary-500 dark:hover:text-primary-600 flex items-center gap-2 rounded-full border bg-white px-4 py-1 text-sm transition-colors duration-300"
                      :disabled="generateGoalsAiLoading"
                      @click="generateGoalsListAI"
                    >
                      <Icon
                        v-if="!generateGoalsAiLoading"
                        name="ph:sparkle"
                        class="size-4"
                      />
                      <Icon
                        v-else
                        name="svg-spinners:90-ring-with-bg"
                        class="size-4 animate-spin"
                      />
                    </button>
                  </div>
                  <BaseTextarea
                    v-model="goals"
                    placeholder="Ù‡Ø¯Ù Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø§Ø² Ù†Ú¯Ø§Ø±Ø´ Ù…Ù‚Ø§Ù„Ù‡ØŒ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ Ùˆ Ù…Ø·Ø§Ù„Ø¨ÛŒ Ú©Ù‡ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ ÛŒØ§Ø¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³Øª Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                    rows="4"
                    :error="errors.goals"
                  >
                    <template #action>
                      <button
                        type="button"
                        data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                        class="text-muted-400 hover:text-primary-500 absolute end-0 top-0 z-[1] flex size-8 items-center justify-center transition-colors duration-300"
                        :disabled="goalsAiLoading"
                        @click="suggestAIField('goals')"
                      >
                        <Icon
                          v-if="!goalsAiLoading"
                          name="ph:sparkle"
                          class="size-4"
                        />
                        <Icon
                          v-else
                          name="svg-spinners:90-ring-with-bg"
                          class="size-4 animate-spin"
                        />
                      </button>
                    </template>
                  </BaseTextarea>
                  <div class="text-primary-600 mt-1 text-xs">
                    (ØªØ£Ú©ÛŒØ¯: Ø®Ø±ÙˆØ¬ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³Øª Ø§Ù‡Ø¯Ø§Ù Ø¨Ø§Ø´Ø¯)
                  </div>
                </div>
                <!-- Category Selection -->
                <div class="mb-6">
                  <div class="mb-2 flex items-center justify-between">
                    <label
                      class="text-muted-800 dark:text-muted-100 font-semibold"
                    >Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ {{ category }}</label>
                    <button
                      type="button"
                      class="nui-focus border-muted-200 hover:border-primary-500 text-muted-700 dark:text-muted-200 hover:text-primary-600 dark:border-muted-700 dark:bg-muted-900 dark:hover:border-primary-500 dark:hover:text-primary-600 flex items-center gap-2 rounded-full border bg-white px-4 py-1 text-sm transition-colors duration-300"
                      :disabled="categoryAiLoading"
                      @click="suggestAIField('category')"
                    >
                      <Icon
                        v-if="!categoryAiLoading"
                        name="ph:sparkle"
                        class="size-4"
                      />
                      <Icon
                        v-else
                        name="svg-spinners:90-ring-with-bg"
                        class="size-4 animate-spin"
                      />
                    </button>
                  </div>
                  <div
                    class="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4"
                  >
                    <BaseRadioHeadless
                      v-for="cat in categories"
                      :key="cat.value"
                      v-model="category"
                      :name="'category'"
                      :value="cat.value"
                    >
                      <BaseCard
                        rounded="lg"
                        class="flex cursor-pointer items-center gap-2 border-2 p-3 transition-all duration-150 peer-checked:!border-[#9C6ADE] peer-checked:!bg-[#F6F0FF]"
                      >
                        <Icon :name="cat.icon" class="size-5 text-[#9C6ADE]" />
                        <span class="font-medium">{{ cat.label }}</span>
                      </BaseCard>
                    </BaseRadioHeadless>
                  </div>
                  <div
                    v-if="errors.category"
                    class="text-danger-500 mt-1 text-sm"
                  >
                    {{ errors.category }}
                  </div>
                </div>

                <!-- Tags -->
                <div
                  class="border-muted-200 dark:border-muted-700 dark:bg-muted-800/50 mb-6 rounded-xl border bg-white p-4"
                >
                  <div class="mb-4 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <Icon name="ph:tag" class="text-primary-500 size-5" />
                      <h3
                        class="text-muted-800 text-lg font-medium dark:text-white"
                      >
                        Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§
                      </h3>
                      <button
                        type="button"
                        data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                        class="text-muted-400 hover:text-primary-500 ml-2 flex size-8 items-center justify-center transition-colors duration-300"
                        :disabled="tagsAiLoading"
                        @click="suggestAIField('tags')"
                      >
                        <Icon
                          v-if="!tagsAiLoading"
                          name="ph:sparkle"
                          class="size-4"
                        />
                        <Icon
                          v-else
                          name="svg-spinners:90-ring-with-bg"
                          class="size-4 animate-spin"
                        />
                      </button>
                    </div>
                    <button
                      v-if="tags.length > 0"
                      type="button"
                      class="text-danger-500 hover:text-danger-600 flex items-center gap-1 text-sm transition-colors"
                      @click="removeAllTags"
                    >
                      <Icon name="ph:trash" class="size-4" />
                      <span>Ø­Ø°Ù Ù‡Ù…Ù‡</span>
                    </button>
                  </div>
                  <div class="mb-2 flex flex-wrap gap-2">
                    <span
                      v-for="(tag, i) in tags"
                      :key="i"
                      class="bg-primary-100 text-primary-700 flex items-center gap-1 rounded-full px-3 py-1 text-xs"
                    >
                      <span>{{ tag }}</span>
                      <button
                        type="button"
                        class="text-danger-500 hover:text-danger-700 ml-1"
                        @click="tags.splice(i, 1)"
                      >
                        <Icon name="ph:x" class="size-3" />
                      </button>
                    </span>
                  </div>
                  <div class="flex items-end gap-2">
                    <BaseInput
                      v-model="newTag"
                      label="Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø±Ú†Ø³Ø¨ Ø¬Ø¯ÛŒØ¯"
                      placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ"
                      size="sm"
                      @keyup.enter="addTag"
                    />
                    <BaseButton
                      color="primary"
                      size="sm"
                      @click="addTag"
                    >
                      Ø§ÙØ²ÙˆØ¯Ù†
                    </BaseButton>
                  </div>
                </div>

                <!-- Image Upload with Preview (Headless) -->
                <div class="mb-6 w-full">
                  <label
                    class="text-muted-800 dark:text-muted-100 mb-2 block font-semibold"
                  >ØªØµÙˆÛŒØ± Ù…Ù‚Ø§Ù„Ù‡ (Ø¢Ù¾Ù„ÙˆØ¯)</label>
                  <BaseInputFileHeadless
                    v-slot="{ open, remove, preview, drop, files }"
                    v-model="uploadedFiles"
                    :multiple="false"
                    class="w-full"
                  >
                    <div class="mb-4 flex items-center gap-2">
                      <button
                        type="button"
                        class="nui-focus border-muted-200 hover:border-primary-500 text-muted-700 dark:text-muted-200 hover:text-primary-600 dark:border-muted-700 dark:bg-muted-900 dark:hover:border-primary-500 dark:hover:text-primary-600 relative flex size-8 cursor-pointer items-center justify-center rounded-full border bg-white transition-colors duration-300"
                        tooltip="Select files"
                        @click="open"
                      >
                        <Icon name="lucide:plus" class="size-4" />
                        <span class="sr-only">Select files</span>
                      </button>
                    </div>
                    <div
                      role="button"
                      tabindex="-1"
                      @dragenter.stop.prevent
                      @dragover.stop.prevent
                      @drop="drop"
                    >
                      <div
                        v-if="!files?.length"
                        class="nui-focus border-muted-300 dark:border-muted-700 hover:border-muted-400 focus:border-muted-400 dark:hover:border-muted-600 dark:focus:border-muted-700 group cursor-pointer rounded-lg border-[3px] border-dashed p-8 transition-colors duration-300"
                        tabindex="0"
                        role="button"
                        @click="open"
                        @keydown.enter.prevent="open"
                      >
                        <div class="p-5 text-center">
                          <Icon
                            name="mdi-light:cloud-upload"
                            class="text-muted-400 group-hover:text-primary-500 group-focus:text-primary-500 mb-2 size-10 transition-colors duration-300"
                          />
                          <h4 class="text-muted-400 font-sans text-sm">
                            ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯
                          </h4>
                          <div>
                            <span
                              class="text-muted-400 font-sans text-[0.7rem] font-semibold uppercase"
                            >ÛŒØ§</span>
                          </div>
                          <label
                            class="text-muted-400 group-hover:text-primary-500 group-focus:text-primary-500 cursor-pointer font-sans text-sm underline underline-offset-4 transition-colors duration-300"
                          >Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„</label>
                        </div>
                      </div>
                      <ul v-else class="mt-6 space-y-2">
                        <li v-for="file in files" :key="file.name">
                          <div
                            class="border-muted-200 dark:border-muted-700 dark:bg-muted-800 relative flex items-center justify-end gap-2 rounded-xl border bg-white p-3"
                          >
                            <div class="flex items-center gap-2">
                              <div class="shrink-0">
                                <img
                                  v-if="file.type.startsWith('image')"
                                  class="size-14 rounded-xl object-cover object-center"
                                  :src="preview(file).value"
                                  alt="Image preview"
                                >
                                <img
                                  v-else
                                  class="size-14 rounded-xl object-cover object-center"
                                  src="/img/avatars/placeholder-file.png"
                                  alt="Image preview"
                                >
                              </div>
                              <div class="font-sans">
                                <span
                                  class="text-muted-800 dark:text-muted-100 line-clamp-1 block text-sm"
                                >{{ file.name }}</span>
                                <span class="text-muted-400 block text-xs">{{
                                  formatFileSize(file.size)
                                }}</span>
                              </div>
                            </div>
                            <div class="flex gap-2">
                              <button
                                class="border-muted-200 hover:border-primary-500 text-muted-700 dark:text-muted-200 hover:text-primary-600 dark:border-muted-700 dark:bg-muted-900 dark:hover:border-primary-500 dark:hover:text-primary-600 relative flex size-8 cursor-pointer items-center justify-center rounded-full border bg-white transition-colors duration-300"
                                type="button"
                                tooltip="Remove"
                                @click.prevent="remove(file)"
                              >
                                <Icon name="lucide:x" class="size-4" /><span
                                  class="sr-only"
                                >Remove</span>
                              </button>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </BaseInputFileHeadless>
                </div>

                <!-- Excerpt (Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØªØ§Ù‡) with AI button -->
                <BaseTextarea
                  v-model="excerpt"
                  label="Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØªØ§Ù‡"
                  placeholder="ÛŒÚ© Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø§Ù„Ù‡..."
                  rows="2"
                  size="sm"
                  rounded="md"
                  icon="ph:info"
                  :error="errors.excerpt"
                  addon
                  class="mb-6"
                >
                  <template #addon>
                    <button
                      type="button"
                      data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                      class="text-muted-400 hover:text-primary-500 flex h-12 w-10 items-center justify-center transition-colors duration-300"
                      :disabled="excerptAiLoading"
                      @click="suggestAIField('excerpt')"
                    >
                      <Icon
                        v-if="!excerptAiLoading"
                        name="ph:sparkle"
                        class="size-5"
                      />
                      <Icon
                        v-else
                        name="svg-spinners:90-ring-with-bg"
                        class="size-5 animate-spin"
                      />
                    </button>
                  </template>
                </BaseTextarea>

                <!-- Slug -->
                <BaseInput
                  v-model="slug"
                  label="Ø§Ø³Ù„Ø§Ú¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
                  placeholder="Ù…Ø«Ù„Ø§Ù‹ self-awareness"
                  icon="ph:link"
                  class="mb-6"
                >
                  <template #action>
                    <button
                      type="button"
                      data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                      class="text-muted-400 hover:text-primary-500 absolute end-0 top-0 z-[1] flex size-8 items-center justify-center transition-colors duration-300"
                      :disabled="slugAiLoading"
                      @click="suggestAIField('slug')"
                    >
                      <Icon
                        v-if="!slugAiLoading"
                        name="ph:sparkle"
                        class="size-4"
                      />
                      <Icon
                        v-else
                        name="svg-spinners:90-ring-with-bg"
                        class="size-4 animate-spin"
                      />
                    </button>
                  </template>
                </BaseInput>

                <!-- Allow Comments & Featured Toggle -->
                <div class="mb-6 flex gap-6">
                  <BaseSwitch v-model="allowComments" label="Ø§Ø¬Ø§Ø²Ù‡ Ø«Ø¨Øª Ù†Ø¸Ø±" />
                  <BaseSwitch v-model="isFeatured" label="Ù…Ù‚Ø§Ù„Ù‡ ÙˆÛŒÚ˜Ù‡" />
                </div>

                <!-- Date & Read Time -->
                <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
                  <div>
                    <label
                      class="text-muted-800 dark:text-muted-100 mb-2 block font-semibold"
                    >ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±</label>
                    <PersianCalendar v-model="publishDate" class="w-full" />
                    <div
                      v-if="errors.publishDate"
                      class="text-danger-500 mt-1 text-sm"
                    >
                      {{ errors.publishDate }}
                    </div>
                  </div>
                  <div>
                    <label
                      class="text-muted-800 dark:text-muted-100 mb-2 block font-semibold"
                    >Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
                    <BaseInput
                      v-model="readTime"
                      type="number"
                      min="1"
                      placeholder="Ù…Ø«Ù„Ø§Ù‹ Ûµ"
                      class="w-full"
                    />
                  </div>
                </div>

                <!-- Long Content (Markdown) -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <label
                      class="text-muted-800 dark:text-muted-100 mb-2 block font-semibold"
                    >Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù…Ù‚Ø§Ù„Ù‡ (Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ†)</label>
                    <button
                      type="button"
                      data-nui-tooltip="Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
                      class="text-muted-400 hover:text-primary-500 ml-2 flex size-8 items-center justify-center transition-colors duration-300"
                      :disabled="contentLongAiLoading"
                      @click="suggestAIField('contentLong')"
                    >
                      <Icon
                        v-if="!contentLongAiLoading"
                        name="ph:sparkle"
                        class="size-4"
                      />
                      <Icon
                        v-else
                        name="svg-spinners:90-ring-with-bg"
                        class="size-4 animate-spin"
                      />
                    </button>
                  </div>

                  <!-- Content Length Control -->
                  <div class="mb-4 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-600 dark:bg-gray-800">
                    <div class="mb-3 flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <Icon name="ph:text-aa" class="text-primary-500 size-5" />
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                          Ø·ÙˆÙ„ Ù…ØªÙ† Ù…Ø·Ù„ÙˆØ¨: <span class="text-primary-600 dark:text-primary-400 font-bold">{{ contentLengthTarget.toLocaleString() }}</span> Ú©Ù„Ù…Ù‡
                        </label>
                      </div>
                      <span class="rounded-full border bg-white px-2 py-1 text-xs text-gray-500 dark:bg-gray-700">
                        {{ minContentLength.toLocaleString() }} - {{ maxContentLength.toLocaleString() }}
                      </span>
                    </div>

                    <!-- Custom Slider -->
                    <div class="relative mb-3">
                      <input
                        v-model.number="contentLengthTarget"
                        type="range"
                        :min="minContentLength"
                        :max="maxContentLength"
                        :step="500"
                        class="content-length-slider h-2 w-full cursor-pointer appearance-none rounded-lg bg-gray-200 dark:bg-gray-700"
                      >
                      <div class="mt-2 flex justify-between px-1 text-xs text-gray-500">
                        <span class="rounded border bg-white px-2 py-1 dark:bg-gray-700">Ú©ÙˆØªØ§Ù‡</span>
                        <span class="rounded border bg-white px-2 py-1 dark:bg-gray-700">Ù…ØªÙˆØ³Ø·</span>
                        <span class="rounded border bg-white px-2 py-1 dark:bg-gray-700">Ø¨Ù„Ù†Ø¯</span>
                      </div>
                    </div>

                    <!-- Length Indicators -->
                    <div class="grid grid-cols-3 gap-2 text-xs">
                      <div class="rounded border bg-white p-2 text-center dark:bg-gray-700">
                        <div class="font-semibold text-orange-500">
                          Ú©ÙˆØªØ§Ù‡
                        </div>
                        <div class="text-gray-500">
                          Û±,Û°Û°Û° - Û³,Û°Û°Û°
                        </div>
                      </div>
                      <div class="rounded border bg-white p-2 text-center dark:bg-gray-700">
                        <div class="font-semibold text-blue-500">
                          Ù…ØªÙˆØ³Ø·
                        </div>
                        <div class="text-gray-500">
                          Û³,Û°Û°Û° - Û¸,Û°Û°Û°
                        </div>
                      </div>
                      <div class="rounded border bg-white p-2 text-center dark:bg-gray-700">
                        <div class="font-semibold text-green-500">
                          Ø¨Ù„Ù†Ø¯
                        </div>
                        <div class="text-gray-500">
                          Û¸,Û°Û°Û° - Û±Ûµ,Û°Û°Û°
                        </div>
                      </div>
                    </div>
                  </div>
                  <BaseTextarea
                    ref="markdownTextarea"
                    v-model="contentLong"
                    label=""
                    placeholder="Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù…Ù‚Ø§Ù„Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯... (Markdown)"
                    rows="12"
                    icon="ph:file-text"
                    :error="errors.contentLong"
                    class="mb-6"
                    addon
                    @mouseup="handleMarkdownSelection"
                    @keyup="handleMarkdownSelection"
                    @click="handleMarkdownSelection"
                    @select="handleMarkdownSelection"
                  >
                    <template #addon>
                      <span
                        class="ml-2 text-xs font-medium text-gray-500 dark:text-gray-400"
                      >
                        Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ù…ØªÙ†ØŒ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø¢Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯
                      </span>

                      <div class="mb-1 flex flex-wrap gap-1">
                        <button
                          v-for="action in aiActions"
                          :key="action.action"
                          :disabled="processing || !selectedMarkdownText"
                          :class="[
                            'flex items-center gap-1 rounded-md border px-2 py-1 text-right text-xs transition-colors',
                            activeAction === action.action
                              ? 'bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-500'
                              : 'border-gray-200 hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700',
                          ]"
                          :title="action.title"
                          @click="handleAIAction(action.action)"
                        >
                          <Icon
                            v-if="processing"
                            name="svg-spinners:90-ring-with-bg"
                            class="size-3 shrink-0"
                          />
                          <Icon
                            v-else
                            :name="action.icon"
                            class="text-primary-500 size-3 shrink-0"
                          />
                          <span>{{ action.title }}</span>
                        </button>

                        <!-- Ø¯Ú©Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± -->
                        <button
                          :disabled="imageGenerationLoading || !selectedTextForImage"
                          :class="[
                            'flex items-center gap-1 rounded-md border px-2 py-1 text-right text-xs transition-colors',
                            'border-green-200 hover:bg-green-100 dark:border-green-600 dark:hover:bg-green-700',
                          ]"
                          title="ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ù…ØªÙ†Ø§Ø³Ø¨"
                          @click="generateImageForText"
                        >
                          <Icon
                            v-if="imageGenerationLoading"
                            name="svg-spinners:90-ring-with-bg"
                            class="size-3 shrink-0"
                          />
                          <Icon
                            v-else
                            name="ph:image"
                            class="size-3 shrink-0 text-green-500"
                          />
                          <span>Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±</span>
                        </button>
                      </div>
                    </template>
                  </BaseTextarea>
                  <!-- Markdown Preview -->
                  <div
                    v-if="contentLong"
                    class="border-muted-200 dark:border-muted-700 dark:bg-muted-800/50 rounded-xl border p-4"
                  >
                    <div class="mb-2 flex items-center gap-2">
                      <Icon name="ph:eye" class="text-primary-500 size-4" />
                      <h3
                        class="text-muted-800 text-sm font-medium dark:text-white"
                      >
                        Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                      </h3>
                    </div>
                    <div
                      class="prose prose-sm dark:prose-invert prose-headings:mb-4 prose-ul:list-disc prose-ol:list-decimal prose-li:mr-4 rtl prose-p:text-right prose-ul:text-right prose-ol:text-right max-w-none"
                      style="margin-left: 0 !important; padding-left: 0 !important;"
                    >
                      <div
                        class="text-muted-500 dark:text-muted-400 leading-relaxed"
                      >
                        <AddonMarkdownRemark
                          :source="formatLongContent(contentLong)"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </BaseCard>
      </div>
      <!-- Sidebar -->
      <div class="lg:col-span-1">
        <BaseCard
          rounded="xl"
          class="mb-6 border border-[#E5D8FA] bg-[#F6F0FF] p-4 shadow-sm"
        >
          <div class="grid grid-cols-2 gap-3">
            <!-- Row 1 -->
            <BaseButton
              color="muted"
              :loading="loading"
              :disabled="loading"
              class="w-full rounded-xl px-4 py-3 text-base font-bold"
              @click="backToPosts"
            >
              <Icon name="ph:arrow-right" class="ml-2 size-4" />
              Ø§Ù†ØµØ±Ø§Ù
            </BaseButton>
            <BaseButton
              color="info"
              :disabled="loading || isPreviewDisabled"
              class="w-full rounded-xl px-4 py-3 text-base font-bold"
              @click="goToPreview"
            >
              <Icon name="ph:eye" class="ml-2 size-4" />
              Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            </BaseButton>

            <!-- Row 2 -->
            <BaseButton
              color="primary"
              :loading="loading"
              :disabled="loading"
              class="w-full rounded-xl px-4 py-3 text-base font-bold"
              @click="submit"
            >
              <Icon name="ph:check-circle" class="ml-2 size-4" />
              Ø§ÛŒØ¬Ø§Ø¯
            </BaseButton>
            <BaseButton
              color="danger"
              :disabled="!title.trim()"
              class="w-full rounded-xl px-4 py-3 text-base font-bold"
              @click="showClearConfirm = true"
            >
              <Icon name="ph:trash" class="ml-2 size-4" />
              Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡
            </BaseButton>
            <BaseButton
              color="success"
              :loading="syncAllFieldsLoading"
              :disabled="!title.trim() || syncAllFieldsLoading"
              class="mb-3 w-full rounded-xl px-4 py-3 text-base font-bold"
              data-nui-tooltip="ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯"
              @click="syncAllFieldsAI"
            >
              <Icon name="ph:arrows-clockwise" class="ml-2 size-4" />
              Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
            </BaseButton>
            <BaseButton
              title="ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
              class="mb-2 flex items-center gap-1 rounded-md border border-gray-200 px-2 py-1 text-right text-xs transition-colors hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700"
              @click="openActionEditor"
            >
              <Icon
                name="ph:pencil-simple"
                class="text-primary-500 size-3 shrink-0"
              />
              <span>ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§</span>
            </BaseButton>
          </div>
        </BaseCard>
        <BaseCard rounded="lg" class="mb-6">
          <div class="p-6">
            <div class="space-y-4">
              <BaseHeading
                tag="h3"
                size="sm"
                weight="medium"
                class="text-muted-800 dark:text-muted-100"
              >
                Ø±Ø§Ù‡Ù†Ù…Ø§
              </BaseHeading>
              <BaseParagraph class="text-muted-500 dark:text-muted-400">
                <ul class="list-inside list-disc space-y-2 text-sm">
                  <li><strong>Ø¹Ù†ÙˆØ§Ù†</strong> Ù¾Ø§ÛŒÙ‡ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³Øª</li>
                  <li><strong>Ù¾ÛŒØ§Ù… Ù…Ø®ÙÛŒ</strong> Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú©Ù„ Ù…ØªÙ† Ù…Ù†Ø¹Ú©Ø³ Ø´ÙˆØ¯</li>
                  <li><strong>Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</strong> ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
                  <li><strong>Ú©Ù†ØªØ±Ù„ Ø·ÙˆÙ„ Ù…ØªÙ†</strong> Ø¨Ø§ slider Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Øª</li>
                  <li><strong>ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±:</strong> Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ "Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</li>
                  <li>Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø§Ù‡Ø¯Ø§Ù Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù‡Ù…Ø®ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯</li>
                  <li>Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø´Ù†Ø¯</li>
                </ul>
              </BaseParagraph>
            </div>
          </div>
        </BaseCard>
      </div>
    </div>
  </div>

  <!-- Clear All Confirmation Modal -->
  <TairoModal
    :open="showClearConfirm"
    size="sm"
    rounded="lg"
    @close="showClearConfirm = false"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4">
        <h2 class="text-danger-500 text-lg font-bold">
          <Icon name="ph:warning-circle" class="mr-2 inline-block size-5" />
          Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡â€ŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        </h2>
        <button
          type="button"
          class="text-muted-400 hover:text-muted-500 dark:hover:text-muted-300 transition-colors"
          @click="showClearConfirm = false"
        >
          <Icon name="ph:x" class="size-5" />
        </button>
      </div>
    </template>

    <div class="px-6 pb-6">
      <div class="mb-6">
        <p class="text-muted-600 dark:text-muted-400 text-sm leading-relaxed">
          Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡â€ŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„
          ØªÙ…Ø§Ù…ÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ØŒ ØªØµØ§ÙˆÛŒØ± Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø±Ø§ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.
        </p>
      </div>

      <div class="flex items-center justify-end gap-3">
        <BaseButton
          color="muted"
          variant="pastel"
          class="px-4 py-2 text-sm font-medium"
          @click="showClearConfirm = false"
        >
          <Icon name="ph:arrow-counter-clockwise" class="ml-1.5 size-4" />
          Ø§Ù†ØµØ±Ø§Ù
        </BaseButton>
        <BaseButton
          color="danger"
          class="px-4 py-2 text-sm font-medium"
          @click="resetForm"
        >
          <Icon name="ph:trash" class="ml-1.5 size-4" />
          Ø¨Ù„Ù‡ØŒ Ù¾Ø§Ú© Ú©Ù†
        </BaseButton>
      </div>
    </div>
  </TairoModal>

  <!-- Markdown AI edit popup -->
  <TairoModal v-model="showMarkdownAiEdit" size="md">
    <template #header>
      <h2 class="text-lg font-bold">
        ÙˆÛŒØ±Ø§ÛŒØ´ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
      </h2>
    </template>
    <div class="flex flex-col gap-4 p-4">
      <div class="bg-muted-100 rounded p-2">
        {{ selectedMarkdownText }}
      </div>
      <BaseInput
        v-model="markdownAiEditDesc"
        label="ØªÙˆØ¶ÛŒØ­ ØªØºÛŒÛŒØ± Ù…ÙˆØ±Ø¯Ù†Ø¸Ø±"
        placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø±Ø³Ù…ÛŒâ€ŒØªØ± Ú©Ù†"
      />
      <BaseButton color="primary" @click="applyMarkdownAiEdit">
        Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±
      </BaseButton>
    </div>
  </TairoModal>

  <!-- Image Generation Modal -->
  <TairoModal
    :open="showImageModal"
    size="lg"
    rounded="lg"
    @close="showImageModal = false"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4">
        <h2 class="text-primary-500 text-lg font-bold">
          <Icon name="ph:image" class="mr-2 inline-block size-5" />
          ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ù…ØªÙ†
        </h2>
        <button
          type="button"
          class="text-muted-400 hover:text-muted-500 dark:hover:text-muted-300 transition-colors"
          @click="showImageModal = false"
        >
          <Icon name="ph:x" class="size-5" />
        </button>
      </div>
    </template>

    <div class="space-y-4 px-6 pb-6">
      <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-800">
        <h3 class="mb-2 text-sm font-medium">
          Ù…ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          {{ selectedTextForImage }}
        </p>
      </div>

      <div>
        <BaseTextarea
          v-model="imagePrompt"
          label="ØªÙˆØ¶ÛŒØ­ ØªØµÙˆÛŒØ± (Prompt)"
          placeholder="ØªÙˆØ¶ÛŒØ­ Ø¯Ù‚ÛŒÙ‚ ØªØµÙˆÛŒØ± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±..."
          rows="4"
          class="mb-4"
        />
      </div>

      <div>
        <BaseInput
          v-model="imageCaption"
          label="Ø²ÛŒØ±Ù†ÙˆÛŒØ³ ØªØµÙˆÛŒØ±"
          placeholder="Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ø¬Ø°Ø§Ø¨ Ø¨Ø±Ø§ÛŒ ØªØµÙˆÛŒØ±..."
        />
      </div>

      <div class="flex items-center justify-end gap-3 pt-4">
        <BaseButton
          color="muted"
          variant="pastel"
          class="px-4 py-2 text-sm font-medium"
          @click="showImageModal = false"
        >
          <Icon name="ph:arrow-counter-clockwise" class="ml-1.5 size-4" />
          Ø§Ù†ØµØ±Ø§Ù
        </BaseButton>
        <BaseButton
          color="primary"
          :disabled="!imagePrompt.trim() || !imageCaption.trim()"
          class="px-4 py-2 text-sm font-medium"
          @click="insertImageMarkdown"
        >
          <Icon name="ph:plus-circle" class="ml-1.5 size-4" />
          Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Ø¨Ù‡ Ù…ØªÙ†
        </BaseButton>
      </div>
    </div>
  </TairoModal>

  <!-- AI Action Editor Modal -->
  <TairoModal
    :open="showActionEditor"
    size="sm"
    rounded="lg"
    @close="showActionEditor = false"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4">
        <h2 class="text-primary-500 text-lg font-bold">
          <Icon name="ph:sparkle" class="mr-2 inline-block size-5" />
          ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ù…Ù„ÛŒØ§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
        </h2>
        <button
          type="button"
          class="text-muted-400 hover:text-muted-500 dark:hover:text-muted-300 transition-colors"
          @click="showActionEditor = false"
        >
          <Icon name="ph:x" class="size-5" />
        </button>
      </div>
    </template>

    <div class="px-6 pb-6">
      <div v-if="editingActionIndex !== null">
        <div class="mb-4">
          <BaseInput
            v-model="editingAction.icon"
            label="Ø¢ÛŒÚ©ÙˆÙ†"
            placeholder="Ù†Ø§Ù… Ø¢ÛŒÚ©ÙˆÙ† (Ù…Ø«Ø§Ù„: ph:sparkle)"
          />
        </div>

        <div class="mb-4">
          <BaseInput
            v-model="editingAction.title"
            label="Ø¹Ù†ÙˆØ§Ù†"
            placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¹Ù…Ù„ÛŒØ§Øª"
          />
        </div>

        <div class="mb-4">
          <BaseInput
            v-model="editingAction.action"
            label="Ú©Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª"
            placeholder="Ù†Ø§Ù… Ú©ÙˆØªØ§Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª"
          />
        </div>

        <div class="mb-4">
          <BaseTextarea
            v-model="editingAction.prompt"
            label="Ù¾Ø±Ø§Ù…Ù¾Øª"
            placeholder="Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ"
            rows="6"
          />
        </div>

        <div class="flex items-center justify-end gap-3">
          <BaseButton
            color="muted"
            variant="pastel"
            class="px-4 py-2 text-sm font-medium"
            @click="cancelActionEdit"
          >
            <Icon name="ph:arrow-counter-clockwise" class="ml-1.5 size-4" />
            Ø§Ù†ØµØ±Ø§Ù
          </BaseButton>
          <BaseButton
            color="primary"
            class="px-4 py-2 text-sm font-medium"
            @click="saveActionEdit"
          >
            <Icon name="ph:check" class="ml-1.5 size-4" />
            Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
          </BaseButton>
        </div>
      </div>
    </div>
  </TairoModal>
</template>

<style scoped>
.long-description {
  @apply space-y-6 text-muted-500 dark:text-muted-400 leading-relaxed;
}

.long-description h1 {
  @apply text-muted-800 dark:text-muted-100 text-xl font-semibold mb-4;
}

.long-description h2 {
  @apply text-muted-800 dark:text-muted-100 text-lg font-medium mb-3;
}

.long-description p {
  @apply mb-4;
}

.long-description ul {
  @apply list-disc list-inside mb-4;
}

.long-description ol {
  @apply list-decimal list-inside mb-4;
}

/* Fix for markdown preview spacing */
.prose {
  margin-left: 0 !important;
  padding-left: 0 !important;
  direction: rtl;
  text-align: right;
}

.prose > * {
  margin-left: 0 !important;
  padding-left: 0 !important;
  text-align: right;
}

.prose p,
.prose li,
.prose h1,
.prose h2,
.prose h3,
.prose h4,
.prose h5,
.prose h6 {
  text-align: right !important;
  margin-left: 0 !important;
  padding-left: 0 !important;
}

.prose ul,
.prose ol {
  text-align: right !important;
  margin-left: 0 !important;
  padding-left: 0 !important;
  padding-right: 1.5rem;
}

.prose blockquote {
  text-align: right !important;
  margin-left: 0 !important;
  padding-left: 0 !important;
  padding-right: 1rem;
  border-right: 4px solid;
  border-left: none;
}

.prose table {
  text-align: right !important;
  margin-left: 0 !important;
}

.prose th,
.prose td {
  text-align: right !important;
}

/* Custom Slider Styles */
.content-length-slider {
  -webkit-appearance: none;
  appearance: none;
  background: transparent;
  cursor: pointer;
}

.content-length-slider::-webkit-slider-track {
  background: linear-gradient(90deg, #f59e0b 0%, #3b82f6 50%, #10b981 100%);
  height: 8px;
  border-radius: 5px;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.content-length-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: #ffffff;
  border: 2px solid #3b82f6;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.content-length-slider::-webkit-slider-thumb:hover {
  background: #3b82f6;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.content-length-slider::-moz-range-track {
  background: linear-gradient(90deg, #f59e0b 0%, #3b82f6 50%, #10b981 100%);
  height: 8px;
  border-radius: 5px;
  border: none;
}

.content-length-slider::-moz-range-thumb {
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: #ffffff;
  border: 2px solid #3b82f6;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.content-length-slider::-moz-range-thumb:hover {
  background: #3b82f6;
  transform: scale(1.1);
}

/* Dark mode adjustments */
.dark .content-length-slider::-webkit-slider-thumb {
  background: #1f2937;
  border-color: #60a5fa;
}

.dark .content-length-slider::-webkit-slider-thumb:hover {
  background: #60a5fa;
}

.dark .content-length-slider::-moz-range-thumb {
  background: #1f2937;
  border-color: #60a5fa;
}

.dark .content-length-slider::-moz-range-thumb:hover {
  background: #60a5fa;
}
</style>
