<script setup lang="ts">
// import { generateInlineAnalysis } from '@/composables/useOpenRouter'  // REMOVE this import
import { useOpenRouter } from '@/composables/useOpenRouter'
import { convertToEmotionWheel } from '@/utils/emotion-mapper'

definePageMeta({
  title: 'گفتگو با روانشناس',
  layout: 'empty',
})
useHead({ htmlAttrs: { dir: 'rtl' } })
const { getTherapists } = useTherapist()
const { getCurrentSession, endSession, createSession } = useTherapistSession()
const { getMessages, sendMessage } = useTherapistsMessages()
const { getTherapyGoals } = useGoal()
const route = useRoute()
const nuxtApp = useNuxtApp()
const toaster = useToaster()
const conversations = ref<{ id: string, user: Therapist }[]>([])
const messages = ref<Message[]>([])
const loading = ref(false)
const messageLoading = ref(false)
const chatEl = ref<HTMLElement>()
const expanded = ref(false)
const newMessage = ref('')
const activeTherapistId = ref<string | null>(null)
const activeSession = ref<any>(null)
const showEmojiPicker = ref(false)
const showAudioUser = ref(false)
const showNoCharge = ref(true)
const remainingTime = ref<Date>()
const timeToShow = ref<number>()
const startChargeTime = ref<Date>()
const sessionId = ref<string | null>(null)
const sessionElapsedTime = ref(0)
const timeUpdateInterval = ref<NodeJS.Timeout | null>(null)
const userSubscription = ref<any>(null) // Initialize with null
const currentLoadingTherapistId = ref<string | null>(null)
const showScrollButton = ref(false)
const isAIResponding = ref(false)

const userReport = ref<Report | null>(null)
const hasPreviousData = ref(false)
const showGoalsModal = ref(false)
const userGoals = ref<any[]>([])
const activeGoals = ref<any[]>([])
const currentGoalIndex = ref(0)
const goalProgress = ref<any>({})
const conversationContext = ref<any>({})
const adaptiveFlow = ref({
  currentPriority: 'high',
  questionsAsked: [],
  culturalAdaptations: [],
  riskFactorsIdentified: [],
})

const { generateAnalysis, createAnalysis, getAnalysisForSession } = useSessionAnalysis()
const { createAndLinkAnalysis, getMessageAnalysis } = useMessageAnalysis()
const {
  submitFeedback,
  getFeedbackForMessage,
  validateFeedback,
  FEEDBACK_CATEGORIES,
} = useMessageFeedback()
const { getGoalsByUser, updateGoalProgress } = useGoals()

const toggleAudioUser = () => {
  showAudioUser.value = !showAudioUser.value
}

const emojiCategories = [
  { name: 'شاد', emojis: ['😀', '😃', '😄', '😁', '😆', '😂', '🤣', '😊', '😇', '😉', '😋', '😎', '😍', '😘', '🥳', '🤗', '😜', '😝'] },
  { name: 'غمگین', emojis: ['😢', '😭', '😞', '😔', '😟', '😥', '😓', '🥺', '💧', '😪', '😿', '😿'] },
  { name: 'عصبانی', emojis: ['😠', '😡', '😤', '🤬', '😒', '👿', '💢', '👺', '👹', '🤯'] },
  { name: 'عشق', emojis: ['❤️', '💕', '💗', '💓', '💖', '😍', '🥰', '😘', '💘', '💝', '💋'] },
  { name: 'تعجب', emojis: ['😲', '😯', '😦', '😧', '😱', '😨', '🧐', '😮‍💨', '😵‍💫', '🤔'] },
  { name: 'ترس', emojis: ['😱', '😨', '😰', '😖', '😧', '😣', '👻', '🕷️', '🕸️'] },
  { name: 'حیوانات', emojis: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵'] },
  { name: 'غذا', emojis: ['🍏', '🍎', '🍌', '🍉', '🍇', '🍓', '🍔', '🍕', '🍟', '🍿', '🍩', '🍪', '🧁', '🍰', '🍣'] },
  { name: 'ورزش', emojis: ['⚽', '🏀', '🏈', '⚾', '🎾', '🏐', '🏉', '🎱', '🏓', '🏸', '🏒', '🥊'] },
]
const currentCategory = ref(emojiCategories[0].name)
const tabContainerRef = ref<HTMLElement | null>(null)
const scrollTabs = (direction: 'left' | 'right') => {
  if (!tabContainerRef.value) return
  const amount = tabContainerRef.value.clientWidth * 0.7
  tabContainerRef.value.scrollBy({ left: direction === 'left' ? -amount : amount, behavior: 'smooth' })
}
const insertEmoji = (emoji: string) => {
  newMessage.value += emoji
}

const handleKeydown = (e: KeyboardEvent) => {
  if (e.key === 'Enter' && e.ctrlKey) {
    e.preventDefault()
    submitMessage()
  }
}

const emojiPickerRef = ref<HTMLElement>()
onClickOutside(emojiPickerRef, () => {
  showEmojiPicker.value = false
})

const formatTime = (timestamp: string | Date) => {
  const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp
  return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })
}
const scrollToBottom = () => {
  nextTick(() => {
    if (chatEl.value) {
      chatEl.value.scrollTo({
        top: chatEl.value.scrollHeight,
        behavior: 'smooth',
      })
    }
  })
}

const checkIfScrolledToBottom = () => {
  if (!chatEl.value) return true
  const { scrollHeight, scrollTop, clientHeight } = chatEl.value
  const isAtBottom = Math.abs(scrollHeight - scrollTop - clientHeight) < 10
  showScrollButton.value = !isAtBottom
}

const loadMessages = async (therapistId: string) => {
  if (currentLoadingTherapistId.value === therapistId || showNoCharge.value) {
    return
  }

  loading.value = true
  currentLoadingTherapistId.value = therapistId

  try {
    if (!nuxtApp.$pb.authStore.isValid) {
      await navigateTo('/auth/login')
      return
    }

    const session = await getCurrentSession(therapistId)
    if (session) {
      activeSession.value = session
      sessionId.value = session.id
      const loadedMessages = await getMessages(session.id)

      // Load analysis data for messages that have message_analysis
      const messagesWithAnalysis = await Promise.all(
        loadedMessages.map(async (msg) => {
          let analysisResult = null

          // Only try to load analysis for user messages (sent) that have message_analysis field
          if (msg.type === 'sent' && msg.message_analysis) {
            try {
              const analysisData = await getMessageAnalysis(msg.message_analysis)
              // Convert database format to the format expected by the UI
              analysisResult = {
                lastMessage_emotions: analysisData.emotions || [],
                correspondingEmojis: analysisData.emojis || '',
                // Note: emotionalResponse is not stored in message_analysis collection
                // It's part of the full analysis result generated dynamically
              }
            }
            catch (analysisError) {
              console.error('Error loading analysis for message:', msg.id, analysisError)
              // Continue without analysis if loading fails
            }
          }

          return {
            ...msg,
            timestamp: msg.time,
            analysisResult,
          }
        }),
      )

      messages.value = messagesWithAnalysis
      scrollToBottom()
      startSessionTimer() // Start session timer when messages are loaded
    }
    else if (!showNoCharge.value) {
      const newSession = await createSession(therapistId, 'therapy-journey')
      if (newSession) {
        activeSession.value = newSession
        sessionId.value = newSession.id
        messages.value = []
        startSessionTimer() // Start session timer for new session
      }
    }
  }
  catch (error) {
    console.error('Error loading messages:', error)
    messages.value = []
  }
  finally {
    loading.value = false
    currentLoadingTherapistId.value = null
  }
}

const selectConversation = async (therapistId: string) => {
  activeTherapistId.value = therapistId
  await loadMessages(therapistId)
  // Update session time immediately after loading messages
  if (activeSession.value) {
    updateSessionTime()
  }
  navigateTo({
    query: {
      ...route.query,
      therapistId,
    },
  })
}

watch(
  () => conversations.value,
  async (newConversations) => {
    if (newConversations.length > 0 && !activeTherapistId.value && !showNoCharge.value) {
      const therapistId = route.query.therapistId as string
      if (therapistId) {
        activeTherapistId.value = therapistId
        await loadMessages(therapistId)
      }
    }
  },
)

watch(activeTherapistId, async (newId) => {
  if (newId) {
    await loadMessages(newId)
  }
})

onUnmounted(() => {
  currentLoadingTherapistId.value = null
})

const selectedConversationComputed = computed(() => {
  return conversations.value.find(
    conversation => conversation.user.id === activeTherapistId.value,
  )
})

const getRandomColor = () => {
  const colors = [
    'bg-primary-500',
    'bg-info-500',
    'bg-success-500',
    'bg-warning-500',
    'bg-danger-500',
    'bg-purple-500',
    'bg-yellow-500',
    'bg-pink-500',
    'bg-indigo-500',
  ]
  return colors[Math.floor(Math.random() * colors.length)]
}

const {
  streamChat,
  models,
  selectedModel,
  loading: modelsLoading,
  error: modelsError,
  searchQuery,
  retryFetch,
  filteredModels,
  generateInlineAnalysis,
} = useOpenRouter()

const { role, user } = useUser()
const { createReport, updateReport, getReportByUserId } = useReport()
const streamingResponse = ref('')
const showModelError = ref(false)
const modelSearchInput = ref('')
const showModelDropdown = ref(false)

watch(modelSearchInput, (newValue) => {
  searchQuery.value = newValue
})

watch(activeTherapistId, async (newId) => {
  streamingResponse.value = ''
  if (newId) {
    await loadMessages(newId)
  }
})

// === GOAL-GUIDED CONVERSATION HELPER FUNCTIONS ===
function generateGoalGuidedPrompt(goals, userMessage, analysisResult) {
  if (!goals || goals.length === 0) return ''

  // Extract priority disorders from the new goal structure
  const priorityDisorders = []

  goals.forEach((goal) => {
    const goalData = goal?.goals || goal
    const disorders = goalData?.suggestedDisordersToInvestigate || []

    if (Array.isArray(disorders)) {
      disorders.forEach((category) => {
        if (category?.disorders) {
          category.disorders.forEach((disorder) => {
            priorityDisorders.push({
              category: category.categoryTitle,
              categoryDescription: category.categoryDescription,
              title: disorder.title,
              code: disorder.code,
              description: disorder.description,
              minimumCriteria: disorder.minimumCriteria,
              suicideRisk: disorder.suicideRisk,
              prevalence: disorder.Prevalence,
              developmentAndCourse: disorder.developmentAndCourse,
              conversationGuidance: goalData?.conversation_guidance,
            })
          })
        }
      })
    }
  })

  if (priorityDisorders.length === 0) {
    // Fallback to old structure if new structure not found
    const lowConfidenceGoals = goals.filter(g =>
      g.dsm5_aspects?.diagnostic_confidence < 70 && g.status !== 'completed',
    ).sort((a, b) => a.dsm5_aspects?.diagnostic_confidence - b.dsm5_aspects?.diagnostic_confidence)

    if (lowConfidenceGoals.length === 0) return ''

    let prompt = `\n\n=== DIAGNOSTIC GUIDANCE (Legacy Structure) ===\n`
    prompt += `Focus on these diagnostic areas:\n\n`

    lowConfidenceGoals.slice(0, 3).forEach((goal, index) => {
      const aspects = goal.dsm5_aspects || {}
      prompt += `${index + 1}. **${goal.title}** (Confidence: ${aspects.diagnostic_confidence || 0}%)\n`
      prompt += `   - Category: ${aspects.dsm5_category || 'Unknown'}\n`
      prompt += `   - Key criteria to explore: ${aspects.criteria_evidence || 'None specified'}\n`
    })

    return prompt
  }

  // Build comprehensive prompt with new structure
  let prompt = `\n\n=== COMPREHENSIVE DSM-5 DIAGNOSTIC GUIDANCE ===\n`
  prompt += `You are conducting an evidence-based diagnostic interview. Focus on exploring these disorders:\n\n`

  priorityDisorders.slice(0, 5).forEach((disorder, index) => {
    prompt += `${index + 1}. **${disorder.title}** (${disorder.code})\n`
    prompt += `   - Category: ${disorder.category}\n`
    prompt += `   - Description: ${disorder.description}\n`
    prompt += `   - Key Criteria to Assess: ${disorder.minimumCriteria}\n`

    if (disorder.suicideRisk && disorder.suicideRisk !== 'low') {
      prompt += `   - ⚠️ SUICIDE RISK: ${disorder.suicideRisk} - Monitor carefully\n`
    }

    if (disorder.prevalence) {
      prompt += `   - Prevalence: ${disorder.prevalence}\n`
    }

    prompt += `\n`
  })

  // Add conversation guidance if available
  if (priorityDisorders[0]?.conversationGuidance?.priority_questions) {
    prompt += `\nPRIORITY QUESTIONS TO EXPLORE:\n`
    priorityDisorders[0].conversationGuidance.priority_questions.slice(0, 3).forEach((question) => {
      prompt += `- ${question}\n`
    })
  }

  prompt += `\nCONVERSATION APPROACH:\n`
  prompt += `- Use natural, therapeutic conversation style\n`
  prompt += `- Explore symptoms systematically but sensitively\n`
  prompt += `- Pay attention to cultural context and individual presentation\n`
  prompt += `- Monitor for suicide risk throughout the conversation\n`
  prompt += `- Balance diagnostic assessment with emotional support\n`
  prompt += `- Don't make the questioning feel like a clinical checklist\n`

  if (analysisResult?.lastMessage_emotionIntensity === 'high') {
    prompt += `- ⚠️ HIGH EMOTIONAL INTENSITY DETECTED - Prioritize emotional regulation first\n`
  }

  if (analysisResult?.session_humanInterventionNeeded) {
    prompt += `- ⚠️ HUMAN INTERVENTION MAY BE NEEDED - Consider referral or immediate support\n`
  }

  // Check for high suicide risk
  const hasHighSuicideRisk = priorityDisorders.some(d => d.suicideRisk && d.suicideRisk.includes('high'))
  if (hasHighSuicideRisk) {
    prompt += `- 🚨 HIGH SUICIDE RISK IDENTIFIED - Assess immediately and consider safety planning\n`
  }

  prompt += `\n=== END DIAGNOSTIC GUIDANCE ===\n\n`

  return prompt
}

async function updateGoalProgressFromConversation(goals, userMessage, aiResponse, analysisResult) {
  if (!goals || goals.length === 0) return

  try {
    for (const goal of goals) {
      if (goal.status === 'completed') continue

      const aspects = goal.dsm5_aspects || {}
      let progressDelta = 0
      let confidenceDelta = 0
      let updatedEvidence = aspects.criteria_evidence || ''

      // Analyze if user message provides evidence for this goal's criteria
      const userMessageLower = userMessage.toLowerCase()
      const criteriaWords = (aspects.criteria_evidence || '').toLowerCase().split(' ')

      // Check for keyword matches (enhanced matching can be implemented later)
      const matchedCriteria = criteriaWords.filter(word =>
        word.length > 3 && userMessageLower.includes(word),
      )

      if (matchedCriteria.length > 0) {
        // Evidence found - increase confidence
        confidenceDelta = Math.min(10, matchedCriteria.length * 3)
        progressDelta = 5

        // Update evidence with new information
        const newEvidence = `${userMessage.substring(0, 100)}...`
        updatedEvidence += ` | New: ${newEvidence}`
      }

      // Use analysis result to inform progress
      if (analysisResult) {
        // Check emotional alignment with goal
        const primaryEmotions = analysisResult.lastMessage_primaryEmotions || []

        // Example: if goal relates to depression and user shows depressive emotions
        if (aspects.dsm5_category?.includes('Depressive')
          && primaryEmotions.some(emotion => ['sadness', 'hopelessness', 'despair'].includes(emotion))) {
          confidenceDelta += 5
          progressDelta += 3
        }

        // Example: anxiety-related goals
        if (aspects.dsm5_category?.includes('Anxiety')
          && primaryEmotions.some(emotion => ['anxiety', 'fear', 'worry'].includes(emotion))) {
          confidenceDelta += 5
          progressDelta += 3
        }
      }

      // Apply progress updates if there's meaningful change
      if (progressDelta > 0 || confidenceDelta > 0) {
        const newConfidence = Math.min(100, (aspects.diagnostic_confidence || 0) + confidenceDelta)
        const newProgress = Math.min(100, (goal.progress_percentage || 0) + progressDelta)

        const updatedAspects = {
          ...aspects,
          diagnostic_confidence: newConfidence,
          criteria_evidence: updatedEvidence,
          last_updated: new Date().toISOString(),
        }

        await updateGoalProgress(goal.id, {
          progress_percentage: newProgress,
          dsm5_aspects: updatedAspects,
          ai_evaluation: `Updated based on conversation. Evidence: ${matchedCriteria.join(', ')}`,
        })

        console.log(`Goal "${goal.title}" updated: confidence +${confidenceDelta}%, progress +${progressDelta}%`)
      }
    }
  }
  catch (error) {
    console.error('Error in updateGoalProgressFromConversation:', error)
    throw error
  }
}

async function submitMessage() {
  if (showNoCharge.value) {
    toaster.show({
      title: 'خطا',
      message: 'بسته مصرفی شما به اتمام رسیده است. لطفاً اقدام به خرید اشتراک نمایید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
    return
  }

  if (!newMessage.value || messageLoading.value || !activeSession.value?.id) return

  try {
    messageLoading.value = true
    const now = new Date().toISOString()
    streamingResponse.value = ''

    const userMessage = {
      type: 'sent',
      text: newMessage.value,
      timestamp: now,
    }

    const currentTherapist = selectedConversationComputed.value?.user
    if (!currentTherapist?.id) {
      console.error('No active therapist found')
      return
    }

    const session = activeSession.value

    const savedUserMessage = await sendMessage(currentTherapist.id, session.id, userMessage.text, 'sent')

    // Add user message immediately (without analysis first)
    const messageId = savedUserMessage.id
    messages.value.push({
      ...userMessage,
      id: messageId,
      timestamp: savedUserMessage.time,
      analysisResult: null, // Will be updated later
    })
    newMessage.value = ''
    scrollToBottom()

    // Inline Analysis Integration (in background)
    isAIThinking.value = true
    thinkingResponse.value = ''
    let analysisResult = null
    let formattedAnalysis = ''
    try {
      // Call generateInlineAnalysis with the user message
      const lastMessage = {
        role: 'user',
        content: userMessage.text,
      }
      analysisResult = await generateInlineAnalysis(lastMessage)

      console.log('analysisResult', analysisResult)

      // Save analysis to database and link to message
      try {
        const { analysis: savedAnalysis } = await createAndLinkAnalysis(messageId, analysisResult)
        console.log('Analysis saved to database:', savedAnalysis)
      }
      catch (dbError) {
        console.error('Error saving analysis to database:', dbError)
        // Continue even if database save fails
      }

      formattedAnalysis = formatInlineAnalysis(analysisResult)
      thinkingResponse.value = formattedAnalysis

      // Update the message with analysis result using message ID
      const messageToUpdate = messages.value.find(msg => msg.id === messageId)
      if (messageToUpdate) {
        messageToUpdate.analysisResult = analysisResult
      }
    }
    catch (err) {
      thinkingResponse.value = 'خطا در دریافت تحلیل. لطفا دوباره تلاش کنید.'
      console.error('Inline analysis error:', err)
    }
    finally {
      isAIThinking.value = false
    }

    // Remove temp assistant message logic. Do not push empty message.

    isAIResponding.value = true
    showScrollButton.value = false

    // --- NEW: Send analysis as detail to streamChat ---
    // Optionally, push the analysis as a new message (for display) ONLY if it is not empty
    if (thinkingResponse.value && thinkingResponse.value.trim() !== '') {
      // messages.value.push({
      //   type: 'analysis',
      //   text: thinkingResponse.value,
      //   timestamp: new Date().toISOString(),
      //   id: 'analysis-' + Date.now(),
      //   isExpanded: false,
      // })

      checkIfScrolledToBottom()
    }

    // === GOAL-GUIDED CONVERSATION ENHANCEMENT ===
    // Load active diagnostic goals for the user
    let activeUserGoals = []
    let goalGuidedPrompt = ''
    try {
      if (user.value?.id) {
        activeUserGoals = await getGoalsByUser(user.value.id)
        console.log('Active goals loaded:', activeUserGoals.length)

        // Generate goal-guided system prompt based on current goals and confidence levels
        if (activeUserGoals.length > 0) {
          goalGuidedPrompt = generateGoalGuidedPrompt(activeUserGoals, userMessage.text, analysisResult)
          console.log('Goal-guided prompt generated')
        }
      }
    }
    catch (goalError) {
      console.error('Error loading goals:', goalError)
      // Continue without goal guidance if there's an error
    }

    // Prepare chat history for AI with analysis; let composable inject system prompt
    const contextMessages = messages.value.map(msg => ({
      role: msg.type === 'sent' ? 'user' : 'assistant',
      content: msg.text,
    }))
    const chatMessagesForAI = [
      ...contextMessages,
      { role: 'user', content: userMessage.text },
    ]

    // Add goal-guided system message if available
    if (goalGuidedPrompt) {
      chatMessagesForAI.unshift({
        role: 'system',
        content: goalGuidedPrompt,
      })
    }

    // Call streamChat with therapistDetails option (so system prompt is automatically added)
    let aiResponse = ''
    // Show streaming response in real time
    isAIThinking.value = true
    thinkingResponse.value = ''
    await streamChat(chatMessagesForAI, { therapistDetails: selectedConversationComputed.value?.user }, (chunk) => {
      aiResponse += chunk
      thinkingResponse.value = aiResponse
    })
    isAIThinking.value = false

    // Remove any temporary typing indicators
    messages.value = messages.value.filter(msg => !msg.isTyping)

    // Save AI response to PocketBase
    const savedAIMessage = await sendMessage(currentTherapist.id, session.id, aiResponse, 'received')

    // Add AI response to messages with the correct ID
    messages.value.push({
      type: 'received',
      text: aiResponse,
      timestamp: savedAIMessage.time, // Use timestamp from saved message
      id: savedAIMessage.id, // Use ID from saved message
    })

    // === POST-CONVERSATION GOAL PROGRESS TRACKING ===
    // Update goal progress based on conversation content
    try {
      if (activeUserGoals.length > 0) {
        await updateGoalProgressFromConversation(activeUserGoals, userMessage.text, aiResponse, analysisResult)
        console.log('Goal progress updated')
      }
    }
    catch (progressError) {
      console.error('Error updating goal progress:', progressError)
      // Don't block the conversation flow if progress update fails
    }

    checkIfScrolledToBottom()
    isAIResponding.value = false
  }
  catch (e) {
    console.error('Error in chat:', e)
    messages.value.push({
      type: 'received',
      text: 'متاسفانه خطایی رخ داد. لطفا دوباره تلاش کنید.',
      timestamp: new Date().toISOString(),
      id: 'error-' + Date.now(),
    })
    scrollToBottom()
  }
  finally {
    messageLoading.value = false
  }
}

const showAnalysis = ref(false)
const toggleAnalysis = () => {
  showAnalysis.value = !showAnalysis.value
  nextTick(() => {
    if (showAnalysis.value) {
      scrollToBottom()
    }
  })
}

function formatInlineAnalysis(analysisResult) {
  if (!analysisResult) return 'نتیجه‌ای یافت نشد.'
  let output = ''

  if (showAnalysis.value) {
    output += '<div class="analysis-message bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">'

    if (showAnalysis.value) {
      output += '<div class="analysis-message bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">'

      if (showAnalysis.value) {
      // Session Details
        output += `\n**جزئیات جلسه:**\n`
        output += `- هدف جلسه: ${analysisResult.session_mainGoal || 'نامشخص'}\n`
        output += `- نیاز به مداخله انسانی: ${analysisResult.session_humanInterventionNeeded ? 'بله' : 'خیر'}\n`
        output += `- نیازهای ناهشیار: ${analysisResult.session_unconsciousNeeds || 'نامشخص'}\n`

        // Last Message Analysis
        output += `\n**تحلیل پیام آخر:**\n`
        output += `- احساسات اولیه: ${(analysisResult.lastMessage_primaryEmotions || []).join(', ') || 'نامشخص'}\n`
        output += `- احساسات دقیق‌تر: ${(analysisResult.lastMessage_nuancedEmotions || []).join(', ') || 'نامشخص'}\n`
        output += `- شدت احساسات: ${analysisResult.lastMessage_emotionIntensity || 'نامشخص'}\n`
        output += `- تناسب با هدف جلسه: ${analysisResult.lastMessage_alignmentWithGoal || 'نامشخص'}\n`
        output += `- پاسخ پیشنهادی: ${analysisResult.emotionalResponse || 'نامشخص'}\n`
      }
      else {
        output = '<div class="analysis-icon cursor-pointer" @click="showAnalysis = !showAnalysis"><Icon name="ph:chart-line" class="w-6 h-6 text-primary-500" /></div>'
      }
    }
    else {
      output = '<div class="analysis-icon cursor-pointer flex items-center justify-center p-3" @click="toggleAnalysis"><Icon name="ph:chart-line" class="w-6 h-6 text-primary-500" /></div>'
    }
  }
  else {
    output = '<div class="analysis-icon cursor-pointer flex items-center justify-center p-3" @click="toggleAnalysis"><Icon name="ph:chart-line" class="w-6 h-6 text-primary-500" /></div>'
  }
  return output + '</div>' + '</div>'
}

watch(messages, () => {
  if (!isAIResponding.value) {
    scrollToBottom()
  }
}, { deep: true })

const { pause, resume } = useInterval(1000, { controls: true })

const checkForHalfTime = () => {
  if (!startChargeTime.value || !timeToShow.value) return false
  const start = startChargeTime.value
  const now = new Date()
  const temp = Math.floor((now.getTime() - start.getTime()) / 60000)
  return (temp / timeToShow.value > 1)
}

watch(timeToShow, async (newValue) => {
  if (newValue <= 0 && activeSession.value?.id) {
    const startTime = new Date(activeSession.value.created)
    const endTime = new Date()
    const totalTimePassedMinutes = Math.round((endTime - startTime) / (1000 * 60))
    isReportModalOpen.value = true
    isGeneratingAnalysis.value = true
    await handleConfirmEndSession()
    showNoCharge.value = true
    pause()
  }
})

const updateSessionTime = () => {
  if (activeSession.value?.created) {
    try {
      // Convert the PocketBase timestamp to a Date object
      const startTime = new Date(activeSession.value.created)
      const currentTime = new Date()

      // Ensure both dates are valid
      if (isNaN(startTime.getTime()) || isNaN(currentTime.getTime())) {
        console.error('Invalid date detected:', { start: activeSession.value.created })
        sessionElapsedTime.value = 0
        return
      }

      const elapsedMilliseconds = currentTime.getTime() - startTime.getTime()
      const minutes = Math.floor(elapsedMilliseconds / 60000)

      // Sanity check: if minutes is negative or too large, something is wrong
      if (minutes < 0 || minutes > 24 * 60) {
        console.error('Invalid elapsed time:', minutes, 'minutes')
        sessionElapsedTime.value = 0
        return
      }

      sessionElapsedTime.value = minutes
    }
    catch (error) {
      console.error('Error calculating session time:', error)
      sessionElapsedTime.value = 0
    }
  }
  else {
    sessionElapsedTime.value = 0
  }
}

const startSessionTimer = () => {
  // Initial update
  updateSessionTime()

  // Clear existing interval if any
  if (timeUpdateInterval.value) {
    clearInterval(timeUpdateInterval.value)
  }

  // Update every 30 seconds
  timeUpdateInterval.value = setInterval(() => {
    updateSessionTime()
  }, 30000)
}

onMounted(async () => {
  loading.value = true
  try {
    const therapists = await getTherapists()
    conversations.value = therapists.map(p => ({ id: p.id, user: p }))

    const u = await nuxtApp.$pb
      .collection('users')
      .getOne(nuxtApp.$pb.authStore.model.id, {})
    showNoCharge.value = !u.hasCharge
    remainingTime.value = new Date(u.expireChargeTime)
    startChargeTime.value = new Date(u.startChargeTime)
    timeToShow.value = Math.floor((remainingTime.value.getTime() - new Date().getTime()) / (1000 * 60))

    const therapistId = route.query.therapistId as string
    if (therapistId) {
      activeTherapistId.value = therapistId
      const conversation = conversations.value.find(c => c.user.id === therapistId)
      if (conversation && !showNoCharge.value) {
        await loadMessages(therapistId)
      }
    }

    if (timeToShow.value <= 0) {
      showNoCharge.value = true
      pause()
    }

    timeUpdateInterval.value = setInterval(() => {
      if (timeToShow.value !== undefined) {
        timeToShow.value = timeToShow.value - 1
      }
    }, 60000)

    if (nuxtApp.$pb.authStore.isValid) {
      userSubscription.value = await nuxtApp.$pb.collection('users').subscribe(
        nuxtApp.$pb.authStore.model?.id,
        (e) => {
          const expireTime = new Date(e.record.expireChargeTime).getTime()
          timeToShow.value = Math.floor((expireTime - new Date().getTime()) / (1000 * 60))
          if (!e.record.hasCharge) {
            showNoCharge.value = true
            setTimeout(() => {
              if (chatEl.value) {
                chatEl.value.scrollTo({
                  top: chatEl.value.scrollHeight,
                  behavior: 'smooth',
                })
              }
            }, 600)
            pause()
          }
        },
      )

      // fetching userReport for having memory of previous sessions
      const userReportData = await getReportByUserId(nuxtApp.$pb.authStore.model?.id)
      if (userReportData) {
        userReport.value = userReportData
        hasPreviousData.value = true

        // If there are previous sessions (totalSessions > 0), we'll have AI start the conversation
        if (userReportData.totalSessions && userReportData.totalSessions > 0 && userReportData.summaries.length > 0) {
          console.log('This user has previous sessions, AI will start with a summary')
          // Wait a moment for UI to initialize properly
          setTimeout(() => {
            const session = activeSession.value
            if (!session) {
              console.error('No active session found')
              return
            }

            // Check if there are already messages in the conversation
            // If there are messages, don't trigger the AI introduction
            if (messages.value.length === 0) {
              startAIConversationWithSummary(selectedConversationComputed.value?.user, session.id, userReportData)
            }
            else {
              console.log('Messages already exist in conversation, skipping AI introduction')
            }
          }, 1000)
        }
      }
    }
  }
  catch (error) {
    console.error('Error initializing:', error)
  }
  finally {
    loading.value = false
    setTimeout(() => {
      if (chatEl.value) {
        chatEl.value.scrollTo({
          top: chatEl.value.scrollHeight,
          behavior: 'smooth',
        })
      }
    }, 300)
    resume()
  }
  if (chatEl.value) {
    chatEl.value.addEventListener('scroll', checkIfScrolledToBottom)
  }
})

onUnmounted(() => {
  pause()
  if (timeUpdateInterval.value) {
    clearInterval(timeUpdateInterval.value)
  }
  try {
    if (userSubscription.value) {
      nuxtApp.$pb.collection('users').unsubscribe(userSubscription.value)
    }
  }
  catch (error) {
    console.error('Error unsubscribing:', error)
  }
  if (chatEl.value) {
    chatEl.value.removeEventListener('scroll', checkIfScrolledToBottom)
  }
})

const clearMessages = async (sessionId: string) => {
  if (!sessionId) { throw new Error('Session ID is required') }
  try {
    const messageIds = messages.value
      .filter(msg => msg.session === sessionId)
      .map(msg => msg.id)

    for (const messageId of messageIds) {
      await nuxtApp.$pb.collection('therapists_messages').delete(messageId)
    }
    toaster.show({
      title: 'پاک کردن پیامها ',
      message: 'پیام ها با موفقیت پاک شدند.',
      color: 'success',
      icon: 'ph:eraser',
      closable: true,
    })
    messages.value = []
  }
  catch (error) {
    console.error('Error clearing messages:', error)
    throw error
  }
}

const confirmClearChat = async () => {
  if (showNoCharge.value) {
    toaster.show({
      title: 'خطا',
      message: 'بسته مصرفی شما به اتمام رسیده است. لطفاً اقدام به خرید اشتراک نمایید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
    return
  }

  if (!activeTherapistId.value) {
    toaster.show({
      title: 'خطا',
      message: 'لطفاً ابتدا یک روانشناس را انتخاب کنید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
    return
  }

  try {
    await clearMessages(activeSession.value.id)
    closeDeleteModal()
  }
  catch (error) {
    console.error('Error clearing messages:', error)
    toaster.show({
      title: 'خطا',
      message: 'خطا در پاک کردن پیام‌ها',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
  }
}

const gotoList = () => {
  navigateTo('/darmana/therapists/chooseTherapist')
}
const gotoReport = () => {
  navigateTo(`/report`)
}

const openGoalsModal = async () => {
  try {
    showGoalsModal.value = true
    // Fetch user's therapy goals with current session
    userGoals.value = await getTherapyGoals(activeSession.value?.id)
  }
  catch (error) {
    console.error('Error fetching goals:', error)
    userGoals.value = []
  }
}

// Function to have the AI start the conversation with a summary of previous sessions
async function startAIConversationWithSummary(therapist: any, sessionId: string, report: any) {
  if (!therapist || !sessionId || !report) return

  try {
    isAIResponding.value = true
    messageLoading.value = true
    streamingResponse.value = ''
    isAIThinking.value = true
    thinkingResponse.value = '...'

    // Add a temporary thinking message to show the user something is happening
    const tempThinkingId = 'thinking-' + Date.now()
    messages.value.push({
      type: 'received',
      text: 'درحال تحلیل جلسات قبلی...',
      timestamp: new Date().toISOString(),
      id: tempThinkingId,
      isTyping: true,
    })

    // Create a system message with the report summary data
    const systemContext = {
      role: 'system',
      content: `مراجع قبلا ${report.totalSessions} جلسه مشاوره داشته است. خلاصه جلسات قبلی:
${report.summaries?.map((session: any, idx: number) =>
  `جلسه ${idx + 1}: ${session.title}\n${session.summary}`,
).join('\n\n')}

اهداف عمیق‌تر احتمالی مراجع:
${report.possibleDeeperGoals?.join('\n')}

عوامل خطر احتمالی:
${report.possibleRiskFactors?.flat().map((risk: any) =>
  `${risk.title}: ${risk.description}`,
).join('\n')}
همچنین ممکن است اطلاعات دموگرافیک ارائه شده باشند: ${report.finalDemographicProfile}
اگر مقادیر مشخص نیستند، یعنی کاربر اطلاعات دموگرافیک را ارائه نکرده است.
از اطلاعاتی استفاده کن که کاربر وارد کرده است.
 با توجه به اطلاعات بالا، جلسه جدید را با یک خلاصه از جلسات قبلی و وضعیت مراجع شروع کن و از مراجع بپرس که امروز حالش چطور است و میخواهد درباره چه مسائلی صحبت کند. لحن باید گرم و حرفه‌ای باشد.
 همین طور از اهداف عمیق تر احتمالی نیز استفاده کن.  کاربر را ترغیب به دادن پاسخ در مورد موضوعات احتمالی کن.
 از ایموجی های خوب و جذاب استفاده کن.
 `,
    }
    console.log('report', report)

    // Generate initial AI message
    let aiResponse = ''

    // Call the OpenRouter API with the system context
    await streamChat([systemContext], { therapistDetails: therapist }, (chunk) => {
      aiResponse += chunk
      thinkingResponse.value = aiResponse
    })

    isAIThinking.value = false

    // Remove the temporary typing message
    messages.value = messages.value.filter(msg => !msg.isTyping)

    // Save AI response to PocketBase
    const savedAIMessage = await sendMessage(activeTherapistId.value || therapist.id, sessionId, aiResponse, 'received')

    // Add AI response to messages with the correct ID
    messages.value.push({
      type: 'received',
      text: aiResponse,
      timestamp: savedAIMessage.time,
      id: savedAIMessage.id,
    })

    scrollToBottom()
  }
  catch (e) {
    console.error('Error starting AI conversation with summary:', e)
    // Add fallback message if the summary fails
    messages.value.push({
      type: 'received',
      text: 'سلام، من روانشناس شما هستم. به نظر می‌رسد جلسات قبلی با هم داشته‌ایم. امروز حالتان چطور است و درباره چه چیزی می‌خواهید صحبت کنیم؟',
      timestamp: new Date().toISOString(),
      id: 'auto-' + Date.now(),
    })
    scrollToBottom()
  }
  finally {
    isAIResponding.value = false
    messageLoading.value = false
  }
}

const isReportModalOpen = ref(false)

const openReportModal = () => {
  isReportModalOpen.value = true
}

const closeReportModal = () => {
  if (!isGeneratingAnalysis.value) {
    isReportModalOpen.value = false
  }
}

const isDeleteModalOpen = ref(false)

const openDeleteModal = () => {
  isDeleteModalOpen.value = true
}

const closeDeleteModal = () => {
  isDeleteModalOpen.value = false
}

const isMessageDetailModalOpen = ref(false)
const selectedMessage = ref<any>(null)

const isFeedbackModalOpen = ref(false)
const selectedMessageForFeedback = ref<any>(null)
const feedbackForm = ref({
  rating: 0,
  general_text: '',
  general_other: '',
  problems_categories: {} as Record<string, boolean>,
  problems_other: '',
  quality_categories: {} as Record<string, boolean>,
  quality_other: '',
  improvements_categories: {} as Record<string, boolean>,
  improvements_other: '',
})
const isSubmittingFeedback = ref(false)
const feedbackStep = ref(1)
const feedbackErrors = ref<string[]>([])
const existingFeedback = ref<any>(null)
const showRetryConfirm = ref(false)
const selectedFeedbackType = ref<'problems' | 'quality' | null>(null)
const feedbackModalContent = ref<HTMLElement | null>(null)

const openMessageDetailModal = (message: any) => {
  selectedMessage.value = message
  isMessageDetailModalOpen.value = true
}

const closeMessageDetailModal = () => {
  isMessageDetailModalOpen.value = false
  selectedMessage.value = null
}

const openFeedbackModal = async (message: any) => {
  selectedMessageForFeedback.value = message
  feedbackStep.value = 1
  feedbackErrors.value = []
  selectedFeedbackType.value = null

  // Check if feedback already exists for this message
  try {
    existingFeedback.value = await getFeedbackForMessage(message.id)
    if (existingFeedback.value) {
      // Load existing feedback data
      feedbackForm.value = {
        rating: existingFeedback.value.rating || 0,
        general_text: existingFeedback.value.general_text || '',
        general_other: existingFeedback.value.general_other || '',
        problems_categories: existingFeedback.value.problems_categories || {},
        problems_other: existingFeedback.value.problems_other || '',
        quality_categories: existingFeedback.value.quality_categories || {},
        quality_other: existingFeedback.value.quality_other || '',
        improvements_categories: existingFeedback.value.improvements_categories || {},
        improvements_other: existingFeedback.value.improvements_other || '',
      }
    }
    else {
      // Reset form for new feedback
      feedbackForm.value = {
        rating: 0,
        general_text: '',
        general_other: '',
        problems_categories: {},
        problems_other: '',
        quality_categories: {},
        quality_other: '',
        improvements_categories: {},
        improvements_other: '',
      }
    }
  }
  catch (error) {
    console.error('Error checking existing feedback:', error)
    existingFeedback.value = null
  }

  isFeedbackModalOpen.value = true
}

const resetModalScroll = () => {
  if (feedbackModalContent.value) {
    feedbackModalContent.value.scrollTop = 0
  }
}

const closeFeedbackModal = () => {
  isFeedbackModalOpen.value = false
  selectedMessageForFeedback.value = null
}

const nextFeedbackStep = () => {
  feedbackErrors.value = []

  if (feedbackStep.value === 1) {
    // Validate basic feedback and category selection
    const errors = validateFeedback(feedbackForm.value)
    if (errors.length > 0) {
      feedbackErrors.value = errors
      return
    }

    // Check if user selected a feedback type
    if (!selectedFeedbackType.value) {
      feedbackErrors.value = ['لطفاً نوع بازخورد خود را انتخاب کنید (مشکلات یا نقاط قوت)']
      return
    }
  }

  if (feedbackStep.value < 3) {
    feedbackStep.value++
    resetModalScroll()
  }
}

const prevFeedbackStep = () => {
  if (feedbackStep.value > 1) {
    feedbackStep.value--
    resetModalScroll()
  }
  feedbackErrors.value = []
}

const submitMessageFeedback = async () => {
  if (!selectedMessageForFeedback.value || !activeSession.value || !activeTherapistId.value) return

  // Final validation
  const errors = validateFeedback(feedbackForm.value)
  if (errors.length > 0) {
    feedbackErrors.value = errors
    feedbackStep.value = 1
    return
  }

  isSubmittingFeedback.value = true
  try {
    const feedbackData = {
      message_id: selectedMessageForFeedback.value.id,
      session_id: activeSession.value.id,
      user_id: nuxtApp.$pb.authStore.model.id,
      therapist_id: activeTherapistId.value || selectedConversationComputed.value?.user.id,
      message_content: selectedMessageForFeedback.value.text,
      ...feedbackForm.value,
    }

    if (existingFeedback.value) {
      // Update existing feedback
      await nuxtApp.$pb.collection('message_feedback').update(existingFeedback.value.id, feedbackData)
      toaster.show({
        title: 'موفق',
        message: 'بازخورد شما با موفقیت به‌روزرسانی شد.',
        color: 'success',
        icon: 'ph:check-circle-fill',
        closable: true,
      })
    }
    else {
      // Create new feedback
      await submitFeedback(feedbackData)
      toaster.show({
        title: 'موفق',
        message: 'بازخورد شما با موفقیت ثبت شد.',
        color: 'success',
        icon: 'ph:check-circle-fill',
        closable: true,
      })
    }

    closeFeedbackModal()
  }
  catch (error) {
    console.error('Error submitting feedback:', error)
    toaster.show({
      title: 'خطا',
      message: 'خطا در ثبت بازخورد. لطفا دوباره تلاش کنید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
  }
  finally {
    isSubmittingFeedback.value = false
  }
}

const confirmRetryMessage = () => {
  showRetryConfirm.value = true
}

const retryLastMessage = async () => {
  if (messageLoading.value || isAIResponding.value || !messages.value.length) return

  showRetryConfirm.value = false

  // Find the last AI message
  const lastAIMessage = [...messages.value].reverse().find(msg => msg.type === 'received')
  if (!lastAIMessage) {
    toaster.show({
      title: 'خطا',
      message: 'هیچ پیام روانشناس برای تکرار یافت نشد.',
      color: 'warning',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
    return
  }

  try {
    messageLoading.value = true
    isAIResponding.value = true

    // Show user feedback
    toaster.show({
      title: 'در حال تولید پاسخ جدید',
      message: 'لطفا کمی صبر کنید...',
      color: 'info',
      icon: 'ph:arrow-clockwise',
      closable: true,
    })

    // Remove the last AI message from the UI and database
    const lastAIMessageIndex = messages.value.findIndex(msg => msg.id === lastAIMessage.id)
    if (lastAIMessageIndex !== -1) {
      messages.value.splice(lastAIMessageIndex, 1)
    }

    // Delete from database
    try {
      await nuxtApp.$pb.collection('therapists_messages').delete(lastAIMessage.id)
    }
    catch (deleteError) {
      console.error('Error deleting message from database:', deleteError)
      // Continue even if delete fails
    }

    // Get the last user message to regenerate response
    const lastUserMessage = [...messages.value].reverse().find(msg => msg.type === 'sent')
    if (!lastUserMessage) {
      toaster.show({
        title: 'خطا',
        message: 'پیام کاربری برای تولید پاسخ یافت نشد.',
        color: 'danger',
        icon: 'ph:warning-circle-fill',
        closable: true,
      })
      return
    }

    // Prepare chat history for AI
    const contextMessages = messages.value.map(msg => ({
      role: msg.type === 'sent' ? 'user' : 'assistant',
      content: msg.text,
    }))

    // Generate new AI response
    let aiResponse = ''
    isAIThinking.value = true
    thinkingResponse.value = ''

    await streamChat(contextMessages, { therapistDetails: selectedConversationComputed.value?.user }, (chunk) => {
      aiResponse += chunk
      thinkingResponse.value = aiResponse
    })

    isAIThinking.value = false

    // Save new AI response to PocketBase
    const savedAIMessage = await sendMessage(activeTherapistId.value!, activeSession.value!.id, aiResponse, 'received')

    // Add new AI response to messages
    messages.value.push({
      type: 'received',
      text: aiResponse,
      timestamp: savedAIMessage.time,
      id: savedAIMessage.id,
    })

    scrollToBottom()

    toaster.show({
      title: 'موفق',
      message: 'پاسخ جدید تولید شد.',
      color: 'success',
      icon: 'ph:check-circle-fill',
      closable: true,
    })
  }
  catch (error) {
    console.error('Error retrying message:', error)
    toaster.show({
      title: 'خطا',
      message: 'خطا در تولید پاسخ جدید. لطفا دوباره تلاش کنید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
  }
  finally {
    messageLoading.value = false
    isAIResponding.value = false
  }
}

const cancelRetry = () => {
  showRetryConfirm.value = false
}

// Convert analysis result to EmotionWheel format
const selectedMessageEmotions = computed(() => {
  if (!selectedMessage.value?.analysisResult?.lastMessage_emotions) {
    return []
  }

  try {
    return convertToEmotionWheel(selectedMessage.value.analysisResult.lastMessage_emotions)
  }
  catch (error) {
    console.error('Error converting emotions:', error)
    return []
  }
})

const handleEndSession = async () => {
  if (!activeSession.value) return

  if (showNoCharge.value) {
    toaster.show({
      title: 'خطا',
      message: 'شارژ شما به پایان رسیده است.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
    return
  }

  if (messages.value.length < 10) {
    toaster.show({
      title: 'خطا',
      message: 'برای ساخت گزارش، حداقل ۱۰ پیام باید رد و بدل شده باشد.',
      color: 'danger',
    })
    return
  }

  isReportModalOpen.value = true
}

const isGeneratingAnalysis = ref(false)

const handleConfirmEndSession = async () => {
  if (!activeSession.value) return

  isGeneratingAnalysis.value = true
  let savedAnalysisId = null

  try {
    // 1. Check if analysis already exists for this session
    let existingAnalysis = null
    try {
      existingAnalysis = await getAnalysisForSession(activeSession.value.id)
    }
    catch (error: any) {
      if (error?.status !== 404) {
        console.error('Error getting analysis for session:', error)
        toaster.show({
          title: 'خطا',
          message: 'خطا در بررسی آنالیز جلسه',
          color: 'danger',
          icon: 'ph:warning-circle-fill',
          closable: true,
        })
        isGeneratingAnalysis.value = false
        isReportModalOpen.value = false
        return
      }
      // If 404, just continue (analysis does not exist)
    }
    if (existingAnalysis) {
      savedAnalysisId = existingAnalysis.id
      isReportModalOpen.value = false
      await navigateTo(`/darmana/therapists/analysis?analysis_id=${savedAnalysisId}`)
      return
    }

    // 2. If not, generate and save analysis
    // Remove first AI message if it was the starting message (for users with previous sessions)
    let messagesToAnalyze = messages.value
    if (messages.value.length > 0 && messages.value[0].type === 'received') {
      // If first message is from AI (received), exclude it from analysis
      messagesToAnalyze = messages.value.slice(1)
    }

    const allMessages = messagesToAnalyze.map(msg => ({
      role: msg.type === 'sent' ? 'patient' : 'therapist',
      content: msg.text,
    }))

    const startTime = new Date(activeSession.value.created)
    const endTime = new Date()
    const totalTimePassedMinutes = Math.round((endTime - startTime) / (1000 * 60))

    // Generate and save analysis
    const generatedAnalysis = await generateAnalysis({
      sessionId: activeSession.value.id,
      messages: allMessages,
    })

    const savedAnalysis = await createAnalysis({
      session: activeSession.value.id,
      ...generatedAnalysis,
    })

    savedAnalysisId = savedAnalysis.id
    // Try to update session with the analysis ID
    try {
      await nuxtApp.$pb.collection('sessions').update(activeSession.value.id, {
        status: 'done',
        end_time: endTime.toISOString(),
        count_of_total_messages: messagesToAnalyze.length,
        total_time_passed: totalTimePassedMinutes,
        updated: endTime.toISOString(),
        session_analysis_for_system: savedAnalysisId,
      })

      activeSession.value.status = 'done'
      activeSession.value.session_analysis_for_system = savedAnalysisId
      let report: Report | null = null

      // Check if user already has a report
      const existingReport = await getReportByUserId(nuxtApp.$pb.authStore.model?.id)

      if (!existingReport) {
        // Create new report
        report = await createReport({
          user: nuxtApp.$pb.authStore.model.id,
          totalSessions: 1,
          summaries: [{
            session: activeSession.value.id,
            summary: savedAnalysis.summaryOfSession,
            title: savedAnalysis.title,
            date: activeSession.value.created,
            duration: totalTimePassedMinutes,
          }],
          finalDemographicProfile: savedAnalysis.demographicData,
          possibleRiskFactors: savedAnalysis.possibleRiskFactorsExtracted ? [savedAnalysis.possibleRiskFactorsExtracted] : [],
          possibleDeeperGoals: savedAnalysis.possibleDeeperGoalsOfPatient ? [savedAnalysis.possibleDeeperGoalsOfPatient] : [],
        })
      }
      else {
        // Update existing report
        const updatedData = {
          totalSessions: (existingReport.totalSessions || 0) + 1,
          summaries: [...(existingReport.summaries || []), {
            session: activeSession.value.id,
            summary: savedAnalysis.summaryOfSession,
            title: savedAnalysis.title,
            date: activeSession.value.created,
            duration: totalTimePassedMinutes,
          }],
          finalDemographicProfile: {
            ...(existingReport.finalDemographicProfile || {}),
            // Only merge non-null values from new demographic data
            ...Object.fromEntries(
              Object.entries(savedAnalysis.demographicData || {})
                .filter(([key, value]) => value !== null && value !== undefined),
            ),
          },
          possibleRiskFactors: [
            ...(existingReport.possibleRiskFactors || []),
            ...(savedAnalysis.possibleRiskFactorsExtracted ? [savedAnalysis.possibleRiskFactorsExtracted] : []),
          ],
          possibleDeeperGoals: [
            ...(existingReport.possibleDeeperGoals || []),
            ...(savedAnalysis.possibleDeeperGoalsOfPatient ? [savedAnalysis.possibleDeeperGoalsOfPatient] : []),
          ],
        }
        report = await updateReport(existingReport.id, updatedData)
      }
    }
    catch (updateError) {
      console.error('Error updating session:', updateError)
      // Continue even if session update fails - we'll still navigate to analysis
    }
  }
  catch (error) {
    console.error('Error ending session:', error)
    toaster.show({
      title: 'خطا',
      message: 'خطا در پایان جلسه. لطفا دوباره تلاش کنید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
  }
  finally {
    isGeneratingAnalysis.value = false
    isReportModalOpen.value = false

    await navigateTo(`/darmana/therapists/analysis?analysis_id=${savedAnalysisId}`)
  }
}

const handleAudioText = (text: string) => {
  newMessage.value = text
}

const handleAudioSend = () => {
  if (newMessage.value && !messageLoading.value) {
    submitMessage()
  }
}
const handleTextareaClick = () => {
  if (showNoCharge.value) {
    toaster.show({
      title: 'خطا',
      message: 'بسته مصرفی شما به اتمام رسیده است. لطفاً اقدام به خرید اشتراک نمایید.',
      color: 'danger',
      icon: 'ph:warning-circle-fill',
      closable: true,
    })
  }
}
const thinkingResponse = ref('')
const isAIThinking = ref(false)
// --- Ensure no 'thinking' message is pushed to messages ---
// In submitMessage or any streaming logic, do not push a 'thinking' or empty message to messages array.
// Only use isAIThinking and thinkingResponse for the typing indicator.

</script>

<template>
  <div class="relative">
    <div class="bg-muted-100 dark:bg-muted-900 flex min-h-screen overflow-hidden">
      <!-- Sidebar -->
      <div
        class="border-muted-200 dark:border-muted-700 dark:bg-muted-800 relative z-10 hidden h-screen w-20 border-r bg-white sm:block"
      >
        <div class="flex h-full flex-col justify-between">
          <div class="flex flex-col">
            <div
              class="ltablet:w-full flex size-16 shrink-0 items-center justify-center lg:w-full"
            >
              <NuxtLink to="/dashboard" class="flex items-center justify-center">
                <div class="rounded-full bg-white p-[5px]">
                  <img
                    src="/img/logo-no-bg.png"
                    width="40"
                    height="40"
                    alt=""
                    srcset=""
                  >
                </div>
              <!-- <TairoLogo class="text-primary-600 h-10" /> -->
              </NuxtLink>
            </div>
            <div
              class="ltablet:w-full flex size-16 shrink-0 items-center justify-center lg:w-full"
            >
              <BaseThemeToggle />
            </div>
          </div>
          <div class="flex flex-col">
            <div
              class="ltablet:w-full flex size-16 shrink-0 items-center justify-center lg:w-full"
            >
              <a
                href="#"
                class="text-muted-400 hover:text-primary-500 hover:bg-primary-500/20 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300"
                title="Back"
                @click.prevent="gotoList()"
              >
                <Icon name="lucide:arrow-right" class="size-5" />
              </a>
            </div>

            <div class="flex h-16 w-full items-center justify-center">
              <button
                type="button"
                class="text-danger-400 hover:text-danger-500 hover:bg-danger-500/20 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300 disabled:opacity-50"
                title="پاک کردن چت"
                @click="openDeleteModal()"
              >
                <Icon name="ph:trash-duotone" class="size-5" />
              </button>
            </div>
            <div class="flex h-16 w-full items-center justify-center">
              <DemoAccountMenu />
            </div>
          </div>
        </div>
      </div>
      <!-- Conversations -->
      <div
        class="ltablet:border-r border-muted-200 dark:border-muted-700 dark:bg-muted-800 relative z-[9] h-screen w-16 bg-white sm:w-20 lg:border-r"
      >
        <div class="mt-3 flex h-full flex-col justify-between gap-2">
          <!-- List -->
          <div>
            <a
              v-for="conversation in conversations"
              :key="conversation.id"
              href="#"
              class="flex size-16 shrink-0 items-center justify-center border-s-2 sm:w-20"
              :class="
                activeTherapistId === conversation.user.id
                  ? 'border-primary-500'
                  : 'border-transparent'
              "
              @click.prevent="selectConversation(conversation.user.id)"
            >
              <div class="relative flex w-full justify-center gap-2">
                <div
                  class="relative flex w-14 shrink-0 items-center justify-center"
                >
                  <a
                    href="#"
                    class="relative block"
                    :class="[
                      selectedConversationComputed?.user.id === conversation.user.id
                        ? 'z-10'
                        : '',
                    ]"
                    @click.prevent="selectConversation(conversation.user.id)"
                  >
                    <BaseAvatar
                      size="sm"
                      rounded="full"
                      :src="
                        conversation.user.avatar
                          ? `https://pocket.zehna.ir/api/files/therapists/${conversation.user.id}/${conversation.user.avatar}`
                          : '/img/avatars/1.svg'
                      "
                      :text="conversation.user.name?.charAt(0)"
                      :class="getRandomColor()"
                    />
                  </a>
                </div>
              </div>
            </a>
          </div>
          <div class="mb-12 flex flex-col gap-3 sm:hidden">
            <button
              class="bg-primary-500/30 dark:bg-primary-500/70 dark:text-muted-100 text-muted-600 hover:text-primary-500 hover:bg-primary-500/50 mr-2 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300"
              title="نمایش اطلاعات"
              @click="expanded = !expanded"
            >
              <Icon
                name="ph:robot"
                class="size-5"
              />
            </button>
            <button
              class="bg-success-500/30 dark:bg-success-500/70 dark:text-muted-100 text-muted-600 hover:text-success-500 hover:bg-success-500/50 mr-3 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300"
              title="پایان جلسه"
              @click="handleEndSession"
            >
              <Icon
                name="ph:check"
                class="size-5"
              />
            </button>
          </div>
        </div>
      </div>

      <!-- Current conversation -->
      <div
        class="relative w-full transition-all duration-300"
        :class="
          expanded
            ? 'ltablet:max-w-[calc(100%_-_160px)] lg:max-w-[calc(100%_-_160px)]'
            : 'ltablet:max-w-[calc(100%_-_470px)] lg:max-w-[calc(100%_-_550px)]'
        "
      >
        <div class="flex w-full flex-col">
          <!-- Header -->
          <div
            class="mb-2 flex h-16 w-full items-center justify-between px-4 sm:px-8"
          >
            <div class="mt-[140px] flex items-center gap-2 md:mt-4">
              <div class="flex">
                <BaseMessage
                  v-if="!showNoCharge"
                  class="w-[180px]"
                  :color="timeToShow > 10 ? 'success' : 'warning'"
                >
                  <span v-if="timeToShow > 0">
                    <span class="mx-2">⏰</span>
                    {{ timeToShow ?? '--' }} دقیقه</span>
                  <span v-else>وقت تقریبا تمام است</span>
                </BaseMessage>
                <BaseMessage
                  v-else
                  class="w-[280px] justify-center !pl-2"
                  color="warning"
                >
                  لطفا اشتراک تهیه فرمایید.
                  <BaseButtonIcon
                    rounded="full"
                    size="sm"
                    color="success"
                    class="mr-3"
                    to="/onboarding"
                  >
                    <Icon name="ph:shopping-cart" class="size-5" />
                  </BaseButtonIcon>
                </BaseMessage>
                <div class="hidden sm:flex">
                  <button
                    class="bg-primary-500/30 dark:bg-primary-500/70 dark:text-muted-100 text-muted-600 hover:text-primary-500 hover:bg-primary-500/50 mr-3 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300"
                    title="نمایش اطلاعات"
                    @click="expanded = !expanded"
                  >
                    <Icon
                      name="ph:robot"
                      class="size-5"
                    />
                  </button>
                  <button
                    class="bg-success-500/30 dark:bg-success-500/70 dark:text-muted-100 text-muted-600 hover:text-success-500 hover:bg-success-500/50 mr-3 flex size-12 items-center justify-center rounded-2xl transition-colors duration-300"
                    title="پایان جلسه"
                    @click="handleEndSession"
                  >
                    <Icon
                      name="ph:check"
                      class="size-5"
                    />
                  </button>
                </div>
              </div>
            </div>

            <TairoSidebarTools
              class="relative -end-4 z-20 flex h-16 w-full scale-90 items-center justify-end gap-2 sm:end-0 sm:scale-100"
            />
          </div>
          <!-- Body -->
          <div
            ref="chatEl"
            class="relative flex h-[calc(100vh-4rem)] flex-col p-4 !pb-60 sm:p-8"
            :class="loading ? 'overflow-hidden' : 'overflow-y-auto nui-slimscroll'"
          >
            <!-- Loader-->
            <div v-if="loading" class="mt-8">
              <div class="mb-3 flex items-center justify-center">
                <BasePlaceload
                  class="size-24 shrink-0 rounded-full"
                  :width="96"
                  :height="96"
                />
              </div>
              <div class="flex flex-col items-center">
                <BasePlaceload class="mb-2 h-3 w-full max-w-40 rounded" />
                <BasePlaceload class="mb-2 h-3 w-full max-w-24 rounded" />
                <div class="my-4 flex w-full flex-col items-center">
                  <BasePlaceload class="mb-2 h-2 w-full max-w-60 rounded" />
                  <BasePlaceload class="mb-2 h-2 w-full max-w-52 rounded" />
                </div>
                <div class="mb-6 flex w-full items-center justify-center">
                  <div class="px-4">
                    <BasePlaceload class="h-3 w-14 rounded" />
                  </div>
                  <div class="px-4">
                    <BasePlaceload class="h-3 w-14 rounded" />
                  </div>
                </div>
                <div class="w-full">
                  <BasePlaceload class="h-10 w-full rounded-xl" />
                  <BasePlaceload class="mx-auto mt-3 h-3 w-[7.5rem] rounded" />
                </div>
              </div>
            </div>
            <!-- Messages loop -->
            <div v-else class="space-y-12">
              <div v-if="messages.length === 0" class="flex h-[60vh] flex-col items-center justify-center text-center">
                <div class="mb-6">
                  <Icon name="ph:chat-circle-dots-duotone" class="text-primary-500 size-16" />
                </div>
                <div class="max-w-sm">
                  <h3 class="font-heading text-muted-800 text-xl font-medium leading-normal dark:text-white">
                    {{ showNoCharge ? 'دریافت اشتراک' : 'شروع گفت و گو' }}
                  </h3>
                  <p class="text-muted-400 mt-2">
                    {{ showNoCharge ? 'برای استفاده از سامانه لطفا اشتراک تهیه کنید.' : 'به چت درمانی خوش آمدید. اینجا می‌توانید با روانشناس خود گفت و گو کنید.' }}
                  </p>
                  <div class="mt-4">
                    <BaseButton
                      v-if="!showNoCharge"
                      @click="newMessage = 'سلام، من نیاز به کمک دارم.'"
                    >
                      شروع گفت و گو
                    </BaseButton>
                    <BaseButton
                      v-else
                      color="primary"
                      @click="$router.push('/onboarding')"
                    >
                      دریافت اشتراک
                    </BaseButton>
                  </div>
                </div>
              </div>
              <div
                v-else
                class="space-y-8"
              >
                <div
                  v-for="item in messages"
                  :key="item.id"
                  class="mb-4"
                >
                  <div
                    class="flex"
                    :class="[
                      item.type === 'sent' ? 'justify-end' : 'justify-start',
                    ]"
                  >
                    <div
                      class="flex max-w-[85%] flex-col"
                      :class="[
                        item.type === 'sent'
                          ? 'items-end'
                          : 'items-start',
                      ]"
                    >
                      <div
                        class="relative mb-2 flex items-center gap-3"
                        :class="[
                          item.type === 'sent'
                            ? 'flex-row-reverse'
                            : 'flex-row',
                        ]"
                      >
                        <div
                          class="flex flex-col gap-1"
                          :class="[
                            item.type === 'sent'
                              ? 'items-end'
                              : 'items-start',
                          ]"
                        >
                          <div
                            class="flex items-start gap-2"
                            :class="[
                              item.type === 'sent'
                                ? 'flex-row-reverse'
                                : 'flex-row',
                            ]"
                          >
                            <div
                              class="rounded-xl px-4 py-2"
                              :class="[
                                item.type === 'sent'
                                  ? 'bg-primary-500 prose-p:text-white text-white'
                                  : 'bg-muted-200 dark:bg-muted-700 text-muted-800 dark:text-muted-100 prose-p:text-muted-800 dark:prose-p:text-muted-100',
                              ]"
                            >
                              <span
                                class="block font-sans"
                                :class="[
                                  item.type === 'sent'
                                    ? 'prose-p:text-white text-white'
                                    : 'text-muted-800 dark:text-muted-100 prose-p:text-muted-800 dark:prose-p:text-muted-100',
                                ]"
                              >
                                <AddonMarkdownRemark :source="item.text" />
                              </span>
                            </div>
                            <!-- Detail button for sent messages -->
                            <BaseButton
                              v-if="item.type === 'sent'"
                              rounded="full"
                              title="مشاهده جزئیات"
                              size="sm"
                              color="primary"
                              @click="openMessageDetailModal(item)"
                            >
                              <Icon name="ph:magnifying-glass-duotone" class="size-4" />
                            </BaseButton>
                            <!-- Feedback button for received messages -->
                            <BaseButton
                              v-if="item.type === 'received'"
                              rounded="full"
                              title="ثبت بازخورد"
                              size="sm"
                              color="info"
                              @click="openFeedbackModal(item)"
                            >
                              <Icon name="ph:magnifying-glass-duotone" class="size-4" />
                            </BaseButton>
                            <!-- Retry button for last received message -->
                            <BaseButton
                              v-if="item.type === 'received' && item.id === [...messages].reverse().find(msg => msg.type === 'received')?.id"
                              rounded="full"
                              title="تولید پاسخ جدید"
                              size="sm"
                              color="warning"
                              :disabled="messageLoading || isAIResponding"
                              @click="confirmRetryMessage"
                            >
                              <Icon name="ph:arrow-clockwise-duotone" class="size-4" />
                            </BaseButton>
                          </div>
                          <span class="text-muted-400 font-sans text-xs">
                            {{ formatTime(item.timestamp) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Assistant thinking bubble -->
                <div v-if="isAIThinking" class="mb-4 flex justify-start">
                  <div class="flex max-w-[85%] flex-col items-start">
                    <div class="bg-muted-200 dark:bg-muted-700 text-muted-800 dark:text-muted-100 prose-p:text-muted-800 dark:prose-p:text-muted-100 rounded-xl px-4 py-2">
                      <span class="block flex items-center font-sans">
                        <AddonMarkdownRemark :source="thinkingResponse || 'در حال فکر کردن'" />
                        <span class="typing-ellipsis ml-2" />
                      </span>
                    </div>
                  </div>
                </div>
                <!-- No Charge Message -->
                <BaseMessage
                  v-if="showNoCharge"
                  id="no-money-message"
                  color="danger"
                >
                  <div class="flex items-center justify-between gap-4">
                    <div class="order-2">
                      <BaseButton
                        color="primary"
                        @click="$router.push('/onboarding')"
                      >
                        خرید اشتراک
                      </BaseButton>
                    </div>
                    <div class="order-1">
                      بسته مصرفی شما به اتمام رسیده است. لطفاً اقدام به خرید اشتراک نمایید.
                    </div>
                  </div>
                </BaseMessage>
              </div>
            </div>
          </div>

          <!-- Compose form - Fixed at bottom -->

          <form
            method="POST"
            action=""
            class="bg-muted-100 dark:bg-muted-900 absolute inset-x-0 bottom-0 w-full p-4"
            @submit.prevent="submitMessage"
          >
            <div class="relative w-full">
              <!-- Scroll to bottom button -->
              <button
                v-if="showScrollButton"
                class="bg-primary-500/20 hover:bg-primary-500/30 dark:bg-primary-500/30 dark:hover:bg-primary-500/40 absolute bottom-[calc(var(--messages-form-height))] left-0 z-10 flex items-center gap-2 rounded-full px-4 py-2 shadow-lg backdrop-blur-sm transition-all duration-300"
                title="پایین صفحه برو"
                @click="scrollToBottom"
              >
                <span class="text-primary-500 text-sm">رفتن به آخرین پیام</span>
                <Icon name="ph:arrow-down-bold" class="text-primary-500 size-5" />
              </button>
              <BaseTextarea
                v-model="newMessage"
                :disabled="showNoCharge || isAIResponding || isAIThinking"
                size="sm"
                label="پیام شما"
                rounded="md"
                :placeholder="showNoCharge ? 'بسته مصرفی شما به اتمام رسیده است' : isAIResponding || isAIThinking ? 'لطفا صبر کنید...' : 'برای ارسال از ↵ + crtl  استفاده کنید.'"
                :rows="6"
                addon
                class="dark:bg-muted-800 bg-white"
                @click="handleTextareaClick"
                @keydown="handleKeydown"
              >
                <template #addon>
                  <div class="flex items-center gap-2">
                    <BaseAvatar
                      src="/img/icons/animated/lightbulb.gif"
                      class="me-1"
                      size="xs"
                    />

                    <BaseHeading
                      as="h4"
                      size="sm"
                      weight="semibold"
                      class="text-muted-800 dark:text-white"
                    >
                      <span>درمانا</span>
                    </BaseHeading>
                  </div>

                  <div class="flex items-center gap-2">
                    <!-- Emoji Button -->
                    <div class="relative">
                      <button
                        type="button"
                        class="text-muted-400 hover:text-primary-500 flex h-12 w-10 items-center justify-center transition-colors duration-300"
                        @click.prevent="showEmojiPicker = !showEmojiPicker"
                      >
                        <Icon name="lucide:smile" class="size-5" />
                      </button>

                      <!-- Emoji Picker -->
                      <div
                        v-if="showEmojiPicker"
                        ref="emojiPickerRef"
                        class="border-muted-200 dark:border-muted-700 dark:bg-muted-800 absolute bottom-full end-0 mb-2 w-96 rounded-lg border bg-white shadow-lg"
                      >
                        <div class="border-muted-200 dark:border-muted-700 flex items-center justify-between border-b p-2">
                          <span class="text-sm font-medium">انتخاب ایموجی</span>
                          <BaseButtonIcon
                            size="xs"
                            @click="showEmojiPicker = false"
                          >
                            <Icon name="lucide:x" class="size-4" />
                          </BaseButtonIcon>
                        </div>
                        <div class="dark:bg-muted-900 border-muted-200 dark:border-muted-700 relative flex items-center overflow-hidden border-b bg-white p-2">
                          <button
                            type="button"
                            class="text-muted-600 hover:text-primary-500 p-1"
                            @click="scrollTabs('left')"
                          >
                            <Icon name="lucide:chevron-left" class="size-5" />
                          </button>
                          <div ref="tabContainerRef" class="hide-scrollbar flex flex-1 space-x-2 overflow-x-auto p-1">
                            <button
                              v-for="cat in emojiCategories"
                              :key="cat.name"
                              type="button"
                              :class="[
                                'whitespace-nowrap rounded-t-lg px-3 py-1 transition-colors duration-150',
                                currentCategory === cat.name
                                  ? 'bg-muted-100 dark:bg-muted-700 text-muted-800 border-primary-500 dark:border-primary-400 border-b-2 dark:text-white'
                                  : 'text-muted-600 dark:text-muted-400 hover:bg-muted-700 dark:hover:bg-muted-600 bg-transparent hover:text-white'
                              ]"
                              @click="currentCategory = cat.name"
                            >
                              {{ cat.name }}
                            </button>
                          </div>
                          <button
                            type="button"
                            class="text-muted-600 hover:text-primary-500 p-1"
                            @click="scrollTabs('right')"
                          >
                            <Icon name="lucide:chevron-right" class="size-5" />
                          </button>
                        </div>
                        <div class="grid grid-cols-8 gap-2 p-2">
                          <button
                            v-for="emoji in emojiCategories.find(c => c.name === currentCategory).emojis"
                            :key="emoji"
                            type="button"
                            class="hover:bg-muted-100 dark:hover:bg-muted-700 w-full cursor-pointer items-center justify-center rounded p-1 text-2xl"
                            @click="insertEmoji(emoji)"
                          >
                            {{ emoji }}
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Audio User Component -->
                    <div class="relative">
                      <button
                        type="button"
                        class="text-muted-400 hover:text-primary-500 flex h-12 w-10 items-center justify-center transition-colors duration-300"
                        @click.prevent="toggleAudioUser"
                      >
                        <Icon name="ph:microphone" class="size-5" />
                      </button>
                    </div>

                    <!-- Send Button -->
                    <button
                      type="submit"
                      :disabled="!newMessage || messageLoading"
                      class="text-muted-400 hover:text-primary-500 hover:bg-primary-500/20 flex h-12 w-10 items-center justify-center transition-colors duration-300 disabled:opacity-50"
                    >
                      <Icon name="lucide:send" class="size-5" />
                    </button>
                  </div>
                </template>
              </BaseTextarea>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Therapist details sidebar -->
    <div
      class="ltablet:w-[310px] dark:bg-muted-800 fixed end-0 top-0 z-20 h-full w-[390px] bg-white transition-transform duration-300"
      :class="expanded ? '-translate-x-full' : 'translate-x-0'"
    >
      <div class="flex h-16 w-full items-center justify-between px-8">
        <BaseHeading
          tag="h3"
          size="lg"
          class="text-muted-800 dark:text-white"
        >
          <span>اطلاعات روانشناس</span>
        </BaseHeading>
        <BaseButtonIcon small @click="expanded = true">
          <Icon
            name="lucide:arrow-left"
            class="pointer-events-none size-4"
          />
        </BaseButtonIcon>
      </div>
      <div class="relative flex w-full flex-col px-8">
        <!-- Loader -->
        <div v-if="loading" class="mt-8">
          <div class="mb-3 flex items-center justify-center">
            <BasePlaceload
              class="size-24 shrink-0 rounded-full"
              :width="96"
              :height="96"
            />
          </div>
          <div class="flex flex-col items-center">
            <BasePlaceload class="mb-2 h-3 w-full max-w-40 rounded" />
            <BasePlaceload class="mb-2 h-3 w-full max-w-24 rounded" />
            <div class="my-4 flex w-full flex-col items-center">
              <BasePlaceload class="mb-2 h-2 w-full max-w-60 rounded" />
              <BasePlaceload class="mb-2 h-2 w-full max-w-52 rounded" />
            </div>
            <div class="mb-6 flex w-full items-center justify-center">
              <div class="px-4">
                <BasePlaceload class="h-3 w-14 rounded" />
              </div>
              <div class="px-4">
                <BasePlaceload class="h-3 w-14 rounded" />
              </div>
            </div>
            <div class="w-full">
              <BasePlaceload class="h-10 w-full rounded-xl" />
              <BasePlaceload class="mx-auto mt-3 h-3 w-[7.5rem] rounded" />
            </div>
          </div>
        </div>
        <!-- User details -->
        <div v-else class="mt-8">
          <div class="flex items-center justify-center">
            <BaseAvatar
              size="2xl"
              rounded="full"
              :src="
                selectedConversationComputed?.user.avatar
                  ? `https://pocket.zehna.ir/api/files/therapists/${selectedConversationComputed.user.id}/${selectedConversationComputed.user.avatar}`
                  : '/img/avatars/1.svg'
              "
              :text="selectedConversationComputed?.user.name?.charAt(0)"
              :class="getRandomColor()"
            />
          </div>
          <div class="mt-2 space-y-3 text-center">
            <BaseHeading
              as="h3"
              size="md"
              weight="medium"
              class="text-muted-800 dark:text-white"
            >
              <span>{{ selectedConversationComputed?.user.name }}</span>
            </BaseHeading>
            <BaseParagraph size="sm" class="text-muted-400">
              <span>{{ selectedConversationComputed?.user.definingTraits }}</span>
            </BaseParagraph>

            <!-- Session Time Display -->
            <div v-if="activeSession" class="mt-4 grid grid-cols-2 gap-4">
              <div class="bg-muted-200 dark:bg-muted-800/50 rounded-xl p-4">
                <div class="mb-3 flex items-center justify-center gap-2">
                  <Icon name="ph:timer-duotone" class="text-primary-500 dark:text-primary-400 size-5" />
                  <span class="text-muted-600 dark:text-muted-300 text-sm">زمان گذشته</span>
                </div>
                <div class="flex items-baseline justify-center gap-1">
                  <span class="text-muted-800 text-2xl font-semibold dark:text-white">{{ sessionElapsedTime || 0 }}</span>
                  <span class="text-muted-500 dark:text-muted-400 text-sm">دقیقه</span>
                </div>
              </div>
              <div class="bg-muted-200 dark:bg-muted-800/50 rounded-xl p-4">
                <div class="mb-3 flex items-center justify-center gap-2">
                  <Icon name="ph:chats-circle-duotone" class="text-primary-500 dark:text-primary-400 size-5" />
                  <span class="text-muted-600 dark:text-muted-300 text-sm">پیام‌ها</span>
                </div>
                <div class="flex items-baseline justify-center gap-1">
                  <span class="text-muted-800 text-2xl font-semibold dark:text-white">{{ messages.length }}</span>
                  <span class="text-muted-500 dark:text-muted-400 text-sm">پیام</span>
                </div>
              </div>
            </div>

            <div class="my-4 space-y-2">
              <!-- Model search and selector -->
              <div v-if="!modelsError && role === 'admin'" class="relative">
                <BaseInput
                  v-model="modelSearchInput"
                  icon="ph:magnifying-glass"
                  placeholder="جست و جوی مدل های زبانی . . . "
                  class="w-full"
                  @focus="showModelDropdown = true"
                />

                <!-- Model dropdown -->
                <div
                  v-if="showModelDropdown"
                  ref="emojiPickerRef"
                  class="dark:bg-muted-800 border-muted-200 dark:border-muted-700 absolute z-50 mt-1 w-full rounded-lg border bg-white shadow-lg"
                >
                  <div class="max-h-60 overflow-y-auto p-2">
                    <button
                      v-for="model in filteredModels"
                      :key="model.id"
                      type="button"
                      class="hover:bg-muted-100 dark:hover:bg-muted-700 w-full cursor-pointer rounded p-2 text-left"
                      :class="{ 'bg-muted-100 dark:bg-muted-700': model.id === selectedModel }"
                      @click="selectedModel = model.id; showModelDropdown = false"
                    >
                      <div class="flex items-center justify-between">
                        <span class="font-medium">{{ model.name }}</span>
                        <span class="text-muted-400 text-xs">
                          {{ model.pricing.prompt }}
                        </span>
                      </div>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Selected model display -->
              <div
                v-if="selectedModel && !modelsLoading && role === 'admin'"
                class="bg-muted-100 dark:bg-muted-800 flex items-center gap-2 rounded p-2"
              >
                <Icon name="ph:robot" class="text-primary-500 size-5" />
                <span class="text-sm">
                  مدل انتخاب شده : {{ models.find(m => m.id === selectedModel)?.name }}
                </span>
              </div>

              <!-- Error state -->
              <div v-if="modelsError && role === 'admin'" class="text-center">
                <p class="text-danger-500 mb-2">
                  {{ modelsError }}
                </p>
                <BaseButton
                  color="danger"
                  :loading="modelsLoading"
                  @click="retryFetch"
                >
                  تلاش برای دریافت مدل ها
                </BaseButton>
              </div>

              <!-- Model error toast -->
              <div
                v-if="showModelError && role === 'admin'"
                class="bg-danger-500 fixed right-4 top-4 z-50 rounded px-4 py-2 text-white shadow-lg"
              >
                خطایی در پاسخ مدل رخ داد. لطفا دوباره تلاش کنید.
              </div>
            </div>

            <BaseMessage class="mt-5" color="info">
              لطفا توجه داشته باشید که عامل هوش مصنوعی در فاز توسعه می‌‌باشد
              و احتمال ارائه‌ی پاسخ‌های اشتباه را دارد.
            </BaseMessage>
            <BaseMessage class="mt-5" color="warning">
              استفاده شما از سامانه به معنای پذیرش قوانین استفاده و حریم خصوصی است.
            </BaseMessage>
            <BaseButton
              type="button"
              class="ml-3"
              color="primary"
              @click="gotoReport()"
            >
              نمایش پیشینه
              <Icon name="ph:address-book-tabs" class="mr-2 size-5" />
            </BaseButton>
            <BaseButton
              type="button"
              class="ml-3"
              color="info"
              @click="openGoalsModal()"
            >
              اهداف درمانی
              <Icon name="ph:target" class="mr-2 size-5" />
            </BaseButton>
            <BaseButton
              type="button"
              @click="expanded = true"
            >
              بستن پنل
              <Icon name="ph:arrow-left" class="mr-2 size-5" />
            </BaseButton>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio User Modal -->
    <TairoModal
      :open="showAudioUser"
      size="md"
      @close="showAudioUser = false"
    >
      <template #header>
        <div class="flex w-full items-center justify-between p-4 sm:p-5">
          <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
            تبدیل صوت به متن
          </h3>
          <BaseButtonClose @click="showAudioUser = false" />
        </div>
      </template>
      <div class="p-4 sm:p-5">
        <AudioUser
          @close="showAudioUser = false"
          @text-ready="handleAudioText"
          @send-message="handleAudioSend"
        />
      </div>
    </TairoModal>
  </div>

  <TairoModal
    :open="isDeleteModalOpen"
    size="sm"
    @close="closeDeleteModal"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
          حذف پیام‌ها
        </h3>
        <BaseButtonClose @click="closeDeleteModal" />
      </div>
    </template>

    <div class="p-4 md:p-6">
      <div class="mx-auto w-full max-w-xs text-center">
        <div class="relative mx-auto mb-4 flex size-24 justify-center">
          <Icon
            name="ph:trash-duotone"
            class="text-danger-500 size-24"
          />
        </div>

        <h3 class="font-heading text-muted-800 text-lg font-medium leading-6 dark:text-white">
          حذف تمام پیام‌ها
        </h3>

        <p class="font-alt text-muted-500 dark:text-muted-400 text-sm leading-5">
          آیا مطمئن هستید که می‌خواهید تمام پیام‌های این گفتگو را حذف کنید؟ این عمل قابل بازگشت نیست.
        </p>
      </div>
    </div>

    <template #footer>
      <div class="p-4 md:p-6">
        <div class="flex gap-x-2">
          <BaseButton @click="closeDeleteModal">
            انصراف
          </BaseButton>

          <BaseButton
            color="danger"
            variant="solid"
            @click="confirmClearChat"
          >
            حذف
          </BaseButton>
        </div>
      </div>
    </template>
  </TairoModal>

  <!-- Report Modal -->
  <TairoModal
    :open="isReportModalOpen"
    size="sm"
    @close="closeReportModal"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
          ساخت گزارش
        </h3>
        <BaseButtonClose
          v-if="!isGeneratingAnalysis"
          @click="closeReportModal"
        />
      </div>
    </template>
    <div class="relative mx-auto mb-4 flex size-24 justify-center">
      <Icon
        name="ph:clipboard-text"
        class="text-success-500 size-24"
      />
    </div>
    <div class="p-4 text-center md:p-6">
      <p> {{ isGeneratingAnalysis ? 'در حال ساخت گزارش هستیم. لطفا منتظر  بمانید. . . ' : 'آیا مایل به پایان دادن این جلسه و ساخت گزارش از این گفتگو هستید؟' }} </p>
    </div>
    <template #footer>
      <div class="flex w-full items-center justify-end gap-2 p-4 md:p-6">
        <BaseButton
          :disabled="isGeneratingAnalysis"
          @click="closeReportModal"
        >
          انصراف
        </BaseButton>
        <BaseButton
          color="success"
          variant="solid"
          :loading="isGeneratingAnalysis"
          :disabled="isGeneratingAnalysis"
          @click="handleConfirmEndSession"
        >
          تایید
        </BaseButton>
      </div>
    </template>
    <template #content>
      <div class="relative">
        <!-- Loading overlay -->
        <div v-if="isGeneratingAnalysis" class="dark:bg-muted-800/80 absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/80">
          <BaseProgress />
          <p class="text-muted-500 dark:text-muted-400 mt-4">
            در حال تحلیل جلسه و ساخت گزارش...
          </p>
        </div>

        <div class="flex flex-col gap-4">
          <!-- Existing modal content -->
        </div>
      </div>
    </template>
  </TairoModal>

  <!-- Message Detail Modal -->
  <TairoModal
    :open="isMessageDetailModalOpen"
    size="xl"
    @close="closeMessageDetailModal"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
          جزئیات پیام
        </h3>
        <BaseButtonClose @click="closeMessageDetailModal" />
      </div>
    </template>

    <div class="max-h-[70vh] overflow-y-auto p-4 md:p-6">
      <div v-if="selectedMessage" class="space-y-4">
        <!-- Message content -->
        <div class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
          <div class="mb-2 flex items-center gap-2">
            <Icon name="ph:chat-circle-duotone" class="text-primary-500 size-5" />
            <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">محتوای پیام</span>
          </div>
          <div class="prose prose-sm dark:prose-invert max-w-none text-right">
            <AddonMarkdownRemark :source="selectedMessage.text" />
          </div>
        </div>

        <!-- Message metadata -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <!-- Message ID -->
          <div class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
            <div class="mb-2 flex items-center gap-2">
              <Icon name="ph:hash-duotone" class="text-info-500 size-5" />
              <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">شناسه پیام</span>
            </div>
            <span class="text-muted-500 dark:text-muted-400 font-mono text-xs">{{ selectedMessage.id }}</span>
          </div>

          <!-- Message time -->
          <div class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
            <div class="mb-2 flex items-center gap-2">
              <Icon name="ph:clock-duotone" class="text-warning-500 size-5" />
              <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">زمان ارسال</span>
            </div>
            <span class="text-muted-700 dark:text-muted-300 text-sm">
              {{ new Date(selectedMessage.time || selectedMessage.timestamp).toLocaleString('fa') }}
            </span>
          </div>

          <!-- Message type -->
          <div class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
            <div class="mb-2 flex items-center gap-2">
              <Icon name="ph:user-duotone" class="text-success-500 size-5" />
              <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">نوع پیام</span>
            </div>
            <span class="text-muted-700 dark:text-muted-300 text-sm">
              {{ selectedMessage.type === 'sent' ? 'ارسالی (کاربر)' : 'دریافتی (روانشناس)' }}
            </span>
          </div>

          <!-- Character count -->
          <div class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
            <div class="mb-2 flex items-center gap-2">
              <Icon name="ph:text-aa-duotone" class="size-5 text-purple-500" />
              <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">تعداد کاراکتر</span>
            </div>
            <span class="text-muted-700 dark:text-muted-300 text-sm">
              {{ selectedMessage.text?.length || 0 }} کاراکتر
            </span>
          </div>
        </div>
        <!-- Emotion Wheel -->
        <div v-if="selectedMessage.analysisResult?.lastMessage_emotions" class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
          <div class="mb-4 flex items-center gap-2">
            <Icon name="ph:heart-duotone" class="size-5 text-pink-500" />
            <span class="text-muted-600 dark:text-muted-300 text-sm font-medium">حالت احساسی پیام</span>
          </div>

          <!-- Emotions Summary -->
          <div class="mb-4 grid grid-cols-1 gap-2 sm:grid-cols-2">
            <div
              v-for="emotion in selectedMessage.analysisResult.lastMessage_emotions.filter(e => e.severity !== 'خالی')"
              :key="emotion.emotionName"
              class="dark:bg-muted-700 flex items-center justify-between rounded-lg bg-white p-2"
            >
              <span class="text-sm font-medium">{{ emotion.emotionName }}</span>
              <span
                class="rounded-full px-2 py-1 text-xs"
                :class="{
                  'bg-red-100 text-red-800': emotion.severity === 'زیاد',
                  'bg-orange-100 text-orange-800': emotion.severity === 'متوسط',
                  'bg-blue-100 text-blue-800': emotion.severity === 'کم'
                }"
              >
                {{ emotion.severity }}
              </span>
            </div>
          </div>

          <!-- Corresponding Emojis -->
          <div v-if="selectedMessage.analysisResult.correspondingEmojis" class="mb-4 text-center">
            <div class="text-muted-600 dark:text-muted-300 mb-2 text-sm font-medium">
              ایموجی‌های متناظر
            </div>
            <div class="text-2xl">
              {{ selectedMessage.analysisResult.correspondingEmojis }}
            </div>
          </div>

          <!-- Emotion Wheel Visualization -->
          <div class="mb-4">
            <div class="text-muted-600 dark:text-muted-300 mb-2 text-sm font-medium">
              چرخه احساسات
            </div>
            <EmotionWheel :model-value="selectedMessageEmotions" lang="pes" />
          </div>

          <!-- Emotional Response -->
          <div v-if="selectedMessage.analysisResult.emotionalResponse" class="rounded-lg bg-blue-50 p-3 dark:bg-blue-900/20">
            <div class="mb-2 flex items-center gap-2">
              <Icon name="ph:lightbulb-duotone" class="size-4 text-blue-500" />
              <span class="text-sm font-medium text-blue-700 dark:text-blue-300">پاسخ پیشنهادی</span>
            </div>
            <p class="text-right text-sm text-blue-600 dark:text-blue-400">
              {{ selectedMessage.analysisResult.emotionalResponse }}
            </p>
          </div>
        </div>

        <!-- No Analysis Available -->
        <div v-else class="bg-muted-100 dark:bg-muted-800 rounded-xl p-4">
          <div class="text-muted-500 dark:text-muted-400 text-center">
            <Icon name="ph:chart-line-duotone" class="mx-auto mb-2 size-12 opacity-50" />
            <p class="text-sm">
              تحلیل احساسات برای این پیام در دسترس نیست
            </p>
          </div>
        </div>
      </div>
    </div>

    <template #footer>
      <div class="p-4 md:p-6">
        <div class="flex justify-end">
          <BaseButton @click="closeMessageDetailModal">
            بستن
          </BaseButton>
        </div>
      </div>
    </template>
  </TairoModal>

  <!-- Message Feedback Modal -->
  <TairoModal
    :open="isFeedbackModalOpen"
    size="xl"
    @close="closeFeedbackModal"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <div class="flex items-center gap-3">
          <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
            {{ existingFeedback ? 'ویرایش بازخورد' : 'بازخورد پیام' }}
          </h3>
          <BaseTag
            v-if="existingFeedback"
            color="info"
            size="sm"
          >
            ویرایش
          </BaseTag>
        </div>
        <div class="flex items-center gap-3">
          <!-- Step indicator -->
          <div class="flex items-center gap-2">
            <div
              v-for="step in 3"
              :key="step"
              class="h-2 w-8 rounded-full transition-all duration-200"
              :class="step === feedbackStep ? 'bg-primary-500' : step < feedbackStep ? 'bg-success-500' : 'bg-muted-300'"
            />
          </div>
          <BaseButtonClose @click="closeFeedbackModal" />
        </div>
      </div>
    </template>

    <div ref="feedbackModalContent" class="max-h-[75vh] overflow-y-auto p-4 md:p-6">
      <div v-if="selectedMessageForFeedback">
        <!-- Errors display -->
        <BaseMessage
          v-if="feedbackErrors.length > 0"
          class="mb-6"
          color="danger"
        >
          <div class="space-y-1">
            <div class="font-medium">
              لطفا موارد زیر را بررسی کنید:
            </div>
            <ul class="text-sm">
              <li
                v-for="error in feedbackErrors"
                :key="error"
                class="flex items-center gap-2"
              >
                <Icon name="ph:warning-circle-fill" class="size-4" />
                {{ error }}
              </li>
            </ul>
          </div>
        </BaseMessage>

        <!-- Step 1: Message Display and Category Selection -->
        <div v-if="feedbackStep === 1" class="space-y-8">
          <!-- Message content -->
          <div class="from-primary-50 to-info-50 dark:from-primary-900/20 dark:to-info-900/20 mb-6 rounded-xl bg-gradient-to-r p-4">
            <div class="mb-3 flex items-center gap-2">
              <Icon name="ph:chat-circle-duotone" class="text-primary-500 size-5" />
              <span class="text-primary-700 dark:text-primary-300 text-sm font-medium">پیام روانشناس</span>
            </div>
            <div class="prose prose-sm dark:prose-invert dark:bg-muted-800 max-h-60 max-w-none overflow-y-auto rounded-lg bg-white p-3 text-right">
              <AddonMarkdownRemark :source="selectedMessageForFeedback.text" />
            </div>
          </div>

          <div class="mb-8 text-center">
            <div class="from-primary-100 to-info-100 dark:from-primary-900/30 dark:to-info-900/30 mb-4 inline-flex size-16 items-center justify-center rounded-full bg-gradient-to-br">
              <Icon name="ph:star-duotone" class="text-primary-600 dark:text-primary-400 size-8" />
            </div>
            <h4 class="text-muted-800 text-xl font-bold dark:text-white">
              ارزیابی کلی
            </h4>
            <p class="text-muted-500 mt-2 text-sm">
              ابتدا امتیاز کلی و نوع بازخورد خود را انتخاب کنید
            </p>
          </div>

          <!-- Rating -->
          <div class="space-y-4 text-right">
            <label class="text-muted-700 dark:text-muted-300 block text-sm font-medium">
              امتیاز کلی <span class="text-danger-500">*</span>
            </label>
            <div class="bg-muted-50 dark:bg-muted-800 flex items-center justify-center gap-3 rounded-xl p-4">
              <span class="text-muted-600 text-sm">ضعیف</span>
              <div class="flex gap-2">
                <button
                  v-for="star in 5"
                  :key="star"
                  type="button"
                  class="transition-all duration-200 hover:scale-110"
                  :class="star <= feedbackForm.rating ? 'text-yellow-400 drop-shadow-sm' : 'text-muted-300 hover:text-yellow-300'"
                  @click="feedbackForm.rating = star"
                >
                  <Icon name="ph:star-fill" class="size-8" />
                </button>
              </div>
              <span class="text-muted-600 text-sm">عالی</span>
            </div>
            <div v-if="feedbackForm.rating > 0" class="text-center">
              <span class="text-primary-600 dark:text-primary-400 text-sm">
                امتیاز شما: {{ feedbackForm.rating }} از 5
              </span>
            </div>
          </div>

          <!-- Feedback Type Selection -->
          <div class="space-y-6 text-right">
            <div class="mb-6 text-center">
              <h5 class="text-muted-800 mb-2 text-lg font-bold dark:text-white">
                نوع بازخورد
              </h5>
              <p class="text-muted-500 text-sm">
                کدام جنبه را می‌خواهید ارزیابی کنید؟
              </p>
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <!-- Problems Selection -->
              <button
                type="button"
                class="focus:ring-primary-500/20 group relative rounded-xl border-2 p-6 transition-all duration-300 hover:scale-[1.02] focus:outline-none focus:ring-4"
                :class="selectedFeedbackType === 'problems'
                  ? 'border-danger-500 bg-gradient-to-br from-danger-50 to-red-50 dark:from-danger-900/20 dark:to-red-900/20 shadow-lg shadow-danger-500/10'
                  : 'border-muted-200 dark:border-muted-700 bg-white dark:bg-muted-800 hover:border-danger-300 hover:shadow-md'"
                @click="selectedFeedbackType = 'problems'"
              >
                <div class="mb-3 flex items-center justify-center">
                  <div
                    class="flex size-12 items-center justify-center rounded-full transition-all duration-300"
                    :class="selectedFeedbackType === 'problems'
                      ? 'bg-danger-100 dark:bg-danger-900/40'
                      : 'bg-muted-100 dark:bg-muted-700 group-hover:bg-danger-50'"
                  >
                    <Icon
                      name="ph:warning-duotone"
                      :class="selectedFeedbackType === 'problems'
                        ? 'text-danger-600 dark:text-danger-400'
                        : 'text-muted-500 group-hover:text-danger-500'"
                      class="size-6"
                    />
                  </div>
                </div>
                <h6
                  class="mb-2 font-bold"
                  :class="selectedFeedbackType === 'problems'
                    ? 'text-danger-700 dark:text-danger-300'
                    : 'text-muted-800 dark:text-white group-hover:text-danger-600'"
                >
                  مشکلات موجود
                </h6>
                <p
                  class="text-sm"
                  :class="selectedFeedbackType === 'problems'
                    ? 'text-danger-600 dark:text-danger-400'
                    : 'text-muted-500 group-hover:text-danger-500'"
                >
                  اگر مشکلی در پاسخ دیدید
                </p>
              </button>

              <!-- Quality Selection -->
              <button
                type="button"
                class="focus:ring-primary-500/20 group relative rounded-xl border-2 p-6 transition-all duration-300 hover:scale-[1.02] focus:outline-none focus:ring-4"
                :class="selectedFeedbackType === 'quality'
                  ? 'border-success-500 bg-gradient-to-br from-success-50 to-emerald-50 dark:from-success-900/20 dark:to-emerald-900/20 shadow-lg shadow-success-500/10'
                  : 'border-muted-200 dark:border-muted-700 bg-white dark:bg-muted-800 hover:border-success-300 hover:shadow-md'"
                @click="selectedFeedbackType = 'quality'"
              >
                <div class="mb-3 flex items-center justify-center">
                  <div
                    class="flex size-12 items-center justify-center rounded-full transition-all duration-300"
                    :class="selectedFeedbackType === 'quality'
                      ? 'bg-success-100 dark:bg-success-900/40'
                      : 'bg-muted-100 dark:bg-muted-700 group-hover:bg-success-50'"
                  >
                    <Icon
                      name="ph:heart-duotone"
                      :class="selectedFeedbackType === 'quality'
                        ? 'text-success-600 dark:text-success-400'
                        : 'text-muted-500 group-hover:text-success-500'"
                      class="size-6"
                    />
                  </div>
                </div>
                <h6
                  class="mb-2 font-bold"
                  :class="selectedFeedbackType === 'quality'
                    ? 'text-success-700 dark:text-success-300'
                    : 'text-muted-800 dark:text-white group-hover:text-success-600'"
                >
                  نقاط قوت پاسخ
                </h6>
                <p
                  class="text-sm"
                  :class="selectedFeedbackType === 'quality'
                    ? 'text-success-600 dark:text-success-400'
                    : 'text-muted-500 group-hover:text-success-500'"
                >
                  نقاط مثبت و قوت‌های پاسخ
                </p>
              </button>
            </div>
          </div>

          <!-- General feedback -->
          <div class="space-y-3 text-right">
            <label class="text-muted-700 dark:text-muted-300 block text-sm font-medium">
              نظر کلی <span class="text-danger-500">*</span>
            </label>
            <BaseTextarea
              v-model="feedbackForm.general_text"
              placeholder="لطفا نظر کلی خود را درباره این پاسخ بنویسید... (حداقل 10 کاراکتر)"
              :rows="4"
              size="lg"
            />
            <div class="text-muted-400 text-right text-xs">
              {{ feedbackForm.general_text.length }} کاراکتر
            </div>
          </div>

          <!-- Additional comments -->
          <div class="space-y-3 text-right">
            <label class="text-muted-700 dark:text-muted-300 block text-sm font-medium">توضیحات اضافی</label>
            <BaseTextarea
              v-model="feedbackForm.general_other"
              placeholder="اگر توضیح بیشتری دارید، اینجا بنویسید... (اختیاری)"
              :rows="3"
            />
          </div>
        </div>

        <!-- Step 2: Selected Category Details -->
        <div v-if="feedbackStep === 2" class="space-y-8">
          <div class="mb-6 text-center">
            <div
              class="mb-4 inline-flex size-16 items-center justify-center rounded-full"
              :class="selectedFeedbackType === 'problems'
                ? 'bg-danger-100 dark:bg-danger-900/30'
                : 'bg-success-100 dark:bg-success-900/30'"
            >
              <Icon
                :name="selectedFeedbackType === 'problems' ? 'ph:warning-duotone' : 'ph:heart-duotone'"
                :class="selectedFeedbackType === 'problems'
                  ? 'text-danger-600 dark:text-danger-400'
                  : 'text-success-600 dark:text-success-400'"
                class="size-8"
              />
            </div>
            <h4 class="text-muted-800 text-xl font-bold dark:text-white">
              {{ selectedFeedbackType === 'problems' ? 'مشکلات موجود' : 'نقاط قوت پاسخ' }}
            </h4>
            <p class="text-muted-500 mt-2 text-sm">
              {{ selectedFeedbackType === 'problems'
                ? 'مشکلات موجود در پاسخ را مشخص کنید'
                : 'نقاط قوت و مثبت پاسخ را انتخاب کنید' }}
            </p>
          </div>

          <!-- Problems Section -->
          <div v-if="selectedFeedbackType === 'problems'" class="from-danger-25 to-orange-25 dark:from-danger-950/20 space-y-5 rounded-2xl bg-gradient-to-br p-6 dark:to-orange-950/20">
            <div class="mb-4 flex items-center gap-3">
              <div class="bg-danger-100 dark:bg-danger-900/30 flex size-10 items-center justify-center rounded-xl">
                <Icon name="ph:warning-duotone" class="text-danger-600 dark:text-danger-400 size-5" />
              </div>
              <div>
                <label class="text-danger-800 dark:text-danger-200 block text-right text-base font-bold">مشکلات موجود</label>
                <p class="text-danger-600 dark:text-danger-300 text-sm">
                  در صورت وجود مشکل، انتخاب کنید
                </p>
              </div>
              <div class="ml-auto">
                <div class="text-danger-600 dark:text-danger-400 bg-danger-100 dark:bg-danger-900/40 rounded-full px-2 py-1 text-xs">
                  {{ Object.keys(feedbackForm.problems_categories).filter(k => feedbackForm.problems_categories[k]).length }} انتخاب شده
                </div>
              </div>
            </div>

            <!-- Problem categories with enhanced design -->
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div
                v-for="problem in FEEDBACK_CATEGORIES.problems.subcategories"
                :key="problem.id"
                class="group relative"
              >
                <button
                  type="button"
                  class="relative w-full overflow-hidden rounded-xl border-2 p-4 text-right transition-all duration-300 hover:scale-[1.02] hover:shadow-lg"
                  :class="feedbackForm.problems_categories[problem.id]
                    ? 'border-danger-400 bg-gradient-to-br from-danger-50 to-red-50 text-danger-800 dark:from-danger-900/30 dark:to-red-900/30 dark:text-danger-200 shadow-lg shadow-danger-100/50'
                    : 'border-muted-200 bg-white dark:bg-muted-800 hover:border-danger-300 dark:border-muted-600 hover:bg-danger-25 dark:hover:bg-danger-950/10'"
                  @click="feedbackForm.problems_categories[problem.id] = !feedbackForm.problems_categories[problem.id]"
                >
                  <!-- Severity indicator -->
                  <div
                    v-if="problem.severity"
                    class="absolute left-2 top-2 size-2 rounded-full"
                    :class="{
                      'bg-red-500': problem.severity === 'critical',
                      'bg-orange-500': problem.severity === 'high',
                      'bg-yellow-500': problem.severity === 'medium',
                      'bg-blue-500': problem.severity === 'low'
                    }"
                  />

                  <div class="mb-2 flex items-start justify-between">
                    <div class="flex items-center gap-2">
                      <Icon :name="problem.icon || 'ph:warning-duotone'" class="size-5 opacity-75" />
                      <span class="font-semibold">{{ problem.name }}</span>
                    </div>
                    <Icon
                      v-if="feedbackForm.problems_categories[problem.id]"
                      name="ph:check-circle-fill"
                      class="text-danger-500 animate-in zoom-in size-6 duration-200"
                    />
                    <div v-else class="border-muted-300 group-hover:border-danger-400 size-6 rounded-full border-2 transition-colors" />
                  </div>

                  <p class="mb-3 text-sm leading-relaxed opacity-90">
                    {{ problem.description }}
                  </p>

                  <!-- Examples (show on hover or when selected) -->
                  <div
                    v-if="problem.examples && (feedbackForm.problems_categories[problem.id] || false)"
                    class="dark:bg-muted-700/50 space-y-1 rounded-lg bg-white/50 p-2 text-xs"
                  >
                    <div class="font-medium opacity-75">
                      مثال:
                    </div>
                    <ul class="space-y-1">
                      <li
                        v-for="example in problem.examples"
                        :key="example"
                        class="flex items-start gap-1"
                      >
                        <span class="text-danger-400 mt-0.5">•</span>
                        <span class="opacity-80">{{ example }}</span>
                      </li>
                    </ul>
                  </div>
                </button>
              </div>
            </div>

            <!-- Custom problem input -->
            <div class="mt-6">
              <label class="text-danger-700 dark:text-danger-300 mb-2 block text-right text-sm font-medium">
                توضیح بیشتر یا مشکل دیگری؟
              </label>
              <BaseTextarea
                v-model="feedbackForm.problems_other"
                placeholder="اگر مشکل خاصی وجود دارد که در فهرست نیست، لطفاً توضیح دهید..."
                :rows="3"
                size="lg"
                class="!border-danger-200 focus:!border-danger-400 dark:!border-danger-800"
              />
            </div>
          </div>

          <!-- Quality Section -->
          <div v-if="selectedFeedbackType === 'quality'" class="from-success-25 to-emerald-25 dark:from-success-950/20 space-y-5 rounded-2xl bg-gradient-to-br p-6 dark:to-emerald-950/20">
            <div class="mb-4 flex items-center gap-3">
              <div class="bg-success-100 dark:bg-success-900/30 flex size-10 items-center justify-center rounded-xl">
                <Icon name="ph:heart-duotone" class="text-success-600 dark:text-success-400 size-5" />
              </div>
              <div>
                <label class="text-success-800 dark:text-success-200 block text-right text-base font-bold">نقاط قوت پاسخ</label>
                <p class="text-success-600 dark:text-success-300 text-sm">
                  مواردی که در پاسخ خوب بود
                </p>
              </div>
              <div class="ml-auto">
                <div class="text-success-600 dark:text-success-400 bg-success-100 dark:bg-success-900/40 rounded-full px-2 py-1 text-xs">
                  {{ Object.keys(feedbackForm.quality_categories).filter(k => feedbackForm.quality_categories[k]).length }} انتخاب شده
                </div>
              </div>
            </div>

            <!-- Quality categories with enhanced design -->
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div
                v-for="quality in FEEDBACK_CATEGORIES.quality.subcategories"
                :key="quality.id"
                class="group relative"
              >
                <button
                  type="button"
                  class="relative w-full overflow-hidden rounded-xl border-2 p-4 text-right transition-all duration-300 hover:scale-[1.02] hover:shadow-lg"
                  :class="feedbackForm.quality_categories[quality.id]
                    ? 'border-success-400 bg-gradient-to-br from-success-50 to-emerald-50 text-success-800 dark:from-success-900/30 dark:to-emerald-900/30 dark:text-success-200 shadow-lg shadow-success-100/50'
                    : 'border-muted-200 bg-white dark:bg-muted-800 hover:border-success-300 dark:border-muted-600 hover:bg-success-25 dark:hover:bg-success-950/10'"
                  @click="feedbackForm.quality_categories[quality.id] = !feedbackForm.quality_categories[quality.id]"
                >
                  <!-- Impact indicator -->
                  <div
                    v-if="quality.impact"
                    class="absolute left-2 top-2 size-2 rounded-full"
                    :class="{
                      'bg-emerald-500': quality.impact === 'high',
                      'bg-green-500': quality.impact === 'medium',
                      'bg-lime-500': quality.impact === 'low'
                    }"
                  />

                  <div class="mb-2 flex items-start justify-between">
                    <div class="flex items-center gap-2">
                      <Icon :name="quality.icon || 'ph:heart-duotone'" class="size-5 opacity-75" />
                      <span class="font-semibold">{{ quality.name }}</span>
                    </div>
                    <Icon
                      v-if="feedbackForm.quality_categories[quality.id]"
                      name="ph:check-circle-fill"
                      class="text-success-500 animate-in zoom-in size-6 duration-200"
                    />
                    <div v-else class="border-muted-300 group-hover:border-success-400 size-6 rounded-full border-2 transition-colors" />
                  </div>

                  <p class="mb-3 text-sm leading-relaxed opacity-90">
                    {{ quality.description }}
                  </p>

                  <!-- Examples -->
                  <div
                    v-if="quality.examples && (feedbackForm.quality_categories[quality.id] || false)"
                    class="dark:bg-muted-700/50 space-y-1 rounded-lg bg-white/50 p-2 text-xs"
                  >
                    <div class="font-medium opacity-75">
                      مثال:
                    </div>
                    <ul class="space-y-1">
                      <li
                        v-for="example in quality.examples"
                        :key="example"
                        class="flex items-start gap-1"
                      >
                        <span class="text-success-400 mt-0.5">•</span>
                        <span class="opacity-80">{{ example }}</span>
                      </li>
                    </ul>
                  </div>
                </button>
              </div>
            </div>

            <!-- Custom quality input -->
            <div class="mt-6">
              <label class="text-success-700 dark:text-success-300 mb-2 block text-right text-sm font-medium">
                نقاط قوت دیگر؟
              </label>
              <BaseTextarea
                v-model="feedbackForm.quality_other"
                placeholder="چه چیز دیگری در این پاسخ خوب بود؟ لطفاً توضیح دهید..."
                :rows="3"
                size="lg"
                class="!border-success-200 focus:!border-success-400 dark:!border-success-800"
              />
            </div>
          </div>

          <!-- Progress indicator -->
          <div class="mt-8 flex items-center justify-center gap-2">
            <div class="text-muted-600 flex items-center gap-1 text-xs">
              <Icon name="ph:info-duotone" class="size-4" />
              <span>انتخاب هیچ‌کدام از گزینه‌ها اختیاری است</span>
            </div>
          </div>
        </div>

        <!-- Step 3: Improvements -->
        <div v-if="feedbackStep === 3" class="space-y-8">
          <div class="mb-8 text-center">
            <div class="from-warning-100 dark:from-warning-900/30 mb-4 inline-flex size-16 items-center justify-center rounded-full bg-gradient-to-br to-amber-100 dark:to-amber-900/30">
              <Icon name="ph:lightbulb-duotone" class="text-warning-600 dark:text-warning-400 size-8" />
            </div>
            <h4 class="text-muted-800 text-xl font-bold dark:text-white">
              پیشنهادات بهبود
            </h4>
            <p class="text-muted-500 mt-2 text-sm">
              چگونه می‌توان پاسخ‌ها را بهتر کرد؟
            </p>
            <div class="bg-warning-100 dark:bg-warning-900/30 text-warning-700 dark:text-warning-300 mt-4 inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs">
              <Icon name="ph:rocket-duotone" class="size-4" />
              <span>ایده‌های شما برای بهبود</span>
            </div>
          </div>

          <!-- Improvements Section -->
          <div class="from-warning-25 to-amber-25 dark:from-warning-950/20 space-y-6 rounded-2xl bg-gradient-to-br p-6 dark:to-amber-950/20">
            <div class="mb-6 flex items-center gap-3">
              <div class="bg-warning-100 dark:bg-warning-900/30 flex size-10 items-center justify-center rounded-xl">
                <Icon name="ph:lightbulb-duotone" class="text-warning-600 dark:text-warning-400 size-5" />
              </div>
              <div>
                <label class="text-warning-800 dark:text-warning-200 block text-base font-bold">پیشنهادات شما</label>
                <p class="text-warning-600 dark:text-warning-300 text-sm">
                  چه چیزی می‌تواند بهتر باشد؟
                </p>
              </div>
              <div class="ml-auto">
                <div class="text-warning-600 dark:text-warning-400 bg-warning-100 dark:bg-warning-900/40 rounded-full px-2 py-1 text-xs">
                  {{ Object.keys(feedbackForm.improvements_categories).filter(k => feedbackForm.improvements_categories[k]).length }} انتخاب شده
                </div>
              </div>
            </div>

            <!-- Improvements grid with enhanced design -->
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div
                v-for="improvement in FEEDBACK_CATEGORIES.improvements.subcategories"
                :key="improvement.id"
                class="group relative"
              >
                <button
                  type="button"
                  class="relative w-full overflow-hidden rounded-xl border-2 p-4 text-right transition-all duration-300 hover:scale-[1.02] hover:shadow-lg"
                  :class="feedbackForm.improvements_categories[improvement.id]
                    ? 'border-warning-400 bg-gradient-to-br from-warning-50 to-amber-50 text-warning-800 dark:from-warning-900/30 dark:to-amber-900/30 dark:text-warning-200 shadow-lg shadow-warning-100/50'
                    : 'border-muted-200 bg-white dark:bg-muted-800 hover:border-warning-300 dark:border-muted-600 hover:bg-warning-25 dark:hover:bg-warning-950/10'"
                  @click="feedbackForm.improvements_categories[improvement.id] = !feedbackForm.improvements_categories[improvement.id]"
                >
                  <!-- Priority indicator -->
                  <div
                    v-if="improvement.priority"
                    class="absolute left-2 top-2 size-2 rounded-full"
                    :class="{
                      'bg-red-400': improvement.priority === 'high',
                      'bg-yellow-400': improvement.priority === 'medium',
                      'bg-blue-400': improvement.priority === 'low'
                    }"
                  />

                  <div class="mb-2 flex items-start justify-between">
                    <div class="flex items-center gap-2">
                      <Icon :name="improvement.icon || 'ph:lightbulb-duotone'" class="size-5 opacity-75" />
                      <span class="font-semibold">{{ improvement.name }}</span>
                    </div>
                    <Icon
                      v-if="feedbackForm.improvements_categories[improvement.id]"
                      name="ph:check-circle-fill"
                      class="text-warning-500 animate-in zoom-in size-6 duration-200"
                    />
                    <div v-else class="border-muted-300 group-hover:border-warning-400 size-6 rounded-full border-2 transition-colors" />
                  </div>

                  <p class="mb-3 text-sm leading-relaxed opacity-90">
                    {{ improvement.description }}
                  </p>

                  <!-- Examples -->
                  <div
                    v-if="improvement.examples && (feedbackForm.improvements_categories[improvement.id] || false)"
                    class="dark:bg-muted-700/50 space-y-1 rounded-lg bg-white/50 p-2 text-xs"
                  >
                    <div class="font-medium opacity-75">
                      مثال:
                    </div>
                    <ul class="space-y-1">
                      <li
                        v-for="example in improvement.examples"
                        :key="example"
                        class="flex items-start gap-1"
                      >
                        <span class="text-warning-400 mt-0.5">•</span>
                        <span class="opacity-80">{{ example }}</span>
                      </li>
                    </ul>
                  </div>
                </button>
              </div>
            </div>

            <!-- Custom improvement input with enhanced design -->
            <div class="dark:bg-muted-800/50 mt-8 rounded-xl bg-white/50 p-5">
              <label class="text-warning-700 dark:text-warning-300 mb-3 block flex items-center gap-2 text-sm font-semibold">
                <Icon name="ph:chat-circle-text-duotone" class="size-4" />
                پیشنهاد خاص شما
              </label>
              <BaseTextarea
                v-model="feedbackForm.improvements_other"
                placeholder="ایده‌های شما برای بهبود پاسخ‌ها چیست؟ چه چیزی می‌تواند تجربه را بهتر کند؟"
                :rows="4"
                size="lg"
                class="!border-warning-200 focus:!border-warning-400 dark:!border-warning-800"
              />
              <div class="text-warning-600 dark:text-warning-400 mt-2 text-xs opacity-75">
                هر ایده‌ای که دارید، هر کوچک که باشد، برای ما ارزشمند است! ✨
              </div>
            </div>
          </div>

          <!-- Enhanced Summary Section -->
          <div class="from-info-50 via-blue-25 dark:from-info-950/20 border-info-200/50 dark:border-info-800/30 rounded-2xl border bg-gradient-to-br to-indigo-50 p-6 dark:via-blue-950/10 dark:to-indigo-950/20">
            <div class="mb-6 flex items-center gap-3">
              <div class="from-info-100 dark:from-info-900/50 flex size-12 items-center justify-center rounded-xl bg-gradient-to-br to-blue-100 dark:to-blue-900/50">
                <Icon name="ph:clipboard-text-duotone" class="text-info-600 dark:text-info-400 size-6" />
              </div>
              <div>
                <h5 class="text-info-800 dark:text-info-200 text-lg font-bold">
                  خلاصه بازخورد شما
                </h5>
                <p class="text-info-600 dark:text-info-300 text-sm">
                  مرور نهایی قبل از ارسال
                </p>
              </div>
            </div>

            <div class="grid gap-4">
              <!-- Rating Summary -->
              <div class="dark:bg-muted-800/70 rounded-xl bg-white/70 p-4">
                <div class="flex items-center justify-between">
                  <span class="text-muted-700 dark:text-muted-300 font-medium">امتیاز کلی:</span>
                  <div class="flex items-center gap-2">
                    <div class="flex">
                      <Icon
                        v-for="star in 5"
                        :key="star"
                        name="ph:star-fill"
                        class="size-5"
                        :class="star <= feedbackForm.rating ? 'text-yellow-400' : 'text-muted-300'"
                      />
                    </div>
                    <span class="text-primary-600 dark:text-primary-400 text-lg font-bold">
                      {{ feedbackForm.rating }}/5
                    </span>
                  </div>
                </div>
              </div>

              <!-- Categories Summary -->
              <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
                <!-- Problems -->
                <div class="dark:bg-muted-800/70 rounded-lg bg-white/70 p-3">
                  <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <Icon name="ph:warning-duotone" class="text-danger-500 size-4" />
                      <span class="text-danger-700 dark:text-danger-300 text-sm font-medium">مشکلات</span>
                    </div>
                    <span class="bg-danger-100 dark:bg-danger-900/40 text-danger-600 dark:text-danger-400 rounded-full px-2 py-0.5 text-xs">
                      {{ Object.keys(feedbackForm.problems_categories).filter(k => feedbackForm.problems_categories[k]).length }}
                    </span>
                  </div>
                  <div class="space-y-1 text-xs">
                    <div
                      v-for="(selected, key) in feedbackForm.problems_categories"
                      v-if="selected"
                      :key="key"
                      class="text-danger-600 dark:text-danger-400 flex items-center gap-1"
                    >
                      <span>•</span>
                      <span>{{ FEEDBACK_CATEGORIES.problems.subcategories.find(p => p.id === key)?.name }}</span>
                    </div>
                  </div>
                </div>

                <!-- Quality -->
                <div class="dark:bg-muted-800/70 rounded-lg bg-white/70 p-3">
                  <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <Icon name="ph:heart-duotone" class="text-success-500 size-4" />
                      <span class="text-success-700 dark:text-success-300 text-sm font-medium">نقاط قوت</span>
                    </div>
                    <span class="bg-success-100 dark:bg-success-900/40 text-success-600 dark:text-success-400 rounded-full px-2 py-0.5 text-xs">
                      {{ Object.keys(feedbackForm.quality_categories).filter(k => feedbackForm.quality_categories[k]).length }}
                    </span>
                  </div>
                  <div class="space-y-1 text-xs">
                    <div
                      v-for="(selected, key) in feedbackForm.quality_categories"
                      v-if="selected"
                      :key="key"
                      class="text-success-600 dark:text-success-400 flex items-center gap-1"
                    >
                      <span>•</span>
                      <span>{{ FEEDBACK_CATEGORIES.quality.subcategories.find(q => q.id === key)?.name }}</span>
                    </div>
                  </div>
                </div>

                <!-- Improvements -->
                <div class="dark:bg-muted-800/70 rounded-lg bg-white/70 p-3">
                  <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <Icon name="ph:lightbulb-duotone" class="text-warning-500 size-4" />
                      <span class="text-warning-700 dark:text-warning-300 text-sm font-medium">پیشنهادات</span>
                    </div>
                    <span class="bg-warning-100 dark:bg-warning-900/40 text-warning-600 dark:text-warning-400 rounded-full px-2 py-0.5 text-xs">
                      {{ Object.keys(feedbackForm.improvements_categories).filter(k => feedbackForm.improvements_categories[k]).length }}
                    </span>
                  </div>
                  <div class="space-y-1 text-xs">
                    <div
                      v-for="(selected, key) in feedbackForm.improvements_categories"
                      v-if="selected"
                      :key="key"
                      class="text-warning-600 dark:text-warning-400 flex items-center gap-1"
                    >
                      <span>•</span>
                      <span>{{ FEEDBACK_CATEGORIES.improvements.subcategories.find(i => i.id === key)?.name }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Custom Comments Summary -->
              <div v-if="feedbackForm.general_text?.trim() || feedbackForm.problems_other?.trim() || feedbackForm.quality_other?.trim() || feedbackForm.improvements_other?.trim()" class="dark:bg-muted-800/70 rounded-xl bg-white/70 p-4">
                <h6 class="text-muted-700 dark:text-muted-300 mb-3 flex items-center gap-2 font-medium">
                  <Icon name="ph:chat-circle-text-duotone" class="size-4" />
                  نظرات تفصیلی
                </h6>
                <div class="space-y-2 text-sm">
                  <div v-if="feedbackForm.general_text?.trim()">
                    <span class="text-primary-600 text-right font-medium">نظر کلی:</span>
                    <p class="text-muted-600 dark:text-muted-400 mt-1 text-xs italic">
                      {{ feedbackForm.general_text }}
                    </p>
                  </div>
                  <div v-if="feedbackForm.improvements_other?.trim()">
                    <span class="text-warning-600 font-medium">پیشنهادات:</span>
                    <p class="text-muted-600 dark:text-muted-400 mt-1 text-xs italic">
                      {{ feedbackForm.improvements_other }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Final message -->
            <div class="mt-6 text-center">
              <div class="text-info-700 dark:text-info-300 bg-info-100/50 dark:bg-info-900/30 inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm">
                <Icon name="ph:heart-duotone" class="size-4" />
                <span>ممنون از وقتی که برای بازخورد گذاشتید! 🙏</span>
              </div>
            </div>
          </div>

          <!-- Progress hint -->
          <div class="flex items-center justify-center gap-2">
            <div class="text-muted-600 flex items-center gap-1 text-xs">
              <Icon name="ph:check-circle-duotone" class="text-success-500 size-4" />
              <span>آماده برای ارسال بازخورد</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <template #footer>
      <div class="p-4 md:p-6">
        <div class="flex justify-between">
          <div>
            <BaseButton
              v-if="feedbackStep > 1"
              variant="outline"
              @click="prevFeedbackStep"
            >
              <Icon name="ph:arrow-right" class="ml-1 size-4" />
              قبلی
            </BaseButton>
          </div>
          <div class="flex gap-2">
            <BaseButton
              :disabled="isSubmittingFeedback"
              @click="closeFeedbackModal"
            >
              انصراف
            </BaseButton>
            <BaseButton
              v-if="feedbackStep < 3"
              color="primary"
              @click="nextFeedbackStep"
            >
              بعدی
              <Icon name="ph:arrow-left" class="mr-1 size-4" />
            </BaseButton>
            <BaseButton
              v-else
              color="success"
              :loading="isSubmittingFeedback"
              :disabled="isSubmittingFeedback || feedbackForm.rating === 0"
              @click="submitMessageFeedback"
            >
              <Icon name="ph:check" class="ml-1 size-4" />
              {{ existingFeedback ? 'به‌روزرسانی' : 'ثبت بازخورد' }}
            </BaseButton>
          </div>
        </div>
      </div>
    </template>
  </TairoModal>

  <!-- Retry Confirmation Modal -->
  <TairoModal
    :open="showRetryConfirm"
    size="sm"
    @close="cancelRetry"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
          تولید پاسخ جدید
        </h3>
        <BaseButtonClose @click="cancelRetry" />
      </div>
    </template>

    <div class="p-4 md:p-6">
      <div class="mx-auto w-full max-w-xs text-center">
        <div class="relative mx-auto mb-4 flex size-24 justify-center">
          <Icon
            name="ph:arrow-clockwise-duotone"
            class="text-warning-500 size-24"
          />
        </div>

        <h3 class="font-heading text-muted-800 text-lg font-medium leading-6 dark:text-white">
          تولید پاسخ جدید؟
        </h3>

        <p class="font-alt text-muted-500 dark:text-muted-400 mt-2 text-sm leading-5">
          پاسخ فعلی روانشناس حذف شده و پاسخ جدیدی تولید می‌شود. این عمل قابل بازگشت نیست.
        </p>

        <BaseMessage color="warning" class="mt-4 text-xs">
          <div class="flex items-center gap-2">
            <Icon name="ph:info-duotone" class="size-4" />
            <span>تولید پاسخ جدید ممکن است چند ثانیه طول بکشد.</span>
          </div>
        </BaseMessage>
      </div>
    </div>

    <template #footer>
      <div class="p-4 md:p-6">
        <div class="flex gap-x-2">
          <BaseButton @click="cancelRetry">
            انصراف
          </BaseButton>

          <BaseButton
            color="warning"
            variant="solid"
            @click="retryLastMessage"
          >
            <Icon name="ph:arrow-clockwise" class="ml-1 size-4" />
            تولید پاسخ جدید
          </BaseButton>
        </div>
      </div>
    </template>
  </TairoModal>

  <!-- Goals Modal -->
  <TairoModal
    :open="showGoalsModal"
    size="lg"
    @close="showGoalsModal = false"
  >
    <template #header>
      <div class="flex w-full items-center justify-between p-4 md:p-6">
        <h3 class="font-heading text-muted-900 text-lg font-medium leading-6 dark:text-white">
          اهداف درمانی شما
        </h3>
        <BaseButtonClose @click="showGoalsModal = false" />
      </div>
    </template>

    <div class="max-h-[75vh] overflow-y-auto p-4 md:p-6">
      <!-- Goals List -->
      <div v-if="userGoals.length > 0" class="space-y-6">
        <div
          v-for="goal in userGoals"
          :key="goal.id"
          class="dark:bg-muted-800 border-muted-200 dark:border-muted-700 rounded-2xl border bg-white p-6 shadow-sm transition-shadow duration-200 hover:shadow-md"
        >
          <!-- Goal Header -->
          <div class="mb-4 flex items-start justify-between">
            <div class="flex-1">
              <!-- Goal Title with Icon -->
              <div class="mb-3 flex items-center gap-3">
                <div class="bg-primary-100 dark:bg-primary-900/30 flex size-10 shrink-0 items-center justify-center rounded-full">
                  <Icon name="ph:target-duotone" class="text-primary-600 dark:text-primary-400 size-5" />
                </div>
                <h4 class="text-muted-900 text-lg font-semibold leading-tight dark:text-white">
                  {{ goal.title }}
                </h4>
              </div>

              <!-- Status and Priority Badges -->
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                  <span
                    class="dark:border-muted-800 inline-block size-3 rounded-full border-2 border-white"
                    :class="{
                      'bg-emerald-500': goal.status === 'completed',
                      'bg-amber-500': goal.status === 'in_progress',
                      'bg-slate-400': goal.status === 'pending'
                    }"
                  />
                  <span class="text-muted-700 dark:text-muted-300 text-sm font-medium">
                    {{ goal.status === 'completed' ? 'تکمیل شده' :
                      goal.status === 'in_progress' ? 'در حال انجام' : 'در انتظار' }}
                  </span>
                </div>

                <span
                  class="rounded-full border px-3 py-1.5 text-xs font-medium"
                  :class="{
                    'border-red-200 bg-red-50 text-red-700 dark:border-red-800 dark:bg-red-900/20 dark:text-red-300': goal.priority === 'high',
                    'border-amber-200 bg-amber-50 text-amber-700 dark:border-amber-800 dark:bg-amber-900/20 dark:text-amber-300': goal.priority === 'medium',
                    'border-slate-200 bg-slate-50 text-slate-700 dark:border-slate-800 dark:bg-slate-900/20 dark:text-slate-300': goal.priority === 'low'
                  }"
                >
                  {{ goal.priority === 'high' ? 'اولویت بالا' :
                    goal.priority === 'medium' ? 'اولویت متوسط' : 'اولویت پایین' }}
                </span>
              </div>
            </div>

            <!-- Progress Circle -->
            <div v-if="goal.progress_percentage !== undefined" class="ml-4 shrink-0">
              <div class="relative size-16">
                <!-- Background circle -->
                <svg class="size-16 -rotate-90" viewBox="0 0 36 36">
                  <path
                    class="text-muted-200 dark:text-muted-700"
                    stroke="currentColor"
                    stroke-width="3"
                    fill="none"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                  <path
                    class="text-primary-500"
                    stroke="currentColor"
                    stroke-width="3"
                    fill="none"
                    stroke-linecap="round"
                    :stroke-dasharray="`${goal.progress_percentage} 100`"
                    d="M18 2.0845
                      a 15.9155 15.9155 0 0 1 0 31.831
                      a 15.9155 15.9155 0 0 1 0 -31.831"
                  />
                </svg>
                <!-- Progress percentage text -->
                <div class="absolute inset-0 flex items-center justify-center">
                  <span class="text-muted-700 dark:text-muted-300 text-sm font-bold">
                    {{ Math.round(goal.progress_percentage) }}%
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Goal Description -->
          <div v-if="goal.description" class="mb-5">
            <p class="text-muted-600 dark:text-muted-400 bg-muted-50 dark:bg-muted-900/50 border-primary-500 rounded-lg border-r-4 p-4 leading-relaxed">
              {{ goal.description }}
            </p>
          </div>

          <!-- Target Behaviors -->
          <div v-if="goal.target_behaviors && goal.target_behaviors.length > 0" class="mb-5">
            <div class="mb-4 flex items-center gap-2">
              <div class="flex size-6 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                <Icon name="ph:list-checks-duotone" class="size-4 text-blue-600 dark:text-blue-400" />
              </div>
              <h5 class="text-muted-800 dark:text-muted-200 text-sm font-semibold">
                رفتارهای هدف
              </h5>
            </div>
            <div class="rounded-xl border border-blue-100 bg-blue-50 p-4 dark:border-blue-800/30 dark:bg-blue-900/20">
              <ul class="space-y-3">
                <li
                  v-for="behavior in goal.target_behaviors"
                  :key="behavior"
                  class="flex items-start gap-3"
                >
                  <div class="mt-0.5 flex size-5 shrink-0 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-800/50">
                    <Icon name="ph:check" class="size-3 text-blue-600 dark:text-blue-400" />
                  </div>
                  <span class="text-sm leading-relaxed text-blue-800 dark:text-blue-200">{{ behavior }}</span>
                </li>
              </ul>
            </div>
          </div>

          <!-- Success Criteria -->
          <div v-if="goal.success_criteria && goal.success_criteria.length > 0" class="mb-5">
            <div class="mb-4 flex items-center gap-2">
              <div class="flex size-6 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-900/30">
                <Icon name="ph:trophy-duotone" class="size-4 text-emerald-600 dark:text-emerald-400" />
              </div>
              <h5 class="text-muted-800 dark:text-muted-200 text-sm font-semibold">
                معیارهای موفقیت
              </h5>
            </div>
            <div class="rounded-xl border border-emerald-100 bg-emerald-50 p-4 dark:border-emerald-800/30 dark:bg-emerald-900/20">
              <ul class="space-y-3">
                <li
                  v-for="criteria in goal.success_criteria"
                  :key="criteria"
                  class="flex items-start gap-3"
                >
                  <div class="mt-0.5 flex size-5 shrink-0 items-center justify-center rounded-full bg-emerald-100 dark:bg-emerald-800/50">
                    <Icon name="ph:star" class="size-3 text-emerald-600 dark:text-emerald-400" />
                  </div>
                  <span class="text-sm leading-relaxed text-emerald-800 dark:text-emerald-200">{{ criteria }}</span>
                </li>
              </ul>
            </div>
          </div>

          <!-- DSM-5 Criteria (for diagnostic goals) -->
          <div v-if="goal.dsm5_criteria && goal.dsm5_criteria.length > 0" class="mb-5">
            <div class="mb-4 flex items-center gap-2">
              <div class="flex size-6 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/30">
                <Icon name="ph:book-open-duotone" class="size-4 text-purple-600 dark:text-purple-400" />
              </div>
              <h5 class="text-muted-800 dark:text-muted-200 text-sm font-semibold">
                معیارهای DSM-5
              </h5>
            </div>
            <div class="rounded-xl border border-purple-100 bg-purple-50 p-4 dark:border-purple-800/30 dark:bg-purple-900/20">
              <div class="space-y-4">
                <div
                  v-for="disorder in goal.dsm5_criteria"
                  :key="disorder.code"
                  class="border-b border-purple-200 pb-3 last:border-b-0 last:pb-0 dark:border-purple-700"
                >
                  <h6 class="mb-2 font-medium text-purple-800 dark:text-purple-200">
                    {{ disorder.name }} ({{ disorder.code }})
                  </h6>
                  <ul class="space-y-2">
                    <li
                      v-for="criteria in disorder.criteria"
                      :key="criteria"
                      class="flex items-start gap-2 text-sm text-purple-700 dark:text-purple-300"
                    >
                      <span class="mt-1 text-purple-400">•</span>
                      <span>{{ criteria }}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- ICD-11 Criteria (for diagnostic goals) -->
          <div v-if="goal.icd11_criteria && goal.icd11_criteria.length > 0" class="mb-5">
            <div class="mb-4 flex items-center gap-2">
              <div class="flex size-6 items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-900/30">
                <Icon name="ph:hospital-duotone" class="size-4 text-indigo-600 dark:text-indigo-400" />
              </div>
              <h5 class="text-muted-800 dark:text-muted-200 text-sm font-semibold">
                معیارهای ICD-11
              </h5>
            </div>
            <div class="rounded-xl border border-indigo-100 bg-indigo-50 p-4 dark:border-indigo-800/30 dark:bg-indigo-900/20">
              <div class="space-y-4">
                <div
                  v-for="disorder in goal.icd11_criteria"
                  :key="disorder.code"
                  class="border-b border-indigo-200 pb-3 last:border-b-0 last:pb-0 dark:border-indigo-700"
                >
                  <h6 class="mb-2 font-medium text-indigo-800 dark:text-indigo-200">
                    {{ disorder.name }} ({{ disorder.code }})
                  </h6>
                  <ul class="space-y-2">
                    <li
                      v-for="criteria in disorder.criteria"
                      :key="criteria"
                      class="flex items-start gap-2 text-sm text-indigo-700 dark:text-indigo-300"
                    >
                      <span class="mt-1 text-indigo-400">•</span>
                      <span>{{ criteria }}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Plans (for diagnostic goals) -->
          <div v-if="goal.action_plans && goal.action_plans.length > 0">
            <div class="mb-4 flex items-center gap-2">
              <div class="flex size-6 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900/30">
                <Icon name="ph:clipboard-text-duotone" class="size-4 text-orange-600 dark:text-orange-400" />
              </div>
              <h5 class="text-muted-800 dark:text-muted-200 text-sm font-semibold">
                برنامه‌های عملی
              </h5>
            </div>
            <div class="rounded-xl border border-orange-100 bg-orange-50 p-4 dark:border-orange-800/30 dark:bg-orange-900/20">
              <ul class="space-y-3">
                <li
                  v-for="plan in goal.action_plans"
                  :key="plan"
                  class="flex items-start gap-3"
                >
                  <div class="mt-0.5 flex size-5 shrink-0 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-800/50">
                    <Icon name="ph:arrow-right" class="size-3 text-orange-600 dark:text-orange-400" />
                  </div>
                  <span class="text-sm leading-relaxed text-orange-800 dark:text-orange-200">{{ plan }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div v-else class="py-12 text-center">
        <div class="bg-muted-100 dark:bg-muted-800 mx-auto mb-4 flex size-16 items-center justify-center rounded-full">
          <Icon name="ph:target" class="text-muted-400 size-8" />
        </div>
        <h4 class="text-muted-900 mb-2 font-medium dark:text-white">
          هنوز هدفی تعریف نشده
        </h4>
        <p class="text-muted-600 dark:text-muted-400 mb-4 text-sm">
          پس از تکمیل ارزیابی اولیه، اهداف درمانی شما به صورت خودکار تعریف خواهند شد.
        </p>
        <BaseButton
          color="primary"
          size="sm"
          @click="$router.push('/therapy-journey/assessment')"
        >
          شروع ارزیابی
        </BaseButton>
      </div>
    </div>

    <template #footer>
      <div class="p-4 md:p-6">
        <div class="flex justify-end">
          <BaseButton @click="showGoalsModal = false">
            بستن
          </BaseButton>
        </div>
      </div>
    </template>
  </TairoModal>
</template>

<style scoped>
.typing-ellipsis {
  display: inline-block;
  width: 1.5em;
  text-align: right; /* RTL support */
  direction: rtl;
}
.typing-ellipsis::after {
  content: '';
  display: inline-block;
  width: 1.5em;
  vertical-align: bottom;
  animation: ellipsis-rtl steps(4,end) 1.2s infinite;
}
@keyframes ellipsis-rtl {
  0% { content: ''; }
  25% { content: '\002E'; }        /* . */
  50% { content: '\002E\002E'; }  /* .. */
  75% { content: '\002E\002E\002E'; } /* ... */
  100% { content: ''; }
}

</style>
<style scoped>
#no-money-message {
  justify-content: space-evenly;
}
.hide-scrollbar::-webkit-scrollbar { display: none; }
.hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
